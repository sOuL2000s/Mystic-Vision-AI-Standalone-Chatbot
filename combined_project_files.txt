
--- START FILE: index.html ---

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mystic Vision AI Chat</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN for utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js CDN for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Lucide Icons for a modern, futuristic feel -->
    <script src="https://cdn.jsdelivr.net/npm/lucide-dynamic@latest/dist/lucide.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <style>
        /* General Styles - Mystic Vision Theme */
        :root {
            /* Dark Mode Palette (Default) */
            --primary-bg: #0C0C2F; /* Very dark blue-purple */
            --secondary-bg: #1B1B4A; /* Darker purple-blue - container background */
            --tertiary-bg: #2B2B60; /* Medium dark purple-blue - header/input area/button base */
            --text-color: #E0E0E0; /* Light grey text */
            --accent-color: #C070FF; /* Vibrant mystical purple */
            --border-color: #2B2B60;
            --user-bubble: #3A3A75; /* Deeper purple for user */
            --ai-bubble: #1F1F50; /* Slightly different dark purple for AI */
            --input-bg: #0C0C2F;
            --button-hover-bg: #A040FF; /* Slightly darker accent for hover */
            --shadow-color: rgba(0, 0, 0, 0.5); /* Stronger shadow */
            --code-bg: #0F0F3D; /* Code block background */
            --code-text: #f8f8f2; /* Code text color */
            --code-border: #2B2B60; /* Code border */
            --code-header-bg: #2B2B60; /* Code header background */
            --code-header-border: #3A3A75; /* Code header border */
            --inline-code-bg: rgba(192, 112, 255, 0.2); /* Inline code background */
            --inline-code-color: var(--accent-color); /* Inline code color */
            --message-action-bg: rgba(19, 19, 26, 0.6); /* Message action background */
            --message-action-user-bg: rgba(58, 58, 117, 0.6); /* Message action background for user messages */
            --message-action-icon: #9ca3af; /* Message action icon color */
            --message-action-icon-hover: var(--text-color); /* Message action icon hover color */

            /* Common Accent Colors (for alerts/status) */         
            --accent-error: #ef4444; /* Red for errors */         
            --accent-success: #22c55e; /* Green for success */          

            /* Font Families */         
            --font-family-primary: 'Poppins', sans-serif;         
            --font-family-secondary: 'Montserrat', sans-serif;          

            /* Autocomplete */
            --autocomplete-bg: var(--secondary-bg);
            --autocomplete-border: var(--border-color);
            --autocomplete-text: var(--text-color);
            --autocomplete-hover-bg: var(--tertiary-bg);
            --autocomplete-selected-bg: var(--accent-color);
            --autocomplete-selected-text: white;
        }

        /* Light Mode Palette (Overrides default variables when body has 'light' class) */
        body.light {
            --primary-bg: #F8F4FF; /* Very pale lavender-white for main background */
            --secondary-bg: #FFFFFF; /* Pure white for container/card background */
            --tertiary-bg: #EAE6FF; /* Pale light purple for header/input area/button base */
            --text-color: #1A0033; /* Very dark purple/black for main text */
            --accent-color: #8C2BFF; /* Slightly richer/darker purple for light mode accent */
            --border-color: #D8D0E0; /* Soft light purple border */
            --user-bubble: #D8E2FF; /* Light blue-purple, user bubble */
            --ai-bubble: #F0E8FF; /* Even paler lavender, AI bubble */
            --input-bg: #F8F8F8; /* Slightly off-white for input field */
            --button-hover-bg: #B050FF; /* Slightly darker accent for hover in light mode */
            --shadow-color: rgba(0, 0, 0, 0.15); /* Lighter shadow */
            --code-bg: #F0F0F5; /* Lighter background for code in light mode */
            --code-text: #333; /* Code text color */
            --code-border: #E0E0E5; /* Code border */
            --code-header-bg: #E0E0E5; /* Code header background */
            --code-header-border: #D0D0D5; /* Code header border */
            --inline-code-bg: rgba(130, 0, 200, 0.1); /* Inline code background (LM accent with transparency) */
            --inline-code-color: var(--accent-color); /* Inline code color */
            --message-action-bg: rgba(255, 255, 255, 0.7); /* Message action background */
            --message-action-user-bg: rgba(220, 230, 255, 0.7); /* Message action background for user messages */
            --message-action-icon: #666; /* Message action icon color */
            --message-action-icon-hover: var(--text-color); /* Message action icon hover color */

            /* Autocomplete */
            --autocomplete-bg: var(--secondary-bg);
            --autocomplete-border: var(--border-color);
            --autocomplete-text: var(--text-color);
            --autocomplete-hover-bg: var(--tertiary-bg);
            --autocomplete-selected-bg: var(--accent-color);
            --autocomplete-selected-text: white;
        }

        /* Base Body Styles */
        body {
            font-family: var(--font-family-primary);
            background: linear-gradient(135deg, var(--primary-bg), var(--secondary-bg));
            color: var(--text-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background 0.6s ease, color 0.6s ease; /* Smooth transition for background gradient */
        }

        /* Chatbot Container (Main Application) */
        .chatbot-container {
            background-color: var(--secondary-bg);
            border-radius: 25px;
            box-shadow: 0 15px 30px var(--shadow-color);
            width: 90%;
            max-width: 700px; 
            height: 90vh; 
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 2px solid var(--border-color);
            animation: fadeIn 0.8s ease-out;
            position: relative; 
            transition: background-color 0.6s ease, border-color 0.6s ease, box-shadow 0.6s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Header */
        .chatbot-header {
            background-color: var(--tertiary-bg);
            padding: 20px;
            border-bottom: 2px solid var(--border-color);
            text-align: center;
            border-top-left-radius: 23px;
            border-top-right-radius: 23px;
            position: relative;
            overflow: hidden;
            z-index: 10; 
            transition: background-color 0.6s ease, border-color 0.6s ease;
            display: flex; /* Added for alignment of items */
            align-items: center; /* Center items vertically */
            justify-content: center; /* Center items horizontally initially */
            flex-shrink: 0; /* Prevents header from shrinking */
        }
        
        .chatbot-header .header-content {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .chatbot-header h1 {
            margin: 0;
            font-size: 2em; 
            color: var(--accent-color);
            font-family: var(--font-family-secondary);
            font-weight: 600;
            letter-spacing: 1px;
            text-shadow: 0 0 10px rgba(192, 112, 255, 0.6);
            transition: color 0.6s ease, text-shadow 0.6s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chatbot-header .logo {
            height: 2.5em; /* Adjust size as needed */
            width: auto;
            object-fit: contain;
            filter: drop-shadow(0 0 5px rgba(192, 112, 255, 0.5));
            transition: filter 0.6s ease;
        }


        .chatbot-header .tagline {
            font-family: var(--font-family-secondary);
            font-size: 0.9em;
            color: var(--text-color);
            opacity: 0.7;
            margin: 0;
            font-style: italic;
            transition: color 0.6s ease;
        }

        .chatbot-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, rgba(192, 112, 255, 0.15) 0%, transparent 70%);
            transform: rotate(45deg);
            animation: headerGlow 8s infinite alternate ease-in-out;
            z-index: 1;
            transition: background 0.6s ease;
        }

        @keyframes headerGlow {
            0% { transform: scale(0.8) rotate(0deg); opacity: 0.6; }
            50% { transform: scale(1.1) rotate(180deg); opacity: 0.8; }
            100% { transform: scale(0.8) rotate(360deg); opacity: 0.6; }
        }

        /* Dark Mode Toggle Switch */
        .dark-mode-container {
            position: absolute;
            top: 20px;
            right: 20px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 3;
            font-family: var(--font-family-primary);
        }
        .dark-mode-container span {
            color: var(--text-color); 
            transition: color 0.6s ease;
        }

        .switch { 
            position: relative;
            display: inline-block;
            width: 56px; 
            height: 30px; 
            border-radius: 15px;
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);
            border: 1px solid rgba(255,255,255,0.1); 
            transition: background-color 0.6s ease, border-color 0.6s ease;
        }
        .switch input { 
            opacity: 0;
            width: 0;
            height: 0;
        }
        .slider { 
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #4b5563; 
            border-radius: 15px; 
            transition: .4s;
        }
        .slider:before {
            position: absolute;
            content: "";
            height: 22px; 
            width: 22px; 
            left: 4px;
            bottom: 4px;
            background-color: white; 
            border-radius: 50%;
            transition: .4s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        input:checked + .slider {
            background-color: var(--accent-color); 
        }
        input:checked + .slider:before {
            transform: translateX(26px); 
        }

        /* New Chat Button */
        #newChatBtn {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: var(--accent-color);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85em;
            font-family: var(--font-family-primary);
            font-weight: 600;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease, transform 0.2s ease;
            z-index: 3;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        #newChatBtn:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-1px);
        }
        #newChatBtn:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        #newChatBtn .lucide {
            width: 1em;
            height: 1em;
        }

        /* Chat History */
        .chat-history {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
        }

        .chat-history::-webkit-scrollbar {
            width: 8px;
        }

        .chat-history::-webkit-scrollbar-track {
            background: var(--primary-bg); 
            border-radius: 10px;
            transition: background 0.6s ease;
        }

        .chat-history::-webkit-scrollbar-thumb {
            background-color: var(--accent-color); 
            border-radius: 10px;
            border: 2px solid var(--primary-bg); 
            transition: background-color 0.6s ease, border-color 0.6s ease;
        }

        /* Message Bubbles */
        .chat-message {
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 20px;
            line-height: 1.5;
            word-wrap: break-word;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            animation: slideIn 0.3s ease-out;
            position: relative; 
            padding-bottom: 2.5rem; 
            font-size: 0.95rem; 
            transition: background-color 0.6s ease, color 0.6s ease, background-image 0.6s ease, box-shadow 0.6s ease;
        }

        @keyframes slideIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .chat-message.user {
            background-color: var(--user-bubble);
            color: var(--text-color);
            margin-left: auto; /* Pushes user message to the right */
            border-bottom-right-radius: 5px; 
            background-image: linear-gradient(to bottom right, var(--user-bubble), color-mix(in srgb, var(--user-bubble) 80%, black 20%)); /* Dynamic darker shade */
        }

        .chat-message.ai {
            background-color: var(--ai-bubble);
            color: var(--text-color);
            margin-right: auto; /* Pushes AI message to the left */
            border-bottom-left-radius: 5px; 
            background-image: linear-gradient(to bottom left, var(--ai-bubble), color-mix(in srgb, var(--ai-bubble) 80%, black 20%)); /* Dynamic darker shade */
        }

        /* Markdown Styling within AI messages */
        .chat-message .message-content {
            padding: 0; 
            margin: 0;
        }
        .chat-message.ai .message-content p,
        .chat-message.ai .message-content ul,
        .chat-message.ai .message-content ol,
        .chat-message.ai .message-content h1,
        .chat-message.ai .message-content h2,
        .chat-message.ai .message-content h3,
        .chat-message.ai .message-content blockquote {
            margin-bottom: 1em;
            transition: color 0.6s ease; /* For changing heading colors */
        }
        .chat-message.ai .message-content h1,
        .chat-message.ai .message-content h2,
        .chat-message.ai .message-content h3 {
            color: var(--accent-color); /* Headings use accent color */
        }

        .chat-message.ai .message-content p:last-child,
        .chat-message.ai .message-content ul:last-child,
        .chat-message.ai .message-content ol:last-child,
        .chat-message.ai .message-content blockquote:last-child {
            margin-bottom: 0;
        }
        .chat-message.ai .message-content ul,
        .chat-message.ai .message-content ol {
            padding-left: 1.5em; 
        }
        .chat-message.ai .message-content li {
            margin-bottom: 0.5em;
        }
        .chat-message.ai .message-content strong {
            font-weight: bold;
            color: var(--accent-color); 
            transition: color 0.6s ease;
        }
        .chat-message.ai .message-content em {
            font-style: italic;
        }
        .chat-message.ai .message-content blockquote {
            border-left: 4px solid var(--accent-color); /* Blockquotes use accent color */
            color: var(--text-color); /* Main text color for readability */
            padding-left: 1em;
            margin-left: 0;
            transition: border-color 0.6s ease, color 0.6s ease;
        }

        /* Code block specific styling */
        .code-block-container {
            background-color: var(--code-bg); 
            color: var(--code-text); 
            border-radius: 0.75rem; 
            margin-top: 1rem;
            margin-bottom: 1rem;
            overflow: hidden; 
            border: 1px solid var(--code-border); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: background-color 0.6s ease, color 0.6s ease, border-color 0.6s ease;
        }
        .code-block-container pre {
            margin: 0; 
            padding: 1rem;
            overflow-x: auto; 
            font-family: 'Consolas', 'Fira Code', 'Cascadia Code', monospace; 
            font-size: 0.9em;
            line-height: 1.4;
        }
        .code-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--code-header-bg); 
            color: var(--text-color); 
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--code-header-border);
            font-size: 0.85em;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
            transition: background-color 0.6s ease, color 0.6s ease, border-color 0.6s ease;
        }
        .code-block-copy-button {
            background-color: transparent;
            border: none;
            color: var(--text-color); /* Code header text color */
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease, color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.85em;
        }
        .code-block-copy-button:hover {
            background-color: color-mix(in srgb, var(--code-header-bg) 80%, white 20%); /* Lighter hover based on header */
            color: var(--text-color); 
        }
        /* Inline code */
        .chat-message.ai .message-content code:not(pre > code) {
            background-color: var(--inline-code-bg); 
            border-radius: 0.25rem;
            padding: 0.2em 0.4em;
            font-family: 'Consolas', monospace;
            font-size: 0.9em;
            color: var(--inline-code-color); 
            transition: background-color 0.6s ease, color 0.6s ease;
        }
        /* Links */
        .chat-message.ai .message-content a {
            color: var(--accent-color);
            text-decoration: underline;
            transition: color 0.6s ease;
        }
        .chat-message.ai .message-content a:hover {
            color: var(--button-hover-bg); 
        }

        /* Message Action Buttons (Copy/Dictate) */
        .message-actions {
            position: absolute;
            bottom: 0.5rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.75rem;
            backdrop-filter: blur(5px);
            transition: opacity 0.3s ease;
            opacity: 0; 
            z-index: 10;
            background-color: var(--message-action-bg);
        }
        .chat-message:hover .message-actions {
            opacity: 1; 
        }
        .message-actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease, color 0.2s ease;
            display: flex; 
            align-items: center;
            justify-content: center;
        }
        .message-actions button .lucide { 
            color: var(--message-action-icon); 
            width: 1rem;
            height: 1rem;
            transition: color 0.6s ease;
        }
        .message-actions button:hover .lucide {
            color: var(--message-action-icon-hover); 
        }
        .message-actions button:hover {
            background-color: rgba(255, 255, 255, 0.1); 
        }
        .chat-message.user .message-actions {
            background-color: var(--message-action-user-bg);
        }
        /* Specific attachment preview styling within messages (not the input area ones) */
        .chat-message-attachment-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 1rem;
            background-color: var(--tertiary-bg); 
            color: var(--text-color); 
            font-size: 0.875rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transition: background-color 0.6s ease, color 0.6s ease, box-shadow 0.6s ease;
        }

        /* Input Area */
        .chat-input {
            padding: 20px;
            border-top: 2px solid var(--border-color);
            display: flex;
            gap: 10px; 
            align-items: end; 
            background-color: var(--tertiary-bg);
            border-bottom-left-radius: 23px;
            border-bottom-right-radius: 23px;
            position: relative; 
            transition: background-color 0.6s ease, border-color 0.6s ease;
            flex-shrink: 0; /* Prevents input from shrinking */
        }

        .chat-input textarea {
            flex-grow: 1;
            padding: 10px 15px; 
            border: 1px solid var(--border-color);
            border-radius: 25px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-family: var(--font-family-primary);
            font-size: 1em;
            resize: none;
            outline: none;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
            transition: border-color 0.3s ease, background-color 0.3s ease, color 0.6s ease;
            min-height: 40px; 
            height: auto; 
            overflow-y: hidden; 
        }

        .chat-input textarea:focus {
            border-color: var(--accent-color);
            background-color: color-mix(in srgb, var(--primary-bg) 90%, var(--tertiary-bg) 10%); /* Slightly lighter than primary bg */
        }

        /* Action buttons in input area (Send, Mic, Paperclip) */
        .chat-input .icon-button { 
            background-color: var(--tertiary-bg); 
            color: var(--text-color);
            border: none;
            border-radius: 50%; 
            width: 48px; 
            height: 48px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, color 0.6s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
            display: flex; 
            align-items: center;
            justify-content: center;
            flex-shrink: 0; 
        }

        .chat-input .icon-button:hover {
            background-color: var(--secondary-bg); 
            transform: translateY(-1px);
        }
        .chat-input .icon-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .chat-input .icon-button .lucide {
            width: 1.25em; 
            height: 1.25em;
        }

        #sendButton {
            background-color: var(--accent-color); 
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3); 
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease;
        }
        #sendButton:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-2px);
        }
        #sendButton:active {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }

        /* Loading Indicator */
        .loader-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }
        .loader-dot {
            width: 12px;
            height: 12px;
            margin: 0 4px;
            background-color: var(--accent-color);
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
            transition: background-color 0.6s ease;
        }
        .loader-dot:nth-child(1) { animation-delay: -0.32s; }
        .loader-dot:nth-child(2) { animation-delay: -0.16s; }
        .loader-dot:nth-child(3) { animation-delay: 0s; }
        
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1.0);
                opacity: 1;
            }
        }
        /* Voice input active state */
        .voice-input-active {
            background-color: var(--accent-error) !important; 
            animation: pulse-red 1s infinite cubic-bezier(0.4, 0, 0.6, 1);
        }
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }

        /* Attachment Preview (in input area) */
        .chat-image {
            max-width: 100%;
            height: auto;
            border-radius: 0.75rem;
            margin-top: 0.5rem;
            display: block;
        }
        .chat-attachment-preview-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 1rem;
            background-color: var(--tertiary-bg); 
            color: var(--text-color); 
            font-size: 0.875rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transition: background-color 0.6s ease, color 0.6s ease, box-shadow 0.6s ease;
        }
        .chat-attachment-preview-item .remove-attachment-btn {
            background: none;
            border: none;
            color: var(--accent-color); 
            cursor: pointer;
            padding: 0.1rem;
            border-radius: 50%;
            transition: background-color 0.2s ease, color 0.6s ease;
        }
        .chat-attachment-preview-item .remove-attachment-btn:hover {
            background-color: rgba(192, 112, 255, 0.2);
        }

        /* Drag and Drop visual feedback for chat window */
        .chatbot-container.drag-over-active {
            border: 2px dashed var(--accent-color);
            box-shadow: 0 0 20px var(--accent-color), 0 0 30px var(--accent-color) inset;
            transition: border-color 0.6s ease, box-shadow 0.6s ease;
        }

        /* Copy Message Toast */
        #copy-message {
            position: fixed;
            bottom: 3rem; 
            left: 50%;
            transform: translateX(-50%);
            padding: 0.75rem 1.5rem;
            background-color: var(--accent-success);
            color: white;
            border-radius: 9999px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease-in-out;
            z-index: 100;
        }

        #copy-message.show {
            opacity: 1;
            visibility: visible;
        }

        /* Autocomplete Suggestions */
        #suggestions-container {
            position: absolute;
            bottom: 100%; /* Position above the input field */
            left: 0;
            right: 0;
            margin-bottom: 10px; /* Space between input and suggestions */
            background-color: var(--autocomplete-bg);
            border: 1px solid var(--autocomplete-border);
            border-radius: 10px;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.2);
            max-height: 200px;
            overflow-y: auto;
            z-index: 20; /* Ensure it's above other input elements */
            transition: background-color 0.6s ease, border-color 0.6s ease, box-shadow 0.6s ease;
        }
        #suggestions-container ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #suggestions-container li {
            padding: 10px 15px;
            cursor: pointer;
            color: var(--autocomplete-text);
            transition: background-color 0.2s ease, color 0.6s ease;
        }
        #suggestions-container li:hover,
        #suggestions-container li.selected {
            background-color: var(--autocomplete-hover-bg);
        }
        #suggestions-container li.selected {
            background-color: var(--autocomplete-selected-bg);
            color: var(--autocomplete-selected-text);
        }


        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .chatbot-container {
                width: 95%;
                height: 95vh;
                border-radius: 15px;
            }

            .chatbot-header {
                padding: 15px;
                border-top-left-radius: 13px;
                border-top-right-radius: 13px;
                flex-direction: column;
                padding-bottom: 10px; /* Adjust padding for smaller screens */
            }
            .chatbot-header h1 {
                font-size: 1.8em;
            }
            .chatbot-header .logo {
                height: 2em;
            }
            .chatbot-header .tagline {
                font-size: 0.8em;
            }
            .dark-mode-container {
                top: 10px;
                right: 10px;
                gap: 5px;
            }
            .dark-mode-container span {
                font-size: 0.7em;
            }
            .switch {
                width: 44px;
                height: 24px;
                border-radius: 12px;
            }
            .switch .slider:before {
                height: 18px;
                width: 18px;
                left: 3px;
                bottom: 3px;
            }
            input:checked + .slider:before {
                transform: translateX(20px);
            }

            #newChatBtn {
                top: 10px;
                left: 10px;
                padding: 6px 12px;
                font-size: 0.75em;
            }
            #newChatBtn .lucide {
                width: 0.8em;
                height: 0.8em;
            }


            .chat-history {
                padding: 15px;
                gap: 10px;
            }

            .chat-message {
                max-width: 90%;
                padding: 10px 15px;
                border-radius: 18px;
                padding-bottom: 2rem; 
                font-size: 0.9rem;
            }

            .message-actions {
                bottom: 0.3rem; 
                right: 0.8rem;
                gap: 0.3rem;
                padding: 0.2rem 0.4rem;
                border-radius: 0.6rem;
            }
            .message-actions button {
                padding: 0.1rem;
            }
            .message-actions button .lucide {
                width: 0.9rem;
                height: 0.9rem;
            }

            .chat-input {
                padding: 10px;
                gap: 8px;
                align-items: center; 
                border-bottom-left-radius: 13px;
                border-bottom-right-radius: 13px;
            }

            .chat-input textarea {
                padding: 8px 12px; 
                font-size: 0.9em;
                min-height: 36px; 
            }

            .chat-input .icon-button {
                width: 40px; 
                height: 40px;
            }
            .chat-input .icon-button .lucide {
                width: 1.1em; 
                height: 1.1em;
            }

            .chat-attachment-preview-item {
                font-size: 0.8em;
                padding: 0.4rem 0.6rem;
                border-radius: 0.8rem;
            }
            .chat-attachment-preview-item .remove-attachment-btn .lucide {
                width: 0.8rem;
                height: 0.8rem;
            }

            #copy-message {
                bottom: 2rem;
                padding: 0.6rem 1.2rem;
                font-size: 0.9rem;
            }

            #suggestions-container {
                margin-bottom: 8px;
            }
            #suggestions-container li {
                padding: 8px 12px;
                font-size: 0.85em;
            }
        }
    </style>
</head>
<body class="antialiased dark">
    <div class="chatbot-container">
        <header class="chatbot-header">
            <button id="newChatBtn" title="Start a New Chat">
                <span data-lucide="sparkles" class="w-4 h-4"></span>
                New Chat
            </button>
            <div class="dark-mode-container">
                <span>Light</span>
                <label class="switch">
                    <input type="checkbox" id="dark-mode-toggle">
                    <span class="slider"></span>
                </label>
                <span>Dark</span>
            </div>
            <div class="header-content">
                <h1>
                    <img src="logo.png" alt="Mystic Vision AI Logo" class="logo">
                    Mystic Vision AI
                </h1>
                <p class="tagline">Experience the beyond</p>
            </div>
        </header>
        <div class="chat-history" id="chatHistory">
            <!-- Initial AI message will be added by JS -->
        </div>
        <div class="chat-input" id="chatInputArea">
            <!-- Autocomplete Suggestions Container -->
            <div id="suggestions-container" class="hidden">
                <ul id="suggestions-list"></ul>
            </div>

            <!-- Attachment preview -->
            <div id="chat-attachments-preview-container" class="mb-2 flex flex-wrap items-center gap-2 hidden absolute top-0 left-0 right-0 p-4 transform -translate-y-full">
                <!-- Attachments previews will be dynamically added here -->
            </div>

            <!-- Voice Input Button -->
            <button id="voice-input-btn" class="icon-button" aria-label="Voice Input">
                <span data-lucide="mic" class="w-5 h-5"></span>
            </button>

            <!-- Attach File Button (uses a label to link to the hidden file input) -->
            <label for="chat-image-upload" id="attach-file-btn" class="icon-button cursor-pointer" aria-label="Attach File">
                <span data-lucide="paperclip" class="w-5 h-5"></span>
            </label>
            <input type="file" id="chat-image-upload" accept="image/*, .txt, .pdf, .csv, .json, .xml, .md" class="hidden" multiple>

            <textarea id="userInput" placeholder="Type your message..." rows="1"></textarea>
            
            <!-- Send Button -->
            <button id="sendButton" class="icon-button">
                <span data-lucide="send" class="w-5 h-5"></span>
            </button>
        </div>
    </div>

    <!-- Temporary message for clipboard copy -->
    <div id="copy-message">Text copied to clipboard!</div>

    <script>
        // !! IMPORTANT: REPLACE WITH YOUR ACTUAL GEMINI API KEY !!
        // !! DO NOT USE THIS METHOD IN PRODUCTION. USE A SERVER-SIDE PROXY. !!
        const GEMINI_API_KEY = 'AIzaSyC7twxprKoApUjR4uebBS-12KVyZTkuvrw'; // <--- REPLACE THIS WITH YOUR ACTUAL KEY
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${GEMINI_API_KEY}`;

        // --- DOM Elements ---
        const chatbotContainer = document.querySelector('.chatbot-container');
        const chatHistoryDiv = document.getElementById('chatHistory');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        const copyMessage = document.getElementById('copy-message');
        const newChatBtn = document.getElementById('newChatBtn');

        const chatAttachmentsPreviewContainer = document.getElementById('chat-attachments-preview-container'); 
        const chatImageUpload = document.getElementById('chat-image-upload');
        const voiceInputBtn = document.getElementById('voice-input-btn');

        const suggestionsContainer = document.getElementById('suggestions-container');
        const suggestionsList = document.getElementById('suggestions-list');

        // --- State Variables ---
        let conversationHistory = []; // Will be initialized with the first AI message
        let chatAttachments = []; 
        
        const messageTextCache = new Map(); 

        let currentUtterance = null;
        let isSpeaking = false;

        let SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isVoiceInputActive = false;
        let finalTranscript = ''; 

        let selectedSuggestionIndex = -1;

        // A large list of autocomplete suggestions
        const autocompleteSuggestions = [
            // General/Utility
            "What is the capital of France?",
            "Explain quantum physics simply.",
            "How does a combustion engine work?",
            "Summarize the plot of Hamlet.",
            "What are the benefits of exercise?",
            "Calculate the square root of 144.",
            "Convert 50 miles to kilometers.",
            "Define artificial intelligence.",
            "What is blockchain technology?",
            "Explain the internet.",
            "Tell me about renewable energy.",
            "What are the phases of the moon?",
            "How do volcanoes erupt?",
            "What causes tides?",
            "What is the speed of light?",
            "How does photosynthesis work?",
            "What are the main types of clouds?",
            "Explain the concept of infinity.",
            "What is the difference between AI and machine learning?",
            "How does GPS work?",

            // Creative Writing/Ideas
            "Write a short story about a talking animal.",
            "Compose a poem about the ocean.",
            "Give me five ideas for a fantasy novel.",
            "Write a dialogue between a robot and a human.",
            "Generate a catchy slogan for a coffee shop.",
            "Describe a futuristic city.",
            "Create a character profile for a wizard.",
            "Write a fairy tale with a modern twist.",
            "Brainstorm names for a new tech startup.",
            "Suggest topics for a blog about travel.",
            "Write an exciting opening paragraph for an adventure story.",
            "Compose a haiku about autumn.",
            "Develop a plot for a sci-fi film.",
            "Write a humorous obituary.",
            "Describe a unique alien species.",

            // Programming/Tech Help
            "How to write a 'Hello, World!' program in Python?",
            "Explain asynchronous JavaScript.",
            "What is the best framework for web development?",
            "How to debug a Java application?",
            "Write a SQL query to select all users.",
            "Explain REST APIs.",
            "What is version control?",
            "How do I install Node.js?",
            "Explain recursion in programming.",
            "What are data structures?",
            "How to optimize a website for speed?",
            "Explain object-oriented programming.",
            "Write a simple HTML structure.",
            "What is cloud computing?",
            "How to secure a web application?",

            // Education/Learning
            "How to study effectively for exams?",
            "Tips for learning a new language.",
            "What are good resources for learning history?",
            "How to improve my public speaking skills?",
            "Suggest a good book for beginners in astrophysics.",
            "What are the benefits of lifelong learning?",
            "How to choose a university major?",
            "Explain critical thinking.",
            "What is metacognition?",
            "How to set SMART goals?",

            // Health/Wellness
            "What are the benefits of a balanced diet?",
            "Suggest a simple home workout routine.",
            "How to reduce stress naturally?",
            "What are common symptoms of flu?",
            "Explain the importance of sleep.",
            "Tips for maintaining mental health.",
            "What foods boost immunity?",
            "How to stay hydrated?",
            "What is mindfulness meditation?",
            "How to improve posture?",

            // Food/Cooking
            "Suggest a quick and healthy dinner recipe.",
            "How to bake a perfect chocolate chip cookie?",
            "What are common cooking herbs?",
            "Explain sous-vide cooking.",
            "Recipe for a vegan lasagna.",
            "How to make sourdough bread?",
            "Best way to store fresh produce.",

            // Travel/Culture
            "What are the top 5 tourist attractions in Rome?",
            "Suggest a budget-friendly travel destination.",
            "How to pack efficiently for a trip?",
            "Tell me about Japanese culture.",
            "What are some famous landmarks in India?",
            "Tips for solo travel.",
            "Explain local customs in Thailand.",

            // Self-Improvement/Productivity
            "How to build good habits?",
            "Tips for time management.",
            "How to overcome procrastination?",
            "Suggest ways to boost creativity.",
            "How to practice active listening?",
            "What are methods for conflict resolution?",
            "How to give constructive feedback?",

            // Environment/Sustainability
            "What is climate change?",
            "How to reduce my carbon footprint?",
            "Explain recycling processes.",
            "What is sustainable living?",
            "Tips for conserving water at home.",

            // Philosophical/Existential (keeping some of the original theme)
            "What is the meaning of life?",
            "How can I find inner peace?",
            "What is intuition?",
            "Explain the concept of enlightenment.",
            "What is the purpose of suffering?",
            "How can I connect with my higher self?",
            "What does synchronicity mean?",
            "Tell me about the law of attraction.",
            "How to cultivate compassion?",
            "What is the significance of dreams?",

            // And more... (Extensive additions)
            "Tell me a fun fact.",
            "What's the origin of the phrase 'break a leg'?",
            "Who invented the telephone?",
            "Explain the stock market.",
            "How to manage personal finances?",
            "What are common cybersecurity threats?",
            "Explain the concept of net neutrality.",
            "What is artificial general intelligence?",
            "How does facial recognition work?",
            "Tell me about virtual reality.",
            "What is augmented reality?",
            "Explain ethical AI.",
            "How to start a podcast?",
            "Tips for public speaking.",
            "What is imposter syndrome?",
            "How to build resilience?",
            "Explain the gig economy.",
            "What is CRISPR technology?",
            "How to make compost?",
            "What are the benefits of gardening?",
            "Tell me about Roman history.",
            "Explain the Cold War.",
            "What were the causes of World War II?",
            "Tell me about ancient Egypt.",
            "What is democracy?",
            "Explain socialism.",
            "What are human rights?",
            "How does voting work?",
            "What is diplomacy?",
            "Tell me about different types of governments.",
            "How does inflation affect the economy?",
            "What is GDP?",
            "Explain interest rates.",
            "What is a recession?",
            "How to save for retirement?",
            "What is compound interest?",
            "Tell me about different investment strategies.",
            "How to create a budget?",
            "What is credit score?",
            "Explain mortgages.",
            "What is insurance?",
            "How to write a resume?",
            "Tips for a job interview.",
            "How to negotiate salary?",
            "What are common career paths in tech?",
            "Explain emotional intelligence.",
            "How to build strong relationships?",
            "Tips for effective communication.",
            "How to handle difficult conversations?",
            "What is empathy?",
            "How to resolve conflict in relationships?",
            "Tell me about different personality types.",
            "What is positive psychology?",
            "How to practice self-care?",
            "What are the signs of burnout?",
            "How to improve focus and concentration?",
            "What is the Pomodoro Technique?",
            "Explain the Eisenhower Matrix.",
            "How to prioritize tasks?",
            "Tips for remote work productivity.",
            "What is digital minimalism?",
            "How to manage screen time?",
            "What are the benefits of digital detox?",
            "Explain the concept of 'flow state'.",
            "How to overcome creative blocks?",
            "What are different learning styles?",
            "Tips for active reading.",
            "How to write an essay?",
            "Explain plagiarism.",
            "What is citation?",
            "How to do research effectively?",
            "What are open educational resources?",
            "Explain the peer review process.",
            "What is gamification in education?",
            "How to teach children about money?",
            "Tips for teaching a new skill.",
            "What is the Socratic method?",
            "Explain experiential learning.",
            "How to foster curiosity?",
            "What is problem-based learning?",
            "Tell me about different teaching philosophies.",
            "How to create engaging presentations?",
            "What are Bloom's Taxonomy levels?",
            "Explain formative assessment.",
            "What is summative assessment?",
            "How to provide effective feedback to students?",
            "Tips for classroom management.",
            "What is differentiated instruction?",
            "How to support students with learning disabilities?",
            "Explain inclusive education.",
            "What is homeschooling?",
            "How to choose the right school?",
            "What are extracurricular activities?",
            "Explain project-based learning.",
            "What is inquiry-based learning?",
            "How to promote critical thinking in students?",
            "What are the benefits of collaborative learning?",
            "How to use technology effectively in education?",
            "Explain blended learning.",
            "What is flipped classroom?",
            "How to assess student performance fairly?",
            "Tips for parent-teacher communication.",
            "What is social-emotional learning?",
            "How to build self-esteem in children?",
            "Explain the growth mindset.",
            "How to encourage creativity in children?",
            "What are different parenting styles?",
            "Tips for dealing with teenage rebellion.",
            "How to foster independence in children?",
            "What is positive reinforcement?",
            "Explain attachment theory.",
            "How to handle sibling rivalry?",
            "Tips for raising resilient children.",
            "What is childhood development?",
            "How to support children's emotional well-being?",
            "Explain the concept of play-based learning.",
            "What are the benefits of outdoor play?",
            "How to choose age-appropriate toys?",
            "What is early childhood education?",
            "Tips for preparing children for kindergarten.",
            "How to teach children to read?",
            "Explain phonics.",
            "What is whole language approach?",
            "How to help children with math?",
            "Tips for science experiments at home.",
            "How to introduce art to children?",
            "What is music education for kids?",
            "How to teach children about nature?",
            "Explain environmental education for kids.",
            "What are the benefits of storytelling for children?",
            "How to encourage imagination in children?",
            "Tips for screen time limits for kids.",
            "What are healthy eating habits for children?",
            "How to deal with picky eaters?",
            "Explain food allergies in children.",
            "How to encourage physical activity in children?",
            "What are developmental milestones?",
            "Tips for potty training.",
            "How to handle temper tantrums?",
            "What is positive discipline?",
            "Explain logical consequences.",
            "How to teach empathy to children?",
            "Tips for teaching generosity.",
            "How to foster gratitude in children?",
            "What is emotional regulation for kids?",
            "How to help children cope with big emotions?",
            "Explain resilience in children.",
            "What are coping mechanisms for kids?",
            "How to build a child's confidence?",
            "Tips for managing sibling relationships.",
            "How to prepare for a new baby?",
            "What is postpartum depression?",
            "How to support a partner after childbirth?",
            "Tips for new parents.",
            "What are common newborn challenges?",
            "How to breastfeed successfully?",
            "Explain bottle feeding.",
            "What is safe sleep for infants?",
            "How to manage infant crying?",
            "Tips for baby soothing techniques.",
            "What is colic?",
            "How to introduce solid foods to babies?",
            "Explain baby-led weaning.",
            "What are common baby illnesses?",
            "How to take a baby's temperature?",
            "Tips for infant first aid.",
            "What is toddler development?",
            "How to handle toddler tantrums?",
            "Explain the 'terrible twos'.",
            "How to encourage speech development in toddlers?",
            "Tips for toilet training toddlers.",
            "What are good toddler activities?",
            "How to promote social skills in toddlers?",
            "Explain parallel play.",
            "What is imaginative play?",
            "How to manage bedtime routines for toddlers?",
            "Tips for dealing with toddler sleep regressions.",
            "What are common toddler fears?",
            "How to ease separation anxiety in toddlers?",
            "Explain positive parenting.",
            "What is gentle parenting?",
            "How to set boundaries with toddlers?",
            "Tips for dealing with toddler biting or hitting.",
            "What is preschool development?",
            "How to prepare a child for preschool?",
            "Explain social skills for preschoolers.",
            "What are good preschool activities?",
            "How to teach preschoolers letters and numbers?",
            "Tips for improving fine motor skills in preschoolers.",
            "What are gross motor skills?",
            "How to encourage independent play in preschoolers?",
            "Explain cooperative play.",
            "What is dramatic play?",
            "How to foster problem-solving skills in preschoolers?",
            "Tips for managing preschooler behavior challenges.",
            "What is kindergarten readiness?",
            "How to support children's transition to school?",
            "Explain school-age development.",
            "What are academic skills for school-age children?",
            "How to help with homework?",
            "Tips for building good study habits.",
            "What are common learning challenges in school-age children?",
            "How to support children with ADHD?",
            "Explain dyslexia.",
            "What are autism spectrum disorders?",
            "How to encourage reading in school-age children?",
            "Tips for developing writing skills.",
            "How to make math fun?",
            "What are benefits of extracurricular activities for school-age children?",
            "How to deal with bullying?",
            "Explain peer pressure.",
            "What is healthy self-esteem in school-age children?",
            "How to teach responsibility to school-age children?",
            "Tips for managing screen time for school-age children.",
            "What is adolescent development?",
            "How to communicate with teenagers?",
            "Explain puberty.",
            "What are common teenage challenges?",
            "How to support teenagers' mental health?",
            "Tips for discussing difficult topics with teenagers.",
            "What is identity formation in adolescence?",
            "How to navigate peer relationships in adolescence?",
            "Explain romantic relationships in adolescence.",
            "What are common teenage stressors?",
            "How to build resilience in teenagers?",
            "Tips for college application process.",
            "What is career exploration for teenagers?",
            "How to teach financial literacy to teenagers?",
            "Explain civic engagement for teenagers.",
            "What are global issues teenagers should know?",
            "How to encourage critical thinking in teenagers?",
            "Tips for managing stress as a teenager.",
            "What are healthy coping mechanisms for teenagers?",
            "How to promote self-advocacy in teenagers?",
            "Explain the concept of consent to teenagers.",
            "What is responsible social media use for teenagers?",
            "How to address cyberbullying?",
            "Tips for safe online interactions for teenagers.",
            "What are warning signs of substance abuse in teenagers?",
            "How to talk to teenagers about sex education?",
            "Explain reproductive health for teenagers.",
            "What are sexually transmitted infections (STIs)?",
            "How to teach healthy relationships to teenagers?",
            "Tips for managing emotions in adolescence.",
            "What is emotional regulation in teenagers?",
            "How to help teenagers develop empathy?",
            "Explain moral development in adolescence.",
            "What is character education for teenagers?",
            "How to encourage volunteering in teenagers?",
            "Tips for building leadership skills in teenagers.",
            "What is entrepreneurship for teenagers?",
            "How to foster innovation in teenagers?",
            "Explain design thinking for teenagers.",
            "What are future job skills?",
            "How to prepare teenagers for the future of work?",
            "Tips for developing a growth mindset in teenagers.",
            "What is neuroplasticity?",
            "How to improve memory?",
            "Explain cognitive biases.",
            "What is decision-making theory?",
            "How to improve problem-solving skills?",
            "Tips for creative thinking techniques.",
            "What is lateral thinking?",
            "How to brainstorm effectively?",
            "Explain mind mapping.",
            "What are logical fallacies?",
            "How to analyze arguments?",
            "Tips for persuasive writing.",
            "What is rhetoric?",
            "How to give a compelling presentation?",
            "Explain nonverbal communication.",
            "What is body language?",
            "How to read facial expressions?",
            "Tips for improving listening skills.",
            "What is active listening?",
            "How to build rapport?",
            "Explain emotional intelligence in leadership.",
            "What is servant leadership?",
            "How to motivate a team?",
            "Tips for conflict resolution in the workplace.",
            "What is negotiation strategy?",
            "How to conduct effective meetings?",
            "Explain project management methodologies.",
            "What is Agile development?",
            "How to manage risk in projects?",
            "Tips for effective delegation.",
            "What is time blocking?",
            "How to use productivity tools?",
            "Explain the 'Getting Things Done' (GTD) method.",
            "What is the 80/20 rule?",
            "How to overcome perfectionism?",
            "Tips for dealing with stress at work.",
            "What is work-life balance?",
            "How to prevent burnout?",
            "Explain mindfulness at work.",
            "What is imposter syndrome in the workplace?",
            "How to build a professional network?",
            "Tips for career advancement.",
            "What is personal branding?",
            "How to write a professional email?",
            "Explain business ethics.",
            "What is corporate social responsibility?",
            "How to build a diverse and inclusive workplace?",
            "Tips for managing remote teams.",
            "What is cybersecurity best practices?",
            "How to protect personal data online?",
            "Explain phishing scams.",
            "What is ransomware?",
            "How to create strong passwords?",
            "Tips for secure browsing.",
            "What is two-factor authentication?",
            "How to use a VPN?",
            "Explain data encryption.",
            "What is cloud security?",
            "How to backup data effectively?",
            "Tips for managing digital privacy.",
            "What is GDPR?",
            "Explain CCPA.",
            "How to identify fake news?",
            "Tips for media literacy.",
            "What is critical thinking about news?",
            "How to verify information online?",
            "Explain logical fallacies in arguments.",
            "What is cognitive bias in decision making?",
            "How to overcome confirmation bias?",
            "Tips for effective communication in a crisis.",
            "What is crisis management?",
            "How to prepare for natural disasters?",
            "Explain first aid basics.",
            "What to do in a fire emergency?",
            "How to perform CPR?",
            "Tips for staying safe online.",
            "What is online etiquette?",
            "How to be a good digital citizen?",
            "Explain responsible AI development.",
            "What are the ethical implications of AI?",
            "How to ensure AI fairness?",
            "Tips for developing trustworthy AI.",
            "What is human-centered AI design?",
            "Explain AI explainability (XAI).",
            "What is value alignment in AI?",
            "How to regulate AI?",
            "Tips for AI policy making.",
            "What is AI governance?",
            "How to promote responsible innovation?",
            "Explain technological singularity.",
            "What is transhumanism?",
            "How to live a minimalist lifestyle?",
            "Tips for decluttering your home.",
            "What are the benefits of minimalism?",
            "How to reduce waste?",
            "Explain composting.",
            "What is upcycling?",
            "How to save energy at home?",
            "Tips for sustainable fashion.",
            "What is ethical consumption?",
            "How to support local businesses?",
            "Explain fair trade.",
            "What is conscious consumerism?",
            "How to reduce plastic use?",
            "Tips for growing your own food.",
            "What are organic farming practices?",
            "Explain permaculture.",
            "What is vertical farming?",
            "How to conserve water in gardening?",
            "Tips for attracting pollinators to your garden.",
            "What are native plants?",
            "How to create a rain garden?",
            "Explain ecological footprint.",
            "What is carbon neutrality?",
            "How to offset carbon emissions?",
            "Tips for renewable energy adoption.",
            "What is solar power?",
            "Explain wind energy.",
            "What are geothermal energy benefits?",
            "How to promote sustainable transportation?",
            "Tips for electric vehicle adoption.",
            "What is public transportation?",
            "How to encourage walking and cycling?",
            "Explain urban planning for sustainability.",
            "What is green building?",
            "How to design energy-efficient homes?",
            "Tips for sustainable waste management.",
            "What is zero-waste living?",
            "How to reduce food waste?",
            "Explain circular economy.",
            "What are challenges of sustainable development?",
            "How to achieve the UN Sustainable Development Goals?",
            "Tips for environmental activism.",
            "What is citizen science?",
            "How to get involved in conservation?",
            "Explain biodiversity loss.",
            "What are endangered species?",
            "How to protect wildlife?",
            "Tips for marine conservation.",
            "What is plastic pollution?",
            "How to clean up oceans?",
            "Explain reforestation efforts.",
            "What are benefits of planting trees?",
            "How to restore wetlands?",
            "Tips for protecting freshwater resources.",
            "What is water scarcity?",
            "How to manage water resources sustainably?",
            "Explain desertification.",
            "What are impacts of deforestation?",
            "How to prevent soil erosion?",
            "Tips for sustainable agriculture.",
            "What is agroforestry?",
            "How to promote regenerative farming?",
            "Explain food security.",
            "What are global hunger issues?",
            "How to ensure equitable food access?",
            "Tips for reducing global poverty.",
            "What is microfinance?",
            "How to support economic development?",
            "Explain social justice.",
            "What are human rights abuses?",
            "How to promote peace and conflict resolution?",
            "Tips for humanitarian aid.",
            "What is disaster relief?",
            "How to support refugees?",
            "Explain global health challenges.",
            "What are pandemics?",
            "How to improve public health?",
            "Tips for disease prevention.",
            "What is universal healthcare?",
            "How to address health disparities?",
            "Explain mental health awareness.",
            "What are common mental health conditions?",
            "How to seek mental health support?",
            "Tips for reducing mental health stigma.",
            "What is cognitive behavioral therapy (CBT)?",
            "Explain dialectical behavior therapy (DBT).",
            "What is psychotherapy?",
            "How to find a good therapist?",
            "Tips for managing anxiety.",
            "What are symptoms of depression?",
            "How to cope with grief?",
            "Explain trauma-informed care.",
            "What is PTSD?",
            "How to support someone with a mental illness?",
            "Tips for self-compassion.",
            "What is positive self-talk?",
            "How to build emotional resilience?",
            "Explain the power of forgiveness.",
            "What is gratitude journaling?",
            "How to practice daily affirmations?",
            "Tips for building a meditation habit.",
            "What are different types of meditation?",
            "How to start a yoga practice?",
            "Explain the benefits of stretching.",
            "What is strength training?",
            "How to improve cardiovascular health?",
            "Tips for a healthy diet.",
            "What are macronutrients?",
            "Explain micronutrients.",
            "What is intermittent fasting?",
            "How to meal prep effectively?",
            "Tips for weight management.",
            "What are signs of healthy eating?",
            "How to overcome emotional eating?",
            "Explain intuitive eating.",
            "What are common food myths?",
            "How to read nutrition labels?",
            "Tips for cooking healthy meals.",
            "What is food safety?",
            "How to prevent foodborne illnesses?",
            "Explain organic vs. conventional food.",
            "What are genetically modified organisms (GMOs)?",
            "How to reduce sugar intake?",
            "Tips for reducing processed foods.",
            "What are healthy snack ideas?",
            "How to stay motivated to exercise?",
            "Explain the benefits of walking.",
            "What is high-intensity interval training (HIIT)?",
            "How to build muscle?",
            "Tips for improving flexibility.",
            "What is functional fitness?",
            "How to prevent sports injuries?",
            "Explain warm-up and cool-down exercises.",
            "What is foam rolling?",
            "How to relieve muscle soreness?",
            "Tips for managing chronic pain.",
            "What are benefits of massage therapy?",
            "Explain acupuncture.",
            "What is chiropractic care?",
            "How to improve sleep hygiene?",
            "Tips for overcoming insomnia.",
            "What are different sleep stages?",
            "How to deal with jet lag?",
            "Explain sleep apnea.",
            "What are benefits of napping?",
            "How to manage shift work sleep disorder?",
            "Tips for creating a relaxing bedtime routine.",
            "What are natural sleep aids?",
            "How to reduce screen time before bed?",
            "Explain the impact of caffeine on sleep.",
            "What are benefits of sunlight exposure?",
            "How to boost vitamin D levels?",
            "Tips for eye health.",
            "What are signs of digital eye strain?",
            "How to protect hearing?",
            "Explain tinnitus.",
            "What are common skin conditions?",
            "How to maintain healthy skin?",
            "Tips for sun protection.",
            "What are signs of skin cancer?",
            "How to manage acne?",
            "Explain eczema.",
            "What is psoriasis?",
            "How to care for hair?",
            "Tips for nail health.",
            "What are signs of dehydration?",
            "How to stay hydrated effectively?",
            "Explain electrolytes.",
            "What are benefits of drinking water?",
            "How to track water intake?",
            "Tips for incorporating more fruits and vegetables.",
            "What are benefits of fiber?",
            "Explain probiotics.",
            "What are prebiotics?",
            "How to improve gut health?",
            "Tips for managing digestive issues.",
            "What is IBS?",
            "Explain Crohn's disease.",
            "What is ulcerative colitis?",
            "How to manage acid reflux?",
            "Tips for a healthy colon.",
            "What are benefits of meditation for digestion?",
            "How to reduce inflammation through diet?",
            "Explain autoimmune diseases.",
            "What is chronic fatigue syndrome?",
            "How to manage fibromyalgia?",
            "Tips for living with diabetes.",
            "What are symptoms of high blood sugar?",
            "How to manage blood pressure?",
            "Explain cholesterol levels.",
            "What are signs of heart attack?",
            "How to prevent stroke?",
            "Tips for bone health.",
            "What is osteoporosis?",
            "How to maintain joint health?",
            "Explain arthritis.",
            "What are benefits of Omega-3 fatty acids?",
            "How to boost brain health?",
            "Tips for preventing cognitive decline.",
            "What are signs of dementia?",
            "How to support brain aging?",
            "Explain neurodegenerative diseases.",
            "What is Parkinson's disease?",
            "How to manage Alzheimer's disease?",
            "Tips for improving memory and focus.",
            "What are brain training exercises?",
            "How to learn new skills to boost brain health?",
            "Explain the benefits of reading for the brain.",
            "What is neurodiversity?",
            "How to support neurodivergent individuals?",
            "Tips for understanding autism spectrum.",
            "What is ADHD management?",
            "How to help someone with dyslexia?",
            "Explain the concept of neurotypical.",
            "What are sensory processing issues?",
            "How to create sensory-friendly environments?",
            "Tips for effective communication with neurodivergent people.",
            "What is social communication disorder?",
            "How to foster inclusivity for all abilities?",
            "Explain universal design.",
            "What are assistive technologies?",
            "How to advocate for disability rights?",
            "Tips for being an ally to marginalized groups.",
            "What is intersectionality?",
            "How to understand privilege?",
            "Explain systemic racism.",
            "What is unconscious bias?",
            "How to challenge discrimination?",
            "Tips for promoting equality.",
            "What is diversity and inclusion (D&I)?",
            "How to build an equitable society?",
            "Explain the role of education in social change.",
            "What are civil rights movements?",
            "How to engage in peaceful protests?",
            "Tips for community organizing.",
            "What is grassroots activism?",
            "How to create social impact?",
            "Explain philanthropy.",
            "What are non-profit organizations?",
            "How to volunteer effectively?",
            "Tips for ethical consumerism.",
            "What is impact investing?",
            "How to support fair trade initiatives?",
            "Explain corporate social responsibility.",
            "What are sustainable business practices?",
            "How to measure social impact?",
            "Tips for ethical leadership.",
            "What is servant leadership?",
            "How to build a purpose-driven organization?",
            "Explain stakeholder capitalism.",
            "What are B Corps?",
            "How to balance profit and purpose?",
            "Tips for social entrepreneurship.",
            "What is disruptive innovation?",
            "How to foster creativity in business?",
            "Explain design thinking for problem-solving.",
            "What are lean startup principles?",
            "How to conduct market research?",
            "Tips for developing a business plan.",
            "What is intellectual property?",
            "How to protect your brand?",
            "Explain trademark and copyright.",
            "What are patents?",
            "How to raise capital for a startup?",
            "Tips for pitching to investors.",
            "What is venture capital?",
            "Explain angel investors.",
            "What are crowdfunding platforms?",
            "How to manage business finances?",
            "Tips for financial forecasting.",
            "What is break-even analysis?",
            "How to optimize cash flow?",
            "Explain profit and loss statements.",
            "What is a balance sheet?",
            "How to interpret financial ratios?",
            "Tips for effective budgeting.",
            "What is risk management in business?",
            "How to create a crisis management plan?",
            "Explain business continuity planning.",
            "What are cybersecurity risks for businesses?",
            "How to protect business data?",
            "Tips for data privacy compliance.",
            "What is GDPR for businesses?",
            "How to build a strong company culture?",
            "Explain employee engagement.",
            "What are performance management strategies?",
            "How to provide constructive feedback to employees?",
            "Tips for conflict resolution in teams.",
            "What is diversity and inclusion in HR?",
            "How to recruit top talent?",
            "Explain onboarding processes.",
            "What are employee benefits?",
            "How to manage employee compensation?",
            "Tips for leadership development.",
            "What is succession planning?",
            "How to foster innovation in the workplace?",
            "Explain change management.",
            "What is organizational development?",
            "How to build a learning organization?",
            "Tips for continuous improvement.",
            "What is Six Sigma?",
            "Explain Lean methodology.",
            "What is Total Quality Management (TQM)?",
            "How to conduct a SWOT analysis?",
            "Tips for strategic planning.",
            "What is competitive analysis?",
            "How to identify market trends?",
            "Explain customer relationship management (CRM).",
            "What are sales strategies?",
            "How to develop a marketing plan?",
            "Tips for digital marketing.",
            "What is content marketing?",
            "Explain SEO best practices.",
            "What is social media marketing?",
            "How to run effective ad campaigns?",
            "Tips for email marketing.",
            "What is influencer marketing?",
            "How to measure marketing ROI?",
            "Explain brand building.",
            "What is brand identity?",
            "How to create a strong brand message?",
            "Tips for public relations.",
            "What is crisis communication?",
            "How to manage a brand's reputation?",
            "Explain customer service excellence.",
            "What are key performance indicators (KPIs)?",
            "How to use data analytics in business?",
            "Tips for business intelligence.",
            "What is big data?",
            "Explain cloud computing for business.",
            "What are enterprise resource planning (ERP) systems?",
            "How to use AI in business operations?",
            "Tips for automation in business.",
            "What is robotic process automation (RPA)?",
            "How to implement machine learning in business?",
            "Explain the Internet of Things (IoT) in industry.",
            "What is Industry 4.0?",
            "How to leverage augmented reality in business?",
            "Tips for virtual reality applications in enterprise.",
            "What is quantum computing?",
            "Explain the future of work.",
            "What are trends in remote work?",
            "How to design hybrid work models?",
            "Tips for fostering collaboration in distributed teams.",
            "What is employee well-being in the workplace?",
            "How to support mental health at work?",
            "Explain stress management for employees.",
            "What is resilience in the workplace?",
            "How to promote a positive work environment?",
            "Tips for building psychological safety at work.",
            "What is inclusive leadership?",
            "How to address unconscious bias in hiring?",
            "Explain diversity recruitment strategies.",
            "What is equity in the workplace?",
            "How to create belonging at work?",
            "Tips for culturally competent leadership.",
            "What is global citizenship?",
            "How to understand different cultures?",
            "Explain cross-cultural communication.",
            "What are global etiquette rules?",
            "How to manage international teams?",
            "Tips for working abroad.",
            "What is expat life?",
            "How to adjust to a new country?",
            "Explain cultural shock.",
            "What are common travel scams?",
            "How to stay safe while traveling?",
            "Tips for responsible tourism.",
            "What is ecotourism?",
            "How to minimize environmental impact while traveling?",
            "Explain sustainable tourism practices.",
            "What are voluntourism opportunities?",
            "How to choose an ethical volunteer program?",
            "Tips for learning about local traditions.",
            "What are intangible cultural heritage?",
            "How to protect historical sites?",
            "Explain heritage tourism.",
            "What is pilgrimage tourism?",
            "How to respect sacred places?",
            "Tips for adventure travel.",
            "What are extreme sports?",
            "How to prepare for a hiking trip?",
            "Explain backpacking essentials.",
            "What is glamping?",
            "How to choose camping gear?",
            "Tips for wildlife viewing.",
            "What are safari ethics?",
            "How to photograph nature responsibly?",
            "Explain astrophotography.",
            "What is urban exploration?",
            "How to practice street photography?",
            "Tips for portrait photography.",
            "What are landscape photography techniques?",
            "How to use natural light in photography?",
            "Explain composition rules in photography.",
            "What is post-processing in photography?",
            "How to edit photos in Lightroom?",
            "Tips for using Photoshop.",
            "What are video editing software options?",
            "How to create a short film?",
            "Explain documentary filmmaking.",
            "What is animation?",
            "How to draw cartoons?",
            "Tips for digital art creation.",
            "What are graphic design principles?",
            "How to create a logo?",
            "Explain typography basics.",
            "What are color theory principles?",
            "How to design a website?",
            "Tips for UX/UI design.",
            "What is user research?",
            "How to conduct usability testing?",
            "Explain wireframing and prototyping.",
            "What are front-end development technologies?",
            "How to learn React.js?",
            "Tips for back-end development.",
            "What is Python for data science?",
            "How to use R for statistical analysis?",
            "Explain machine learning algorithms.",
            "What is deep learning?",
            "How to build a neural network?",
            "Tips for natural language processing (NLP).",
            "What is computer vision?",
            "How to apply AI in healthcare?",
            "Explain AI in finance.",
            "What are applications of AI in education?",
            "How to use AI in marketing?",
            "Tips for AI-powered customer service.",
            "What is AI ethics?",
            "How to ensure AI transparency?",
            "Explain AI bias.",
            "What are ethical guidelines for AI?",
            "How to develop responsible AI systems?",
            "Tips for AI governance frameworks.",
            "What is the future of AI?",
            "How will AI change society?",
            "Explain the concept of superintelligence.",
            "What are risks of advanced AI?",
            "How to prepare for an AI-driven future?",
            "Tips for human-AI collaboration.",
            "What is the singularity?",
            "How to balance technological progress with human values?",
            "Explain the role of philosophy in AI.",
            "What is consciousness?",
            "How does the brain work?",
            "Tips for understanding neuroscience.",
            "What are mental models?",
            "How to improve cognitive function?",
            "Explain neurofeedback.",
            "What are brainwave states?",
            "How to enhance creativity through brain training?",
            "Tips for improving memory recall.",
            "What is mnemonics?",
            "How to learn faster?",
            "Explain spaced repetition.",
            "What are active recall techniques?",
            "Tips for note-taking strategies.",
            "What is Cornell Notes system?",
            "How to use mind maps for learning?",
            "Explain Feynman technique.",
            "What are different learning theories?",
            "How to apply constructivism in education?",
            "Tips for project-based learning.",
            "What is inquiry-based science?",
            "How to teach coding to kids?",
            "Explain robotics for education.",
            "What are benefits of AI in education?",
            "How to use virtual reality for learning?",
            "Tips for augmented reality in classrooms.",
            "What is gamified learning?",
            "How to design educational games?",
            "Explain serious games for training.",
            "What are simulations in education?",
            "How to use digital storytelling in the classroom?",
            "Tips for creating educational videos.",
            "What are podcasts for learning?",
            "How to use social media for educational purposes responsibly?",
            "Explain online collaboration tools for students.",
            "What are virtual field trips?",
            "How to leverage open educational resources (OER)?",
            "Tips for copyright and fair use in education.",
            "What is academic integrity?",
            "How to prevent plagiarism among students?",
            "Explain ethical research practices.",
            "What are student data privacy concerns?",
            "How to protect student information?",
            "Tips for responsible use of AI by students.",
            "What is AI literacy?",
            "How to teach students about AI?",
            "Explain the societal impact of AI for young learners.",
            "What are career opportunities in AI?",
            "How to prepare students for an AI-driven workforce?",
            "Tips for developing future-ready skills.",
            "What is emotional intelligence for students?",
            "How to teach empathy and compassion?",
            "Explain conflict resolution skills for children.",
            "What are positive communication techniques for students?",
            "How to build resilience in young learners?",
            "Tips for fostering a growth mindset in the classroom.",
            "What is self-regulation for students?",
            "How to manage stress in school?",
            "Explain mindfulness practices for students.",
            "What are positive psychology principles in education?",
            "How to promote happiness and well-being in schools?",
            "Tips for character education.",
            "What are values education approaches?",
            "How to teach ethics to children?",
            "Explain civic responsibility for students.",
            "What is global awareness in education?",
            "How to foster intercultural understanding?",
            "Tips for promoting human rights education.",
            "What are peace education strategies?",
            "How to teach about sustainable development goals?",
            "Explain environmental stewardship for kids.",
            "What is climate literacy?",
            "How to engage students in environmental action?",
            "Tips for community service learning projects.",
            "What are benefits of volunteering for students?",
            "How to promote leadership skills in school?",
            "Explain entrepreneurship education for youth.",
            "What are financial literacy programs for students?",
            "How to teach personal finance skills?",
            "Tips for career counseling for teenagers.",
            "What are vocational education pathways?",
            "How to prepare for higher education?",
            "Explain college application essays.",
            "What are scholarship opportunities?",
            "How to choose the right college major?",
            "Tips for career planning.",
            "What is lifelong learning?",
            "How to continuously develop new skills?",
            "Explain reskilling and upskilling.",
            "What are future skills for the workplace?",
            "How to adapt to changing job markets?",
            "Tips for career transitions.",
            "What is personal development?",
            "How to set personal goals?",
            "Explain habits and routines for success.",
            "What are productivity hacks?",
            "How to manage time effectively?",
            "Tips for overcoming procrastination.",
            "What is self-discipline?",
            "How to build motivation?",
            "Explain the power of positive thinking.",
            "What are visualization techniques?",
            "How to use affirmations for personal growth?",
            "Tips for gratitude practice.",
            "What is mindfulness in daily life?",
            "How to reduce stress and anxiety?",
            "Explain relaxation techniques.",
            "What are breathing exercises?",
            "How to practice meditation for beginners?",
            "Tips for improving sleep quality.",
            "What are healthy eating habits?",
            "How to maintain a balanced diet?",
            "Explain the benefits of regular exercise.",
            "What is a holistic approach to health?",
            "How to boost your immune system?",
            "Tips for managing chronic conditions.",
            "What is preventive healthcare?",
            "How to find a good doctor?",
            "Explain patient advocacy.",
            "What are health insurance options?",
            "How to understand medical billing?",
            "Tips for navigating the healthcare system.",
            "What is mental well-being?",
            "How to identify signs of mental health issues?",
            "Explain therapy options.",
            "What are support groups?",
            "How to help someone with depression?",
            "Tips for suicide prevention.",
            "What is substance abuse awareness?",
            "How to seek help for addiction?",
            "Explain recovery process.",
            "What are signs of an unhealthy relationship?",
            "How to set healthy boundaries?",
            "Tips for effective communication in relationships.",
            "What is conflict resolution in personal relationships?",
            "How to build trust in relationships?",
            "Explain healthy dating practices.",
            "What are signs of domestic violence?",
            "How to seek help for abuse?",
            "Tips for building self-esteem.",
            "What is self-love?",
            "How to practice self-compassion?",
            "Explain body positivity.",
            "What is imposter syndrome?",
            "How to overcome self-doubt?",
            "Tips for building confidence.",
            "What is resilience in adults?",
            "How to cope with stress and adversity?",
            "Explain post-traumatic growth.",
            "What are different types of intelligence?",
            "How to improve emotional intelligence?",
            "Tips for developing social skills.",
            "What is empathy vs. sympathy?",
            "How to be a better listener?",
            "Explain assertive communication.",
            "What is non-violent communication?",
            "How to give and receive feedback effectively?",
            "Tips for public speaking anxiety.",
            "What is charisma?",
            "How to build rapport quickly?",
            "Explain negotiation skills.",
            "What are conflict management styles?",
            "How to mediate a dispute?",
            "Tips for teamwork and collaboration.",
            "What is effective leadership?",
            "How to motivate others?",
            "Explain delegation strategies.",
            "What is coaching and mentoring?",
            "How to inspire creativity in a team?",
            "Tips for managing diverse teams.",
            "What is cross-cultural competence?",
            "How to resolve cultural misunderstandings?",
            "Explain global awareness for professionals.",
            "What are international business etiquette rules?",
            "How to adapt to new work environments?",
            "Tips for career planning and development.",
            "What is a personal mission statement?",
            "How to identify your strengths and weaknesses?",
            "Explain career mapping.",
            "What are job search strategies?",
            "How to write a compelling resume?",
            "Tips for successful job interviews.",
            "What is networking for career advancement?",
            "How to use LinkedIn effectively?",
            "Explain personal branding for professionals.",
            "What is salary negotiation?",
            "How to manage career transitions?",
            "Tips for entrepreneurship for beginners.",
            "What is a business model canvas?",
            "How to validate a business idea?",
            "Explain lean startup methodology.",
            "What are minimum viable products (MVPs)?",
            "How to secure startup funding?",
            "Tips for pitching to investors.",
            "What is venture capital funding?",
            "How to build a startup team?",
            "Explain intellectual property protection.",
            "What are legal considerations for startups?",
            "How to create a marketing strategy for a small business?",
            "Tips for social media marketing for businesses.",
            "What is content marketing for startups?",
            "How to measure marketing campaign effectiveness?",
            "Explain customer acquisition strategies.",
            "What is customer retention?",
            "How to provide excellent customer service?",
            "Tips for building customer loyalty.",
            "What is public relations for businesses?",
            "How to manage negative publicity?",
            "Explain crisis communication for companies.",
            "What are ethical business practices?",
            "How to implement corporate social responsibility?",
            "Tips for sustainable business models.",
            "What is green business?",
            "How to reduce environmental impact in business?",
            "Explain circular economy principles for companies.",
            "What are certifications for sustainable businesses?",
            "How to measure environmental performance?",
            "Tips for supply chain sustainability.",
            "What is ethical sourcing?",
            "How to ensure fair labor practices?",
            "Explain responsible consumption and production.",
            "What are UN Sustainable Development Goals for business?",
            "How to report on sustainability efforts?",
            "Tips for engaging employees in sustainability.",
            "What is corporate governance?",
            "How to ensure board diversity?",
            "Explain shareholder activism.",
            "What are regulations for publicly traded companies?",
            "How to manage mergers and acquisitions?",
            "Tips for business expansion strategies.",
            "What is international trade?",
            "How to export goods and services?",
            "Explain import regulations.",
            "What are global supply chain challenges?",
            "How to mitigate geopolitical risks for businesses?",
            "Tips for navigating international markets.",
            "What is foreign exchange risk?",
            "How to manage currency fluctuations?",
            "Explain international financial reporting standards.",
            "What are global tax considerations?",
            "How to comply with international business laws?",
            "Tips for cross-border investments.",
            "What is the World Trade Organization (WTO)?",
            "How do trade agreements work?",
            "Explain economic sanctions.",
            "What are trade wars?",
            "How to assess country risk?",
            "Tips for political risk analysis.",
            "What is the role of diplomacy in international business?",
            "How to negotiate with international partners?",
            "Explain cultural intelligence for business leaders.",
            "What are communication styles across cultures?",
            "How to build trust in global teams?",
            "Tips for managing cultural differences in the workplace.",
            "What is virtual team management?",
            "How to foster collaboration in remote global teams?",
            "Explain digital nomad lifestyle.",
            "What are remote work trends?",
            "How to build a successful distributed company?",
            "Tips for managing time zones effectively.",
            "What is the future of work post-pandemic?",
            "How will automation affect jobs?",
            "Explain the gig economy's impact on employment.",
            "What are new job roles in emerging technologies?",
            "How to prepare for job displacement?",
            "Tips for reskilling and upskilling for automation.",
            "What is continuous learning in the workplace?",
            "How to develop adaptability in your career?",
            "Explain the importance of soft skills.",
            "What are critical thinking skills for the future?",
            "How to improve problem-solving abilities?",
            "Tips for fostering creativity in your career.",
            "What is emotional intelligence in the professional world?",
            "How to build strong professional networks?",
            "Explain mentorship and sponsorship in career growth.",
            "What are leadership development programs?",
            "How to become an effective leader?",
            "Tips for strategic thinking in leadership.",
            "What is change leadership?",
            "How to navigate organizational change?",
            "Explain innovation management.",
            "What are trends in organizational culture?",
            "How to build a positive and inclusive workplace culture?",
            "Tips for employee well-being initiatives.",
            "What is mental health support in the workplace?",
            "How to prevent burnout in high-stress jobs?",
            "Explain work-life integration.",
            "What are flexible work arrangements?",
            "How to manage stress and anxiety at work?",
            "Tips for promoting psychological safety.",
            "What is diversity, equity, and inclusion (DEI) in organizations?",
            "How to implement DEI strategies effectively?",
            "Explain unconscious bias training.",
            "What are microaggressions in the workplace?",
            "How to create a sense of belonging for all employees?",
            "Tips for allyship in the workplace.",
            "What is inclusive hiring?",
            "How to reduce bias in recruitment?",
            "Explain fair compensation practices.",
            "What are performance reviews best practices?",
            "How to give constructive feedback effectively?",
            "Tips for managing difficult conversations at work.",
            "What is conflict resolution in teams?",
            "How to build high-performing teams?",
            "Explain team dynamics.",
            "What are leadership styles?",
            "How to choose the right leadership approach?",
            "Tips for motivating diverse teams.",
            "What is servant leadership in practice?",
            "How to empower employees?",
            "Explain delegation techniques.",
            "What are effective meeting strategies?",
            "How to run productive brainstorming sessions?",
            "Tips for decision-making in teams.",
            "What is agile project management?",
            "How to implement Scrum methodology?",
            "Explain Kanban boards.",
            "What are project management software tools?",
            "How to manage project risks?",
            "Tips for stakeholder management.",
            "What is resource allocation in projects?",
            "How to track project progress?",
            "Explain project closure best practices.",
            "What is quality management in projects?",
            "How to conduct post-mortems for projects?",
            "Tips for continuous improvement in operations.",
            "What is Lean Six Sigma?",
            "How to optimize business processes?",
            "Explain supply chain management strategies.",
            "What are logistics and transportation trends?",
            "How to manage inventory effectively?",
            "Tips for warehouse optimization.",
            "What is e-commerce fulfillment?",
            "How to handle returns and reverse logistics?",
            "Explain retail operations management.",
            "What are customer experience (CX) strategies?",
            "How to map the customer journey?",
            "Tips for enhancing customer satisfaction.",
            "What is net promoter score (NPS)?",
            "How to collect customer feedback?",
            "Explain customer service best practices.",
            "What are chatbots for customer support?",
            "How to use AI in customer service?",
            "Tips for personalizing customer interactions.",
            "What is customer relationship management (CRM) software?",
            "How to implement a CRM system?",
            "Explain sales process optimization.",
            "What are B2B sales strategies?",
            "How to cold call effectively?",
            "Tips for lead generation.",
            "What is conversion rate optimization?",
            "How to build a sales funnel?",
            "Explain marketing automation.",
            "What are email marketing best practices?",
            "How to design effective landing pages?",
            "Tips for search engine marketing (SEM).",
            "What is Google Ads?",
            "How to optimize for local SEO?",
            "Explain content strategy for websites.",
            "What are types of blog content?",
            "How to write engaging headlines?",
            "Tips for social media content creation.",
            "What is video marketing?",
            "How to use TikTok for business?",
            "Explain Instagram marketing strategies.",
            "What are LinkedIn marketing best practices?",
            "How to build a brand community online?",
            "Tips for online reputation management.",
            "What is public relations for startups?",
            "How to write a press release?",
            "Explain media relations.",
            "What are crisis communication plans?",
            "How to manage negative online reviews?",
            "Tips for building brand loyalty.",
            "What is experiential marketing?",
            "How to create memorable brand experiences?",
            "Explain cause marketing.",
            "What are corporate partnerships?",
            "How to measure marketing campaign ROI?",
            "Tips for analytics and reporting in marketing.",
            "What is A/B testing?",
            "How to use Google Analytics?",
            "Explain data visualization for marketing insights.",
            "What are market research methods?",
            "How to conduct surveys effectively?",
            "Tips for competitor analysis.",
            "What is market segmentation?",
            "How to identify target audiences?",
            "Explain product development process.",
            "What are stages of the product lifecycle?",
            "How to launch a new product successfully?",
            "Tips for product pricing strategies.",
            "What is product management?",
            "How to work with engineering teams?",
            "Explain user stories and product backlogs.",
            "What are agile product development principles?",
            "How to conduct user acceptance testing (UAT)?",
            "Tips for managing product roadmaps.",
            "What is product market fit?",
            "How to scale a product?",
            "Explain product growth strategies.",
            "What are strategies for product iteration?",
            "How to sunset a product?",
            "Tips for building minimum viable products (MVPs).",
            "What is design thinking in product development?",
            "How to conduct user interviews?",
            "Explain prototyping tools.",
            "What are usability heuristics?",
            "How to perform heuristic evaluation?",
            "Tips for accessibility in design.",
            "What is inclusive design?",
            "How to design for diverse users?",
            "Explain ethical design principles.",
            "What are dark patterns in UX?",
            "How to design for privacy?",
            "Tips for creating user-centered designs.",
            "What is information architecture?",
            "How to organize content for usability?",
            "Explain navigation design.",
            "What are interaction design principles?",
            "How to design intuitive interfaces?",
            "Tips for creating delightful user experiences.",
            "What is animation in UI design?",
            "How to use microinteractions effectively?",
            "Explain haptic feedback in UI.",
            "What are responsive web design principles?",
            "How to design for mobile first?",
            "Tips for cross-browser compatibility.",
            "What is progressive web app (PWA) development?",
            "How to optimize website performance?",
            "Explain critical rendering path.",
            "What are web accessibility standards?",
            "How to make websites accessible for all users?",
            "Tips for search engine optimization (SEO) for designers.",
            "What is Google's Core Web Vitals?",
            "How to improve website SEO?",
            "Explain schema markup.",
            "What are backlinks and link building?",
            "How to conduct keyword research?",
            "Tips for on-page SEO optimization.",
            "What is technical SEO?",
            "How to audit website SEO?",
            "Explain SEO tools.",
            "What are content delivery networks (CDNs)?",
            "How to secure a website?",
            "Tips for preventing cyber attacks.",
            "What is a firewall?",
            "How to use SSL certificates?",
            "Explain data encryption in web security.",
            "What are common web vulnerabilities?",
            "How to prevent SQL injection?",
            "Tips for preventing cross-site scripting (XSS).",
            "What is authentication and authorization?",
            "How to implement secure user logins?",
            "Explain password hashing.",
            "What are API security best practices?",
            "How to secure cloud applications?",
            "Tips for secure coding practices.",
            "What is penetration testing?",
            "How to conduct a security audit?",
            "Explain incident response plans.",
            "What are disaster recovery strategies?",
            "How to perform data backups and recovery?",
            "Tips for business continuity planning.",
            "What is IT governance?",
            "How to manage IT risks?",
            "Explain IT service management (ITSM).",
            "What are ITIL frameworks?",
            "How to manage IT projects?",
            "Tips for IT budgeting.",
            "What is cloud cost management?",
            "How to optimize cloud resources?",
            "Explain serverless computing.",
            "What are containerization technologies like Docker?",
            "How to use Kubernetes for orchestration?",
            "Tips for DevOps practices.",
            "What is continuous integration/continuous delivery (CI/CD)?",
            "How to automate software deployments?",
            "Explain infrastructure as code (IaC).",
            "What are security automation tools?",
            "How to implement DevSecOps?",
            "Tips for site reliability engineering (SRE).",
            "What is observability in software systems?",
            "How to monitor application performance?",
            "Explain logging and tracing.",
            "What are alert management systems?",
            "How to troubleshoot complex systems?",
            "Tips for incident post-mortems.",
            "What is chaos engineering?",
            "How to build resilient systems?",
            "Explain fault tolerance.",
            "What are distributed systems challenges?",
            "How to design scalable architectures?",
            "Tips for microservices architecture.",
            "What is event-driven architecture?",
            "How to use message queues?",
            "Explain data streaming technologies.",
            "What are database design principles?",
            "How to choose the right database?",
            "Tips for NoSQL databases.",
            "What is graph database?",
            "How to optimize database performance?",
            "Explain database security.",
            "What are data warehousing concepts?",
            "How to build a data lake?",
            "Tips for ETL processes.",
            "What is business intelligence dashboards?",
            "How to create interactive reports?",
            "Explain data storytelling.",
            "What are benefits of data governance?",
            "How to ensure data quality?",
            "Tips for data privacy regulations (e.g., CCPA, GDPR).",
            "What is ethical data use?",
            "How to prevent algorithmic bias?",
            "Explain responsible AI development.",
            "What are fairness metrics in machine learning?",
            "How to ensure AI transparency and explainability?",
            "Tips for AI auditing.",
            "What is federated learning?",
            "How to train AI models with privacy preservation?",
            "Explain differential privacy.",
            "What are synthetic data generation methods?",
            "How to secure machine learning models?",
            "Tips for adversarial machine learning.",
            "What is model interpretability?",
            "How to debug machine learning models?",
            "Explain model monitoring and maintenance.",
            "What is MLOps?",
            "How to deploy machine learning models in production?",
            "Tips for versioning machine learning models.",
            "What are machine learning platforms?",
            "How to use cloud AI services?",
            "Explain custom machine learning models.",
            "What are deep neural networks?",
            "How to train convolutional neural networks (CNNs)?",
            "Tips for recurrent neural networks (RNNs).",
            "What are transformers in NLP?",
            "How to fine-tune pre-trained models?",
            "Explain generative adversarial networks (GANs).",
            "What are reinforcement learning applications?",
            "How to build intelligent agents?",
            "Tips for natural language understanding (NLU).",
            "What is natural language generation (NLG)?",
            "How to perform sentiment analysis?",
            "Explain named entity recognition (NER).",
            "What are text summarization techniques?",
            "How to build a chatbot?",
            "Tips for voice assistants development.",
            "What is computer vision in robotics?",
            "How to use object detection models?",
            "Explain image segmentation.",
            "What are facial recognition technologies?",
            "How to apply computer vision in security?",
            "Tips for developing augmented reality (AR) applications.",
            "What is virtual reality (VR) for training?",
            "How to create immersive experiences?",
            "Explain mixed reality (MR).",
            "What are applications of VR/AR in healthcare?",
            "How to use AR for remote assistance?",
            "Tips for developing games with AR/VR.",
            "What is game design theory?",
            "How to create game mechanics?",
            "Explain level design.",
            "What are types of video game genres?",
            "How to monetize games?",
            "Tips for indie game development.",
            "What is game engine development?",
            "How to use Unity for game creation?",
            "Explain Unreal Engine.",
            "What are tools for 3D modeling?",
            "How to animate 3D characters?",
            "Tips for character rigging.",
            "What is texture mapping?",
            "How to optimize game assets?",
            "Explain game physics engines.",
            "What are artificial intelligence in games?",
            "How to design game AI?",
            "Tips for pathfinding algorithms.",
            "What is procedural content generation?",
            "How to implement networking in games?",
            "Explain multiplayer game architectures.",
            "What are security considerations for online games?",
            "How to prevent cheating in games?",
            "Tips for game testing and quality assurance.",
            "What is game localization?",
            "How to market a video game?",
            "Explain esports and competitive gaming.",
            "What are streaming platforms for games?",
            "How to become a professional gamer?",
            "Tips for content creation as a streamer.",
            "What is game development boot camp?",
            "How to learn game programming?",
            "Explain game art and animation courses.",
            "What are sound design principles for games?",
            "How to compose game music?",
            "Tips for writing game narratives.",
            "What is world-building in games?",
            "How to create compelling game characters?",
            "Explain branching narratives in games.",
            "What are interactive storytelling techniques?",
            "How to design puzzle games?",
            "Tips for educational game design.",
            "What is serious games development?",
            "How to use games for training and simulation?",
            "Explain gamification in business.",
            "What are elements of gamification?",
            "How to apply gamification to education?",
            "Tips for designing reward systems.",
            "What is behavioral economics?",
            "How to influence user behavior ethically?",
            "Explain nudges in design.",
            "What are ethical considerations in persuasive design?",
            "How to design for positive habits?",
            "Tips for breaking bad habits.",
            "What is habit formation theory?",
            "How to use triggers, routines, and rewards?",
            "Explain the Fogg Behavior Model.",
            "What is the power of small wins?",
            "How to build self-efficacy?",
            "Tips for setting challenging but achievable goals.",
            "What is deliberate practice?",
            "How to learn from failures?",
            "Explain resilience and grit.",
            "What are characteristics of successful people?",
            "How to develop a growth mindset?",
            "Tips for cultivating emotional intelligence.",
            "What is positive psychology in practice?",
            "How to find your purpose in life?",
            "Explain meaning-making.",
            "What are values-based living principles?",
            "How to align actions with values?",
            "Tips for cultivating gratitude.",
            "What is forgiveness and its benefits?",
            "How to practice self-compassion?",
            "Explain the power of mindfulness.",
            "What are meditation techniques for stress relief?",
            "How to cultivate inner peace?",
            "Tips for managing anxiety and worry.",
            "What is cognitive restructuring?",
            "How to challenge negative thoughts?",
            "Explain behavioral activation.",
            "What are coping skills for depression?",
            "How to build a support system?",
            "Tips for effective communication in relationships.",
            "What is active listening?",
            "How to resolve conflicts constructively?",
            "Explain empathetic responding.",
            "What are healthy boundaries in relationships?",
            "How to build trust and intimacy?",
            "Tips for navigating difficult conversations.",
            "What is nonviolent communication?",
            "How to express needs clearly?",
            "Explain the impact of body language.",
            "What are signs of healthy attachment?",
            "How to heal from relationship trauma?",
            "Tips for self-love and self-respect.",
            "What is emotional regulation?",
            "How to manage strong emotions?",
            "Explain distress tolerance skills.",
            "What are mindfulness-based stress reduction techniques?",
            "How to practice radical acceptance?",
            "Tips for building resilience after trauma.",
            "What is post-traumatic growth?",
            "How to seek professional help for mental health?",
            "Explain different types of therapy.",
            "What are benefits of counseling?",
            "How to find a good therapist?",
            "Tips for medication management for mental health.",
            "What is crisis intervention?",
            "How to support someone in crisis?",
            "Explain suicide prevention strategies.",
            "What are signs of addiction?",
            "How to seek help for substance use disorder?",
            "Tips for recovery and relapse prevention.",
            "What is harm reduction?",
            "How to support a loved one with addiction?",
            "Explain codependency.",
            "What are boundaries for healthy relationships?",
            "How to practice self-care to prevent burnout?",
            "Tips for managing work-life balance.",
            "What is digital detox?",
            "How to create a healthy relationship with technology?",
            "Explain conscious consumption.",
            "What are sustainable living practices?",
            "How to reduce your environmental footprint?",
            "Tips for mindful eating.",
            "What is intuitive eating?",
            "How to foster positive body image?",
            "Explain healthy lifestyle choices.",
            "What are benefits of physical activity?",
            "How to incorporate exercise into your routine?",
            "Tips for improving sleep hygiene.",
            "What is stress management?",
            "How to practice relaxation techniques?",
            "Explain the importance of hydration.",
            "What are superfoods?",
            "How to boost your immune system naturally?",
            "Tips for maintaining gut health.",
            "What is the microbiome?",
            "How to reduce inflammation through diet?",
            "Explain chronic disease prevention.",
            "What are benefits of preventative care?",
            "How to manage chronic conditions?",
            "Tips for healthy aging.",
            "What is brain health?",
            "How to prevent cognitive decline?",
            "Explain neuroplasticity and learning.",
            "What are memory-boosting techniques?",
            "How to improve focus and concentration?",
            "Tips for lifelong learning.",
            "What is intellectual curiosity?",
            "How to stay mentally active?",
            "Explain the power of reading.",
            "What are benefits of learning a new language?",
            "How to play brain games?",
            "Tips for creative problem-solving.",
            "What is divergent thinking?",
            "How to foster innovation?",
            "Explain design thinking process.",
            "What are ideation techniques?",
            "How to brainstorm effectively?",
            "Tips for overcoming creative blocks.",
            "What is artistic expression?",
            "How to find your creative outlet?",
            "Explain the benefits of hobbies.",
            "What are ways to relax and de-stress?",
            "How to enjoy leisure time fully?",
            "Tips for finding joy in everyday life.",
            "What is the pursuit of happiness?",
            "How to cultivate optimism?",
            "Explain resilience in challenging times.",
            "What is post-traumatic growth?",
            "How to build meaningful relationships?",
            "Tips for fostering connection.",
            "What is the importance of community?",
            "How to give back to society?",
            "Explain philanthropy and altruism.",
            "What are different forms of volunteering?",
            "How to make a positive impact?",
            "Tips for advocacy and activism.",
            "What is social justice?",
            "How to promote equality and equity?",
            "Explain human rights.",
            "What are ethical dilemmas?",
            "How to make ethical decisions?",
            "Tips for moral reasoning.",
            "What is critical thinking in daily life?",
            "How to analyze information effectively?",
            "Explain logical fallacies.",
            "What are biases in thinking?",
            "How to avoid misinformation?",
            "Tips for media literacy.",
            "What is responsible digital citizenship?",
            "How to manage your online presence?",
            "Explain cyber security for individuals.",
            "What are common online scams?",
            "How to protect your privacy online?",
            "Tips for strong password creation.",
            "What is two-factor authentication (2FA)?",
            "How to recognize phishing emails?",
            "Explain identity theft prevention.",
            "What are VPNs and why use them?",
            "How to secure your smart home devices?",
            "Tips for safe online shopping.",
            "What is data breach notification?",
            "How to respond to a data breach?",
            "Explain ransomware attacks.",
            "What are computer viruses and malware?",
            "How to keep your software updated?",
            "Tips for secure Wi-Fi usage.",
            "What is public Wi-Fi safety?",
            "How to use a password manager?",
            "Explain digital footprint.",
            "What are privacy settings on social media?",
            "How to delete personal data online?",
            "Tips for managing online reputation.",
            "What is cancel culture?",
            "How to navigate online discourse responsibly?",
            "Explain digital well-being.",
            "What is screen time management?",
            "How to reduce digital distractions?",
            "Tips for a healthy relationship with social media.",
            "What is social media addiction?",
            "How to do a digital detox?",
            "Explain tech-life balance.",
            "What are benefits of unplugging?",
            "How to foster real-world connections?",
            "Tips for intentional technology use.",
            "What is slow living?",
            "How to embrace simplicity?",
            "Explain mindful consumption.",
            "What are benefits of decluttering?",
            "How to organize your home effectively?",
            "Tips for minimalist living.",
            "What is zero-waste lifestyle?",
            "How to reduce plastic waste?",
            "Explain composting at home.",
            "What are sustainable fashion choices?",
            "How to reduce your carbon footprint?",
            "Tips for energy conservation.",
            "What is renewable energy at home?",
            "How to grow your own food?",
            "Explain urban gardening.",
            "What are permaculture principles?",
            "How to support local food systems?",
            "Tips for ethical eating.",
            "What is plant-based diet?",
            "How to reduce meat consumption?",
            "Explain sustainable seafood choices.",
            "What are benefits of buying local?",
            "How to support fair trade products?",
            "Tips for eco-friendly transportation.",
            "What is active transportation?",
            "How to use public transit efficiently?",
            "Explain electric vehicles (EVs).",
            "What are benefits of biking?",
            "How to make your home more energy efficient?",
            "Tips for water conservation at home.",
            "What is rain harvesting?",
            "How to reduce water waste?",
            "Explain responsible waste management.",
            "What are recycling best practices?",
            "How to dispose of hazardous waste?",
            "Tips for preventing pollution.",
            "What is air quality monitoring?",
            "How to reduce indoor air pollution?",
            "Explain noise pollution effects.",
            "What are light pollution solutions?",
            "How to protect biodiversity?",
            "Tips for wildlife conservation.",
            "What is habitat restoration?",
            "How to support endangered species?",
            "Explain the impact of climate change on ecosystems.",
            "What are climate change mitigation strategies?",
            "How to adapt to climate change impacts?",
            "Tips for climate resilience.",
            "What is carbon sequestration?",
            "How to promote reforestation?",
            "Explain sustainable forestry.",
            "What are ocean conservation efforts?",
            "How to reduce plastic in oceans?",
            "Tips for marine life protection.",
            "What is coral reef conservation?",
            "How to prevent overfishing?",
            "Explain sustainable fisheries.",
            "What are wetlands restoration projects?",
            "How to protect freshwater sources?",
            "Tips for water quality improvement.",
            "What is environmental justice?",
            "How to address environmental racism?",
            "Explain indigenous environmental knowledge.",
            "What are traditional ecological practices?",
            "How to integrate indigenous perspectives in conservation?",
            "Tips for citizen advocacy for environmental issues.",
            "What is environmental policy?",
            "How to engage with local government on environmental issues?",
            "Explain international environmental agreements.",
            "What are green technologies?",
            "How to invest in renewable energy?",
            "Tips for sustainable finance.",
            "What is impact investing?",
            "How to measure environmental social governance (ESG) performance?",
            "Explain corporate sustainability reporting.",
            "What are green jobs?",
            "How to pursue a career in sustainability?",
            "Tips for environmental education.",
            "What is outdoor learning?",
            "How to connect children with nature?",
            "Explain nature-based solutions.",
            "What are urban green spaces?",
            "How to design sustainable cities?",
            "Tips for community gardening.",
            "What is food sovereignty?",
            "How to promote local food systems?",
            "Explain resilient food systems.",
            "What are permaculture design principles?",
            "How to build a food forest?",
            "Tips for zero-waste cooking.",
            "What is food waste reduction?",
            "How to compost food scraps?",
            "Explain circular economy models for food.",
            "What are sustainable agriculture practices?",
            "How to support regenerative farming?",
            "Tips for ethical eating choices."
        ];

        const initialAIMessage = {
            role: 'model',
            parts: [{ text: 'Greetings, seeker! I am Mystic Vision, an AI designed to help you glimpse the beyond. What wisdom do you seek?' }],
        };

        // --- Initialization on Load ---
        window.addEventListener('load', () => {
             createIcons();
             userInput.style.height = userInput.scrollHeight + 'px';

             // Initialize Dark Mode based on localStorage or default
             const isDarkMode = localStorage.getItem('dark-mode') === 'true';
             document.body.classList.toggle('light', !isDarkMode); // Toggle light class based on dark mode status
             darkModeToggle.checked = isDarkMode;

             // Register Service Worker for PWA
             if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('ServiceWorker registered: ', registration);
                })
                .catch(registrationError => {
                    console.log('ServiceWorker registration failed: ', registrationError);
                });
             }

             // Start a new chat on load to display initial message
             startNewChat();
        });

        // --- Dark Mode Toggle ---
        darkModeToggle.addEventListener('change', () => {
            const isChecked = darkModeToggle.checked;
            document.body.classList.toggle('light', !isChecked); // Add/remove light class
            localStorage.setItem('dark-mode', isChecked);
        });

        // --- Lucide Icon Helper ---
        const createIcons = () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        };

        function updateButtonIcon(buttonElement, newIconName, classList = 'w-4 h-4') {
            let currentIconSvg = buttonElement.querySelector('.lucide');
            if (currentIconSvg) {
                currentIconSvg.remove();
            }

            const newIconSpan = document.createElement('span');
            newIconSpan.setAttribute('data-lucide', newIconName);
            newIconSpan.className = classList; 

            buttonElement.appendChild(newIconSpan);
           
            createIcons(); 
        }

        // --- File Handling Helpers ---
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve({
                    mimeType: file.type || 'application/octet-stream', 
                    data: reader.result.split(',')[1]
                });
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        };

        function getFileIcon(mimeType) {
            if (mimeType.startsWith('image/')) return 'image';
            if (mimeType === 'application/pdf') return 'file-text';
            if (mimeType.includes('text/')) return 'file-text';
            if (mimeType.includes('csv') || mimeType.includes('excel')) return 'file-spreadsheet';
            if (mimeType.includes('json') || mimeType.includes('xml') || mimeType.includes('code') || mimeType.includes('markdown')) return 'file-code';
            return 'file';
        }

        // --- Markdown.js Custom Renderer for Code Blocks ---
        const renderer = {
            // Updated signature: `token` is now the first (and only relevant) argument
            code(token) { 
                const actualCodeContent = token.text; // Get the code string from the token object
                const lang = token.lang;             // Get the language from the token object

                const languageDisplay = lang ? `<span class="text-xs font-semibold uppercase text-gray-400">${lang}</span>` : '';
                const uniqueId = `code-block-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                
                const escapedCode = actualCodeContent.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');

                return `
                    <div class="code-block-container">
                        <div class="code-block-header">
                            ${languageDisplay}
                            <button class="code-block-copy-button" data-copy-target="${uniqueId}">
                                <span data-lucide="clipboard" class="w-4 h-4"></span>
                                Copy code
                            </button>
                        </div>
                        <pre><code id="${uniqueId}">${escapedCode}</code></pre>
                    </div>
                `;
            }
        };
        marked.use({ renderer });

        // --- Chat UI & Logic ---
        function appendChatMessage(role, text, attachments = []) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', role);
            
            const messageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            messageDiv.dataset.messageId = messageId;
            
            let contentHTML = '';
            let rawMessageContentForCache = ''; 

            if (role === 'user') {
                rawMessageContentForCache = `You: ${text}`;
                contentHTML += `<span class="font-bold">You:</span> ${text}`;
                if (attachments.length > 0) {
                    contentHTML += `<div class="mt-2 flex flex-wrap gap-2">`;
                    attachments.forEach(attachment => {
                        if (attachment.mimeType.startsWith('image/')) {
                            contentHTML += `<img src="data:${attachment.mimeType};base64,${attachment.data}" alt="${attachment.name || 'User attachment'}" class="chat-image w-24 h-24 object-cover">`;
                        } else {
                            contentHTML += `
                                <div class="chat-message-attachment-item">
                                    <span data-lucide="${getFileIcon(attachment.mimeType)}" class="w-4 h-4 flex-shrink-0"></span>
                                    <span class="truncate max-w-[120px]">${attachment.name || 'File'}</span>
                                </div>
                            `;
                        }
                    });
                    contentHTML += `</div>`;
                    rawMessageContentForCache += `\n[Attachments: ${attachments.map(a => a.name).join(', ')}]`;
                }
            } else { 
                rawMessageContentForCache = `AI: ${text}`;
                contentHTML = `<div class="message-content">${marked.parse(text)}</div>`;
            }
            
            messageTextCache.set(messageId, rawMessageContentForCache); 

            const actionsHTML = `
                <div class="message-actions">
                    <button class="copy-message-btn" title="Copy message" data-message-id="${messageId}">
                        <span data-lucide="clipboard" class="w-4 h-4"></span>
                    </button>
                    <button class="dictate-message-btn" title="Dictate message" data-message-id="${messageId}">
                        <span data-lucide="volume-2" class="w-4 h-4"></span>
                    </button>
                </div>
            `;
            
            messageDiv.innerHTML = contentHTML + actionsHTML;
            chatHistoryDiv.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.transform = 'scale(1)';
            }, 10);
            
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
            
            createIcons(); 
        }

        function toggleLoading(show) {
            let loadingIndicator = document.getElementById('loadingIndicator');
            if (show) {
                if (!loadingIndicator) {
                    loadingIndicator = document.createElement('div');
                    loadingIndicator.id = 'loadingIndicator';
                    loadingIndicator.classList.add('p-4', 'text-center', 'text-gray-500', 'text-sm', 'ai-message'); 
                    loadingIndicator.innerHTML = `
                        <div class="loader-container h-8">
                            <div class="loader-dot"></div>
                            <div class="loader-dot"></div>
                            <div class="loader-dot"></div>
                        </div>
                        <span class="mt-2 block">AI is typing...</span>
                    `;
                    chatHistoryDiv.appendChild(loadingIndicator);
                }
                loadingIndicator.style.display = 'flex';
                loadingIndicator.style.flexDirection = 'column'; 
                chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
            } else {
                if (loadingIndicator) {
                    loadingIndicator.remove(); 
                }
            }
        }

        function displayChatAttachments() {
            chatAttachmentsPreviewContainer.innerHTML = '';
            if (chatAttachments.length > 0) {
                chatAttachmentsPreviewContainer.classList.remove('hidden');
                chatAttachments.forEach((attachment, index) => {
                    const attachmentDiv = document.createElement('div');
                    attachmentDiv.classList.add('chat-attachment-preview-item');
                    attachmentDiv.dataset.index = index;

                    let previewContent = '';
                    if (attachment.mimeType.startsWith('image/')) {
                        previewContent = `<img src="data:${attachment.mimeType};base64,${attachment.data}" alt="${attachment.name}" class="w-8 h-8 object-cover rounded-md">`;
                    } else {
                        previewContent = `<span data-lucide="${getFileIcon(attachment.mimeType)}" class="w-5 h-5 flex-shrink-0"></span>`;
                    }

                    attachmentDiv.innerHTML = `
                        ${previewContent}
                        <span class="truncate max-w-[100px]">${attachment.name}</span>
                        <button class="remove-attachment-btn">
                            <span data-lucide="x" class="w-4 h-4"></span>
                        </button>
                    `;
                    chatAttachmentsPreviewContainer.appendChild(attachmentDiv);
                });
                createIcons(); 
            } else {
                chatAttachmentsPreviewContainer.classList.add('hidden');
            }
        }

        function showCopyMessage() {
            copyMessage.classList.add('show');
            setTimeout(() => {
                copyMessage.classList.remove('show');
            }, 3000);
        }

        function copyToClipboard(text) { 
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => {
                        showCopyMessage();
                    })
                    .catch(err => {
                        console.error('Failed to copy: ', err);
                        alert('Failed to copy text. Please copy manually.'); 
                    });
            } else {
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = text;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                try {
                    document.execCommand('copy');
                    showCopyMessage();
                } catch (err) {
                    console.error('Failed to copy (fallback):', err);
                    alert('Failed to copy text. Please copy manually.'); 
                }
                document.body.removeChild(tempTextArea);
            }
        }

        function toggleSpeech(text, buttonElement) {
            if (!window.speechSynthesis) {
                alert('Speech synthesis not supported in this browser.');
                return;
            }

            if (isSpeaking && currentUtterance && currentUtterance.text === text) {
                if (window.speechSynthesis.paused) {
                    window.speechSynthesis.resume();
                    updateButtonIcon(buttonElement, 'pause');
                } else {
                    window.speechSynthesis.pause();
                    updateButtonIcon(buttonElement, 'volume-2');
                }
            } else {
                startSpeech(text, buttonElement);
            }
        }

        function startSpeech(text, buttonElement) {
            if (window.speechSynthesis.speaking || window.speechSynthesis.paused) {
                window.speechSynthesis.cancel();
            }

            document.querySelectorAll('.dictate-message-btn').forEach(btn => {
                if (btn !== buttonElement) { 
                    updateButtonIcon(btn, 'volume-2'); 
                }
            });

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US'; 

            utterance.onstart = () => {
                isSpeaking = true;
                currentUtterance = utterance;
                updateButtonIcon(buttonElement, 'pause');
            };
            utterance.onend = () => {
                isSpeaking = false;
                currentUtterance = null;
                updateButtonIcon(buttonElement, 'volume-2');
            };
            utterance.onerror = (event) => {
                console.error('Speech synthesis error:', event.error);
                alert('Failed to dictate message. Check console for details.');
                isSpeaking = false;
                currentUtterance = null;
                updateButtonIcon(buttonElement, 'volume-2');
            };

            window.speechSynthesis.speak(utterance);
        }

        // --- Speech Recognition Setup ---
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = true; 
            recognition.interimResults = true; 
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                isVoiceInputActive = true;
                voiceInputBtn.classList.add('voice-input-active');
                updateButtonIcon(voiceInputBtn, 'mic-off', 'w-5 h-5'); 
                userInput.placeholder = 'Listening... Speak now.';
                finalTranscript = ''; 
                userInput.value = ''; 
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript + ' '; 
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                userInput.value = finalTranscript + interimTranscript; 
                userInput.scrollLeft = userInput.scrollWidth; 
                userInput.style.height = 'auto'; 
                userInput.style.height = userInput.scrollHeight + 'px';
            };

            recognition.onend = () => {
                isVoiceInputActive = false;
                voiceInputBtn.classList.remove('voice-input-active');
                updateButtonIcon(voiceInputBtn, 'mic', 'w-5 h-5'); 
                userInput.placeholder = 'Type your message...';

                if (finalTranscript.trim() !== '') {
                    userInput.value = finalTranscript.trim(); 
                } else if (userInput.value.trim() === '') {
                    userInput.value = ''; 
                }
                userInput.style.height = 'auto'; 
                userInput.style.height = userInput.scrollHeight + 'px';
            };

            recognition.onerror = (event) => {
                isVoiceInputActive = false; 
                voiceInputBtn.classList.remove('voice-input-active');
                updateButtonIcon(voiceInputBtn, 'mic', 'w-5 h-5'); 
                userInput.placeholder = 'Type your message...';

                console.error('Speech recognition error:', event.error);
                let errorMessage = `Speech recognition error: ${event.error}`;
                if (event.error === 'not-allowed') {
                    errorMessage = 'Microphone access denied. Please allow microphone access in your browser settings.';
                } else if (event.error === 'no-speech') {
                    console.log('No speech detected, recognition ended.');
                    if (finalTranscript.trim() === '') { userInput.value = ''; }
                    return; 
                } else if (event.error === 'network') {
                    errorMessage = 'Speech recognition network error. This often means a firewall, proxy, or browser extension is blocking access to Google\'s speech services. Please try disabling extensions or testing in incognito mode.';
                }
                alert(errorMessage); 
            };
        } else {
            console.warn('Web Speech API (SpeechRecognition) not supported in this browser. Voice input button will be hidden.');
            voiceInputBtn.style.display = 'none'; 
        }

        // --- API Call Function ---
        async function callGeminiAPI(payload) {
            if (GEMINI_API_KEY === "YOUR_GEMINI_API_KEY" || !GEMINI_API_KEY || GEMINI_API_KEY === "") { 
                throw new Error("API Key is not set or is the default placeholder. Please replace 'YOUR_GEMINI_API_KEY' in the script with your actual Gemini API key.");
            }

            let response;
            let result;
            let success = false;
            let retryCount = 0;
            const maxRetries = 3;
            let delay = 1000; 

            while (retryCount < maxRetries && !success) {
                try {
                    response = await fetch(API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) { 
                        if (retryCount < maxRetries - 1) {
                            console.warn(`API rate limit exceeded. Retrying in ${delay / 1000}s...`);
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2; 
                            retryCount++;
                        } else {
                            throw new Error('API rate limit exceeded. Please try again later.');
                        }
                    } else if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API error: ${response.status} ${response.statusText} - ${errorData.error?.message || 'Unknown error'}`);
                    } else {
                        result = await response.json();
                        success = true;
                    }
                } catch (err) {
                    if (retryCount < maxRetries - 1) {
                        console.warn(`Fetch error: ${err.message}. Retrying in ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                        retryCount++;
                    } else {
                        throw err; 
                    }
                }
            }
            
            if (result && result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                return result.candidates[0].content.parts[0].text;
            } else {
                throw new Error('Failed to get a valid response from the AI. No candidates found or content is empty.');
            }
        }

        // --- Autocomplete Functions ---
        function filterSuggestions(query) {
            if (!query) return [];
            const lowerQuery = query.toLowerCase();
            return autocompleteSuggestions.filter(s => s.toLowerCase().includes(lowerQuery));
        }

        function displaySuggestions(suggestions) {
            suggestionsList.innerHTML = '';
            suggestionsContainer.classList.add('hidden');
            selectedSuggestionIndex = -1;

            if (suggestions.length === 0) {
                return;
            }

            suggestions.forEach((suggestion, index) => {
                const li = document.createElement('li');
                li.textContent = suggestion;
                li.dataset.index = index;
                li.addEventListener('click', () => {
                    userInput.value = suggestion;
                    userInput.focus();
                    suggestionsContainer.classList.add('hidden');
                    userInput.style.height = 'auto'; 
                    userInput.style.height = userInput.scrollHeight + 'px';
                });
                suggestionsList.appendChild(li);
            });
            suggestionsContainer.classList.remove('hidden');
        }

        function navigateSuggestions(direction) {
            const items = Array.from(suggestionsList.children);
            if (items.length === 0) return;

            if (selectedSuggestionIndex !== -1) {
                items[selectedSuggestionIndex].classList.remove('selected');
            }

            if (direction === 'down') {
                selectedSuggestionIndex = (selectedSuggestionIndex + 1) % items.length;
            } else if (direction === 'up') {
                selectedSuggestionIndex = (selectedSuggestionIndex - 1 + items.length) % items.length;
            }

            items[selectedSuggestionIndex].classList.add('selected');
            items[selectedSuggestionIndex].scrollIntoView({ block: 'nearest' });
            userInput.value = items[selectedSuggestionIndex].textContent; // Auto-fill on arrow key
            userInput.style.height = 'auto'; 
            userInput.style.height = userInput.scrollHeight + 'px';
        }

        function selectCurrentSuggestion() {
            if (selectedSuggestionIndex !== -1) {
                const selectedText = suggestionsList.children[selectedSuggestionIndex].textContent;
                userInput.value = selectedText;
            }
            suggestionsContainer.classList.add('hidden');
            selectedSuggestionIndex = -1;
        }

        // --- New Chat Function ---
        function startNewChat() {
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
                isSpeaking = false;
                currentUtterance = null;
                document.querySelectorAll('.dictate-message-btn').forEach(btn => updateButtonIcon(btn, 'volume-2'));
            }

            chatHistoryDiv.innerHTML = ''; // Clear existing messages
            conversationHistory = []; // Reset conversation history
            chatAttachments = []; // Clear attachments
            chatImageUpload.value = ''; // Clear file input
            displayChatAttachments(); // Hide attachment preview
            userInput.value = '';
            userInput.style.height = 'auto'; 
            messageTextCache.clear(); // Clear message text cache
            suggestionsContainer.classList.add('hidden'); // Hide suggestions
            selectedSuggestionIndex = -1;

            // Add the initial AI message
            conversationHistory.push(initialAIMessage);
            appendChatMessage('ai', initialAIMessage.parts[0].text);
            
            userInput.focus();
        }


        // --- Event Listeners ---
        userInput.addEventListener('input', () => {
            userInput.style.height = 'auto'; 
            userInput.style.height = userInput.scrollHeight + 'px';

            const query = userInput.value;
            if (query.length > 0) {
                const suggestions = filterSuggestions(query);
                displaySuggestions(suggestions);
            } else {
                suggestionsContainer.classList.add('hidden');
            }
        });

        userInput.addEventListener('keydown', (e) => {
            if (suggestionsContainer.classList.contains('hidden')) return;

            if (e.key === 'ArrowDown') {
                e.preventDefault(); // Prevent cursor movement
                navigateSuggestions('down');
            } else if (e.key === 'ArrowUp') {
                e.preventDefault(); // Prevent cursor movement
                navigateSuggestions('up');
            } else if (e.key === 'Enter' && selectedSuggestionIndex !== -1) {
                e.preventDefault(); // Prevent new line or send
                selectCurrentSuggestion();
            } else if (e.key === 'Escape') {
                suggestionsContainer.classList.add('hidden');
                selectedSuggestionIndex = -1;
            }
        });

        userInput.addEventListener('blur', () => {
            // Delay hiding to allow click event on suggestion list
            setTimeout(() => {
                suggestionsContainer.classList.add('hidden');
                selectedSuggestionIndex = -1;
            }, 100); 
        });


        sendButton.addEventListener('click', async () => {
            const userMessage = userInput.value.trim();
            if (!userMessage && chatAttachments.length === 0) {
                return;
            }
            
            if (isVoiceInputActive && recognition) {
                recognition.stop();
            }

            const userParts = [];
            if (userMessage) {
                userParts.push({ text: userMessage });
            }
            for (const attachment of chatAttachments) {
                userParts.push({
                    inlineData: {
                        mimeType: attachment.mimeType,
                        data: attachment.data
                    }
                });
            }

            conversationHistory.push({ role: 'user', parts: userParts });
            appendChatMessage('user', userMessage, chatAttachments);
            
            userInput.value = '';
            userInput.style.height = 'auto'; 
            chatAttachments = [];
            chatImageUpload.value = ''; 
            displayChatAttachments(); 
            suggestionsContainer.classList.add('hidden'); // Hide suggestions on send
            selectedSuggestionIndex = -1;
            
            sendButton.disabled = true;
            
            toggleLoading(true);
            
            try {
                const payload = {
                    contents: conversationHistory,
                };
                
                const responseText = await callGeminiAPI(payload);
                
                conversationHistory.push({ role: 'model', parts: [{ text: responseText }] });
                appendChatMessage('ai', responseText);
                
            } catch (error) {
                console.error('Chat API call failed:', error);
                appendChatMessage('ai', `Oops! Something went wrong. Please try again. (${error.message})`);
            } finally {
                sendButton.disabled = false;
                toggleLoading(false);
                userInput.focus();
            }
        });
        
        userInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) { 
                e.preventDefault(); 
                // If a suggestion is selected, it will be handled by keydown on enter
                // Otherwise, send the message
                if (selectedSuggestionIndex === -1) {
                    sendButton.click();
                }
            }
        });

        chatImageUpload.addEventListener('change', async (event) => {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                for (const file of files) {
                    const allowedTypes = [
                        'image/', 'text/', 'application/pdf',
                        'application/json', 'text/csv', 'application/xml', 'text/markdown'
                    ];
                    const isAllowed = allowedTypes.some(type => file.type.startsWith(type)) || file.name.endsWith('.md');

                    if (isAllowed) {
                        if (file.size > 10 * 1024 * 1024) { 
                            alert(`File "${file.name}" is too large (>${10}MB). Max 10MB per file.`);
                            continue;
                        }
                        try {
                            const { mimeType, data } = await fileToBase64(file);
                            chatAttachments.push({ file, mimeType, data, name: file.name });
                        } catch (error) {
                            alert(`Failed to read chat file ${file.name}.`);
                            console.error('Chat file read error:', error);
                        }
                    } else {
                        alert(`File type not supported for chat: "${file.name}" (${file.type}).`);
                    }
                }
                displayChatAttachments();
                userInput.focus();
            }
            chatImageUpload.value = ''; 
        });

        chatAttachmentsPreviewContainer.addEventListener('click', (event) => {
            const removeBtn = event.target.closest('.remove-attachment-btn');
            if (removeBtn) {
                const attachmentDiv = removeBtn.closest('[data-index]');
                if (attachmentDiv) {
                    const index = parseInt(attachmentDiv.dataset.index);
                    chatAttachments.splice(index, 1); 
                    displayChatAttachments(); 
                    userInput.focus();
                }
            }
        });

        voiceInputBtn.addEventListener('click', () => {
            if (recognition) {
                if (isVoiceInputActive) {
                    recognition.stop(); 
                } else {
                    finalTranscript = ''; 
                    recognition.start();
                }
            } else {
                alert('Speech recognition is not supported in this browser.');
            }
        });

        chatbotContainer.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            chatbotContainer.classList.add('drag-over-active');
        });

        chatbotContainer.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            chatbotContainer.classList.remove('drag-over-active');
        });

        chatbotContainer.addEventListener('drop', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            chatbotContainer.classList.remove('drag-over-active');

            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                for (const file of files) {
                    const allowedTypes = [
                        'image/', 'text/', 'application/pdf',
                        'application/json', 'text/csv', 'application/xml', 'text/markdown'
                    ];
                    const isAllowed = allowedTypes.some(type => file.type.startsWith(type)) || file.name.endsWith('.md');

                    if (isAllowed) {
                         if (file.size > 10 * 1024 * 1024) { 
                            alert(`File "${file.name}" is too large (>${10}MB). Max 10MB per file.`);
                            continue;
                        }
                        try {
                            const { mimeType, data } = await fileToBase64(file);
                            chatAttachments.push({ file, mimeType, data, name: file.name });
                        } catch (error) {
                            alert(`Failed to read chat file ${file.name}.`);
                            console.error('Chat file read error:', error);
                        }
                    } else {
                        alert(`File type not supported for chat: "${file.name}" (${file.type}).`);
                    }
                }
                displayChatAttachments();
                userInput.focus();
            }
        });
        
        chatHistoryDiv.addEventListener('click', (event) => {
            const codeCopyButton = event.target.closest('.code-block-copy-button');
            if (codeCopyButton) {
                const targetId = codeCopyButton.dataset.copyTarget;
                const codeElement = document.getElementById(targetId);
                if (codeElement) {
                    const codeToCopy = codeElement.textContent;
                    updateButtonIcon(codeCopyButton, 'check', 'w-4 h-4'); 
                    copyToClipboard(codeToCopy); 
                    setTimeout(() => { 
                        updateButtonIcon(codeCopyButton, 'clipboard', 'w-4 h-4'); 
                    }, 2000);
                    return; 
                }
            }

            const chatCopyButton = event.target.closest('.copy-message-btn');
            if (chatCopyButton) {
                const messageId = chatCopyButton.dataset.messageId;
                const messageContent = messageTextCache.get(messageId);
                if (messageContent) {
                    updateButtonIcon(chatCopyButton, 'check');
                    copyToClipboard(messageContent); 
                    setTimeout(() => { 
                        updateButtonIcon(chatCopyButton, 'clipboard');
                    }, 2000);
                } else {
                    alert('Message content not found for copying.');
                }
                return; 
            }

            const dictateButton = event.target.closest('.dictate-message-btn');
            if (dictateButton) {
                const messageId = dictateButton.dataset.messageId;
                const messageContent = messageTextCache.get(messageId);
                if (messageContent) {
                    toggleSpeech(messageContent, dictateButton);
                } else {
                    alert('Message content not found for dictation.');
                }
                return; 
            }
        });

        // Event listener for the new chat button
        newChatBtn.addEventListener('click', startNewChat);

    </script>
</body>
</html>


--- END FILE: index.html ---

--- START FILE: manifest.json ---

{
  "name": "Mystic Vision AI Chat",
  "short_name": "Mystic Vision",
  "description": "Chat with Mystic Vision AI for insights and predictions.",
  "start_url": "./",
  "display": "standalone",
  "background_color": "#0C0C2F",
  "theme_color": "#C070FF",
  "icons": [
    {
      "src": "icons/icon-72x72.png",
      "sizes": "72x72",
      "type": "image/png"
    },
    {
      "src": "icons/icon-96x96.png",
      "sizes": "96x96",
      "type": "image/png"
    },
    {
      "src": "icons/icon-128x128.png",
      "sizes": "128x128",
      "type": "image/png"
    },
    {
      "src": "icons/icon-144x144.png",
      "sizes": "144x144",
      "type": "image/png"
    },
    {
      "src": "icons/icon-152x152.png",
      "sizes": "152x152",
      "type": "image/png"
    },
    {
      "src": "icons/icon-192x192.png",
      "sizes": "192x192",
      "type": "image/png"
    },
    {
      "src": "icons/icon-384x384.png",
      "sizes": "384x384",
      "type": "image/png"
    },
    {
      "src": "icons/icon-512x512.png",
      "sizes": "512x512",
      "type": "image/png"
    }
  ]
}

--- END FILE: manifest.json ---

--- START FILE: service-worker.js ---

const CACHE_NAME = 'mystic-vision-cache-v1';
const urlsToCache = [
    './',
    './index.html',
    './manifest.json',
    'https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Montserrat:wght@400;600&display=swap',
    'https://cdn.jsdelivr.net/npm/marked/marked.min.js',
    'https://cdn.jsdelivr.net/npm/lucide-dynamic@latest/dist/lucide.min.js',
    'https://unpkg.com/lucide@latest',
    // Assuming icons are in an 'icons' folder at the root
    './icons/icon-72x72.png',
    './icons/icon-96x96.png',
    './icons/icon-128x128.png',
    './icons/icon-144x144.png',
    './icons/icon-152x152.png',
    './icons/icon-192x192.png',
    './icons/icon-384x384.png',
    './icons/icon-512x512.png',
    // Add the logo image
    './logo.png'
];

self.addEventListener('install', (event) => {
    event.waitUntil(
        caches.open(CACHE_NAME)
            .then((cache) => {
                console.log('Opened cache');
                return cache.addAll(urlsToCache);
            })
    );
});

self.addEventListener('fetch', (event) => {
    // Cache-first strategy for static assets
    event.respondWith(
        caches.match(event.request)
            .then((response) => {
                // Cache hit - return response
                if (response) {
                    return response;
                }
                // No cache hit - fetch from network
                return fetch(event.request).then(
                    (response) => {
                        // Check if we received a valid response
                        if (!response || response.status !== 200 || response.type !== 'basic') {
                            return response;
                        }
                        // IMPORTANT: Clone the response. A response is a stream
                        // and can only be consumed once. We consume it once to cache it,
                        // and once the browser consumes it.
                        const responseToCache = response.clone();

                        caches.open(CACHE_NAME)
                            .then((cache) => {
                                cache.put(event.request, responseToCache);
                            });

                        return response;
                    }
                );
            })
    );
});

self.addEventListener('activate', (event) => {
    const cacheWhitelist = [CACHE_NAME];
    event.waitUntil(
        caches.keys().then((cacheNames) => {
            return Promise.all(
                cacheNames.map((cacheName) => {
                    if (cacheWhitelist.indexOf(cacheName) === -1) {
                        return caches.delete(cacheName);
                    }
                })
            );
        })
    );
});

--- END FILE: service-worker.js ---

--- START FILE: icons\image.py ---

from PIL import Image

img = Image.open("logo.png")
sizes = [72, 96, 128, 144, 152, 192, 384, 512] # Desired square sizes

for size in sizes:
    resized_img = img.resize((size, size))
    resized_img.save(f"icon_{size}x{size}.png")

--- END FILE: icons\image.py ---

----------------------------------------------------------------------------------------

while installing the web app to the desktop or mobile home screen there's no logo why?
how to fix it?
see the below example (here it's working fine). find the difference and fix it on the above project.

-------------------------------------------------------------------------------------------------------

{
  "name": "Dream11 Team Predictor",
  "short_name": "Dream11 AI",
  "description": "AI-powered Dream11 cricket team prediction and fantasy sports guidance.",
  "start_url": "./",
  "display": "standalone",
  "background_color": "#0a0a0f",
  "theme_color": "#1e88e5",
  "orientation": "portrait",
  "icons": [
    {
      "src": "logo.png",
      "sizes": "192x192",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "logo.png",
      "sizes": "512x512",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "logo.png",
      "sizes": "144x144",
      "type": "image/png",
      "purpose": "any maskable"
    },
    {
      "src": "logo.png",
      "sizes": "96x96",
      "type": "image/png",
      "purpose": "any maskable"
    }
  ]
}

--------------------------------------------------------------

const CACHE_NAME = 'dream11-predictor-v1';
const urlsToCache = [
    './',
    './index.html',
    './manifest.json',
    './logo.png',     // MAKE SURE YOU CREATE THIS FILE
    './favicon.ico',  // MAKE SURE YOU CREATE THIS FILE
    'https://cdn.tailwindcss.com',
    'https://cdn.jsdelivr.net/npm/marked/marked.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js',
    'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js',
    'https://cdn.jsdelivr.net/npm/lucide-dynamic@latest/dist/lucide.min.js',
    'https://unpkg.com/lucide@latest'
];

self.addEventListener('install', (event) => {
    event.waitUntil(
        caches.open(CACHE_NAME)
            .then((cache) => {
                console.log('Opened cache');
                return cache.addAll(urlsToCache);
            })
    );
});

self.addEventListener('fetch', (event) => {
    event.respondWith(
        caches.match(event.request)
            .then((response) => {
                // Cache hit - return response
                if (response) {
                    return response;
                }
                // Clone the request to make a network request
                const fetchRequest = event.request.clone();

                return fetch(fetchRequest).then(
                    (response) => {
                        // Check if we received a valid response
                        if (!response || response.status !== 200 || response.type !== 'basic') {
                            return response;
                        }

                        // Clone the response. A response is a stream
                        // and can only be consumed once.
                        const responseToCache = response.clone();

                        caches.open(CACHE_NAME)
                            .then((cache) => {
                                cache.put(event.request, responseToCache);
                            });

                        return response;
                    }
                );
            })
    );
});

// Optional: Clean up old caches
self.addEventListener('activate', (event) => {
    const cacheWhitelist = [CACHE_NAME];
    event.waitUntil(
        caches.keys().then((cacheNames) => {
            return Promise.all(
                cacheNames.map((cacheName) => {
                    if (cacheWhitelist.indexOf(cacheName) === -1) {
                        return caches.delete(cacheName);
                    }
                })
            );
        })
    );
});

-------------------------------------------------------------------

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dream11 Team Predictor</title>
    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <!-- Favicon -->
    <link rel="icon" href="logo.png" type="image/x-icon">
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts - Inter for modern typography -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <!-- Marked.js CDN for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- jsPDF for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- html2canvas to convert HTML to image for PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- Lucide Icons for a modern, futuristic feel -->
    <script src="https://cdn.jsdelivr.net/npm/lucide-dynamic@latest/dist/lucide.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        /*
         * --- Custom Styles for Dream11 Predictor (Enhanced) ---
         * This section enhances the Tailwind CSS with a modern, futuristic theme,
         * including a vibrant color palette, subtle animations, and improved
         * responsiveness and UI elements.
         */
        
        /* Basic font and transition settings for the whole page */
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.6s ease, color 0.6s ease;
            background-image: radial-gradient(at 0% 0%, hsl(240, 60%, 8%) 0%, transparent 50%),
                              radial-gradient(at 100% 100%, hsl(260, 50%, 8%) 0%, transparent 50%);
            background-size: 150% 150%;
            background-attachment: fixed;
        }

        /* Defining a vibrant color palette using CSS variables */
        :root {
            /* Light mode colors */
            --bg-color-light: #f3f4f6; /* Light gray */
            --card-bg-light: #ffffff; /* White */
            --text-color-light: #1f2937; /* Dark gray */
            --border-color-light: #e5e7eb; /* Light border gray */
            
            /* Dark mode colors */
            --bg-color-dark: #0a0a0f; /* Deep dark blue-black */
            --card-bg-dark: #13131a; /* Slightly lighter dark blue-black */
            --text-color-dark: #e5e7eb; /* Off-white */
            --border-color-dark: #2d3748; /* Darker blue-gray border */
            
            /* Accent colors for buttons, highlights, etc. */
            --accent-primary: #6366f1; /* Indigo-500 */
            --accent-primary-dark: #818cf8; /* Indigo-400 for dark mode */
            --accent-secondary: #22d3ee; /* Cyan-400 */
            --accent-secondary-dark: #67e8f9; /* Cyan-300 for dark mode */
            --accent-error: #ef4444; /* Red-500 */
            --accent-success: #22c55e; /* Green-500 */
        }
        
        /* Apply colors based on light or dark body class */
        body.light {
            background-color: var(--bg-color-light);
            color: var(--text-color-light);
            background-image: radial-gradient(at 0% 0%, hsl(210, 30%, 95%) 0%, transparent 50%),
                              radial-gradient(at 100% 100%, hsl(200, 20%, 90%) 0%, transparent 50%);
        }

        body.dark {
            background-color: var(--bg-color-dark);
            color: var(--text-color-dark);
        }

        /* Tailwind overrides for dark mode to ensure consistency */
        body.dark .bg-white { background-color: var(--card-bg-dark); }
        body.dark .bg-gray-50 { background-color: #1a1a2e; } /* Darker alternative to bg-gray-50 */
        body.dark .border-gray-100 { border-color: var(--border-color-dark); }
        body.dark .border-gray-200 { border-color: #3f3f46; } /* Deeper gray border */
        body.dark .text-gray-800 { color: var(--text-color-dark); }
        body.dark .text-gray-900 { color: var(--text-color-dark); }
        body.dark .text-gray-600 { color: #a1a1aa; } /* Gray 400 */
        body.dark .text-gray-700 { color: #d4d4d8; } /* Gray 300 */
        body.dark .bg-gray-200 { background-color: #3f3f46; color: #f4f4f5; }
        body.dark .hover\:bg-gray-300:hover { background-color: #52525b; }
        body.dark .bg-gray-100 { background-color: #27272a; }
        body.dark .shadow-2xl { box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.45); }
        body.dark #error-message { background-color: #fee2e2; color: #b91c1c; } /* Light red error for contrast */

        /* Custom styles for glowing effects on buttons and borders */
        .glow-button {
            position: relative;
            z-index: 10;
            transition: all 0.4s ease;
            box-shadow: 0 0 10px var(--accent-primary);
        }
        .glow-button:hover {
            box-shadow: 0 0 15px var(--accent-primary), 0 0 25px var(--accent-primary), 0 0 35px var(--accent-primary);
            transform: translateY(-2px) scale(1.02);
            background-image: linear-gradient(to right, var(--accent-primary), var(--accent-primary-dark));
        }
        body.dark .glow-button {
            box-shadow: 0 0 10px var(--accent-primary-dark);
        }
        body.dark .glow-button:hover {
            box-shadow: 0 0 15px var(--accent-primary-dark), 0 0 25px var(--accent-primary-dark), 0 0 35px var(--accent-primary-dark);
            background-image: linear-gradient(to right, var(--accent-primary-dark), var(--accent-primary));
        }
        
        .glow-border {
            box-shadow: 0 0 15px rgba(99, 102, 241, 0.3); /* Slightly softer glow */
            border: 1px solid rgba(99, 102, 241, 0.2);
            transition: all 0.5s ease;
        }
        body.dark .glow-border {
            box-shadow: 0 0 20px rgba(129, 140, 248, 0.25);
            border: 1px solid rgba(129, 140, 248, 0.15);
        }
        
        /* Markdown content styling for better readability */
        .markdown-content h1, .markdown-content h2, .markdown-content h3 { font-weight: 800; margin-bottom: 0.75em; margin-top: 1.5em; line-height: 1.2; color: var(--accent-primary); }
        body.dark .markdown-content h1, body.dark .markdown-content h2, body.dark .markdown-content h3 { color: var(--accent-primary-dark); }
        .markdown-content h1 { font-size: 2.25rem; }
        .markdown-content h2 { font-size: 1.875rem; }
        .markdown-content h3 { font-size: 1.5rem; }
        .markdown-content ul, .markdown-content ol { list-style-position: inside; margin-left: 1.5em; margin-bottom: 1em; }
        .markdown-content li { margin-bottom: 0.5em; }
        .markdown-content strong { color: var(--accent-secondary); font-weight: 700; }
        body.dark .markdown-content strong { color: var(--accent-secondary-dark); }
        .markdown-content p { margin-bottom: 1em; } /* Ensure paragraphs have spacing */
        .markdown-content p:last-child { margin-bottom: 0; }

        /* Custom styles for dark mode toggle switch */
        .slider {
            background-color: #d1d5db;
            transition: .4s;
        }
        .dark .slider {
            background-color: #4b5563;
        }
        .slider:before {
            background-color: white;
            transition: .4s;
        }
        input:checked + .slider {
            background-color: var(--accent-primary);
        }
        input:checked + .slider:before {
            transform: translateX(24px);
        }

        /* Custom scrollbar for a sleek look */
        #chat-history::-webkit-scrollbar { width: 10px; }
        #chat-history::-webkit-scrollbar-track { background: var(--card-bg-light); border-radius: 5px; }
        #chat-history::-webkit-scrollbar-thumb { background: #888; border-radius: 5px; border: 2px solid var(--card-bg-light); }
        #chat-history::-webkit-scrollbar-thumb:hover { background: #555; }
        .dark #chat-history::-webkit-scrollbar-track { background: var(--card-bg-dark); }
        .dark #chat-history::-webkit-scrollbar-thumb { background: #6b7280; border-color: var(--card-bg-dark); }
        .dark #chat-history::-webkit-scrollbar-thumb:hover { background: #9ca3af; }
        
        /* Modern loading animation */
        .loader-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }
        .loader-dot {
            width: 12px;
            height: 12px;
            margin: 0 4px;
            background-color: var(--accent-primary);
            border-radius: 50%;
            display: inline-block;
            animation: bounce 1.4s infinite ease-in-out both;
        }
        .loader-dot:nth-child(1) { animation-delay: -0.32s; }
        .loader-dot:nth-child(2) { animation-delay: -0.16s; }
        .loader-dot:nth-child(3) { animation-delay: 0s; }
        
        @keyframes bounce {
            0%, 80%, 100% {
                transform: scale(0);
                opacity: 0.5;
            }
            40% {
                transform: scale(1.0);
                opacity: 1;
            }
        }

        /* Animation for upload cloud icon */
        @keyframes pulse-grow-shrink {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.7; }
        }
        .animate-pulse-grow-shrink {
            animation: pulse-grow-shrink 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        
        /* Floating Chat Popup styles */
        #chat-popup-container {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            z-index: 50;
        }

        /* Floating button style with text and icon */
        #chat-toggle-button {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0.75rem 1.5rem;
            border-radius: 9999px; /* full rounded */
            box-shadow: 0 0 10px var(--accent-secondary);
            background-color: var(--accent-secondary);
            color: white;
            font-weight: bold;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            animation: pulse-glow 2s infinite cubic-bezier(0.4, 0, 0.6, 1);
        }
        #chat-toggle-button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px var(--accent-secondary), 0 0 25px var(--accent-secondary), 0 0 35px var(--accent-secondary);
        }

        @keyframes pulse-glow {
            0%, 100% { box-shadow: 0 0 10px var(--accent-secondary); }
            50% { box-shadow: 0 0 20px var(--accent-secondary), 0 0 30px var(--accent-secondary); }
        }
        
        #chat-popup-window {
            /* Adjusted for better responsiveness */
            width: 100%;
            max-width: 400px;
            height: 500px;
            max-height: 80vh;
            display: flex;
            flex-direction: column;
            background-color: rgba(255, 255, 255, 0.9); /* Slightly transparent white */
            border-radius: 1.5rem; /* 24px */
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            border: 1px solid rgba(229, 231, 235, 0.7); /* Slightly transparent border */
            transition: all 0.3s ease-in-out;
            transform-origin: bottom right;
            backdrop-filter: blur(8px); /* Frosted glass effect */
            -webkit-backdrop-filter: blur(8px); /* Safari support */
        }

        /* Dark mode specific for the chat popup */
        body.dark #chat-popup-window {
            background-color: rgba(19, 19, 26, 0.9); /* Slightly transparent dark */
            border-color: rgba(45, 55, 72, 0.7);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.45);
        }
        
        /* New classes for animation */
        .chat-hidden {
            opacity: 0;
            transform: scale(0.8);
            visibility: hidden;
            pointer-events: none;
        }
        .chat-visible {
            opacity: 1;
            transform: scale(1);
            visibility: visible;
            pointer-events: auto;
        }

        /* Responsive adjustments for the floating chat */
        @media (max-width: 768px) {
            #chat-popup-container {
                /* On small screens, move the button closer to the corner */
                bottom: 1rem;
                right: 1rem;
            }
            #chat-popup-window {
                /* On small screens, the popup should be bigger */
                bottom: 1rem;
                right: 1rem;
                width: calc(100vw - 2rem);
                max-width: none; /* Override max-width for full screen-ish size */
                height: calc(100vh - 2rem);
            }
            /* Hide text on floating button on smaller screens */
            #chat-toggle-button span:not([data-lucide]) { /* Target the text span */
                display: none;
            }
            #chat-toggle-button {
                padding: 0.75rem; /* Make the button a square */
            }
        }
        
        /* New chat message styles */
        .chat-message {
            margin-bottom: 0.75rem; /* 12px */
            padding: 1rem; /* 16px */
            border-radius: 1.5rem; /* 24px */
            box-shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px 0 rgba(0, 0, 0, 0.06);
            word-break: break-word; /* Ensure long words break */
            transition: all 0.3s ease;
            transform: scale(0.95);
            transform-origin: bottom;
            max-width: 85%;
            position: relative; /* For action buttons */
            padding-bottom: 2.5rem; /* Make space for action buttons */
        }

        .chat-message.user {
            background-color: #e0f2fe; /* Light blue */
            color: #1e40af; /* Dark blue */
            margin-left: auto;
            border-bottom-right-radius: 0.5rem; /* 8px */
            background-image: linear-gradient(to bottom right, #e0f2fe, #bfdbfe); /* Subtle gradient */
        }
        body.dark .chat-message.user {
            background-color: #1a237e; /* Darker blue */
            color: #e0e7ff; /* Lighter blue */
            background-image: linear-gradient(to bottom right, #1a237e, #312e81);
        }

        .chat-message.ai {
            background-color: #f3f4f6; /* Light gray */
            color: #374151; /* Dark gray */
            margin-right: auto;
            border-bottom-left-radius: 0.5rem; /* 8px */
            background-image: linear-gradient(to bottom left, #f3f4f6, #e5e7eb); /* Subtle gradient */
        }
        body.dark .chat-message.ai {
            background-color: #2d3748; /* Darker gray */
            color: #f9fafb; /* Lighter gray */
            background-image: linear-gradient(to bottom left, #2d3748, #475569);
        }

        /* Styling for chat attachments */
        .chat-image {
            max-width: 100%;
            height: auto;
            border-radius: 0.75rem;
            margin-top: 0.5rem;
            display: block;
        }
        .chat-attachment-preview-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 1rem;
            background-color: #e0e7ff; /* Light indigo */
            color: #3730a3; /* Dark indigo */
            font-size: 0.875rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.08);
            transition: all 0.2s ease;
        }
        body.dark .chat-attachment-preview-item {
            background-color: #3730a3; /* Dark indigo */
            color: #e0e7ff; /* Light indigo */
        }
        .chat-attachment-preview-item .remove-attachment-btn {
            background: none;
            border: none;
            color: #6366f1; /* Indigo */
            cursor: pointer;
            padding: 0.1rem;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        body.dark .chat-attachment-preview-item .remove-attachment-btn {
            color: #a5b4fc; /* Light indigo */
        }
        .chat-attachment-preview-item .remove-attachment-btn:hover {
            background-color: rgba(99, 102, 241, 0.2);
        }
        body.dark .chat-attachment-preview-item .remove-attachment-btn:hover {
            background-color: rgba(165, 180, 252, 0.2);
        }

        /* Styling for the copy message */
        #copy-message {
            position: fixed;
            bottom: 6rem;
            left: 50%;
            transform: translateX(-50%);
            padding: 0.75rem 1.5rem;
            background-color: var(--accent-success);
            color: white;
            border-radius: 9999px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease-in-out;
            z-index: 100;
        }

        #copy-message.show {
            opacity: 1;
            visibility: visible;
        }

        /* --- New/Enhanced Styles for Chat AI Responses & Code Blocks --- */
        
        .chat-message .message-content {
            /* This wrapper is to facilitate better styling around markdown content */
            padding: 0; /* Markdown adds its own spacing, so zero here */
            margin: 0;
        }
        
        /* General markdown styling within AI messages */
        .chat-message.ai .message-content p,
        .chat-message.ai .message-content ul,
        .chat-message.ai .message-content ol,
        .chat-message.ai .message-content h1,
        .chat-message.ai .message-content h2,
        .chat-message.ai .message-content h3,
        .chat-message.ai .message-content blockquote {
            margin-bottom: 1em;
        }
        .chat-message.ai .message-content p:last-child,
        .chat-message.ai .message-content ul:last-child,
        .chat-message.ai .message-content ol:last-child,
        .chat-message.ai .message-content blockquote:last-child {
            margin-bottom: 0;
        }
        .chat-message.ai .message-content ul,
        .chat-message.ai .message-content ol {
            padding-left: 1.5em; /* Standard list indent */
        }
        .chat-message.ai .message-content li {
            margin-bottom: 0.5em;
        }
        .chat-message.ai .message-content strong {
            font-weight: bold;
            color: var(--accent-primary); /* Use primary accent for emphasis */
        }
        body.dark .chat-message.ai .message-content strong {
            color: var(--accent-primary-dark);
        }
        .chat-message.ai .message-content em {
            font-style: italic;
        }
        .chat-message.ai .message-content blockquote {
            border-left: 4px solid var(--accent-secondary);
            padding-left: 1em;
            margin-left: 0;
            color: #555;
        }
        body.dark .chat-message.ai .message-content blockquote {
             color: #a1a1aa; /* Gray 400 */
             border-left: 4px solid var(--accent-secondary-dark);
        }

        /* Code block specific styling */
        .code-block-container {
            position: relative;
            background-color: #27272a; /* Dark background for code */
            color: #f8f8f2; /* Light text color for code */
            border-radius: 0.75rem; /* Rounded corners */
            margin-top: 1rem;
            margin-bottom: 1rem;
            overflow: hidden; /* Ensure rounded corners clip content */
            border: 1px solid #3f3f46; /* Subtle border */
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
        }
        
        .code-block-container pre {
            margin: 0; /* Remove default margin from pre */
            padding: 1rem;
            overflow-x: auto; /* Horizontal scroll for long lines */
            font-family: 'Fira Code', 'Cascadia Code', 'Consolas', monospace; /* Monospaced font */
            font-size: 0.9em;
            line-height: 1.4;
        }

        .code-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: #374151; /* Header background */
            color: #d1d5db; /* Header text */
            padding: 0.5rem 1rem;
            border-bottom: 1px solid #4b5563;
            font-size: 0.85em;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
        }

        .code-block-copy-button {
            background-color: transparent;
            border: none;
            color: #d1d5db;
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease, color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.85em;
        }
        .code-block-copy-button:hover {
            background-color: #4b5563;
            color: white;
        }
        .code-block-copy-button:active {
            transform: scale(0.95);
        }

        /* Smallest font size for inline code blocks if any */
        .chat-message.ai .message-content code:not(pre > code) {
            background-color: rgba(100, 116, 139, 0.2); /* slategray-200 with transparency */
            border-radius: 0.25rem;
            padding: 0.2em 0.4em;
            font-family: 'Fira Code', 'Cascadia Code', 'Consolas', monospace;
            font-size: 0.9em;
            color: #5b21b6; /* deep violet for inline code */
        }
        body.dark .chat-message.ai .message-content code:not(pre > code) {
            background-color: rgba(100, 116, 139, 0.4);
            color: #a78bfa; /* violet-400 */
        }

        /* Ensure links are distinguishable */
        .chat-message.ai .message-content a {
            color: var(--accent-primary);
            text-decoration: underline;
            transition: color 0.2s ease;
        }
        .chat-message.ai .message-content a:hover {
            color: #0d47a1; /* Darker blue on hover */
        }
        body.dark .chat-message.ai .message-content a {
            color: #60a5fa; /* Blue-400 */
        }
        body.dark .chat-message.ai .message-content a:hover {
            color: #93c5fd; /* Blue-300 */
        }

        /* Styles for message action buttons (copy/dictate) */
        .message-actions {
            position: absolute;
            bottom: 0.5rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            padding: 0.25rem 0.5rem;
            background-color: rgba(255, 255, 255, 0.6); /* Semi-transparent background */
            border-radius: 0.75rem;
            backdrop-filter: blur(5px); /* Frosted glass effect */
            transition: opacity 0.3s ease;
            opacity: 0; /* Hidden by default */
            z-index: 10;
        }

        .chat-message:hover .message-actions {
            opacity: 1; /* Show on message hover */
        }

        body.dark .message-actions {
            background-color: rgba(0, 0, 0, 0.4);
        }

        .message-actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease, color 0.2s ease;
            display: flex; /* To center icon */
            align-items: center;
            justify-content: center;
        }

        .message-actions button .lucide { /* Target the SVG element directly for color */
            color: #6b7280; /* Gray 500 */
            width: 1rem;
            height: 1rem;
        }
        body.dark .message-actions button .lucide {
            color: #9ca3af; /* Gray 400 */
        }

        .message-actions button:hover .lucide {
            color: #1f2937; /* Gray 900 */
        }
        body.dark .message-actions button:hover .lucide {
            color: #e5e7eb; /* Gray 200 */
        }
        .message-actions button:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        body.dark .message-actions button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .chat-message.user .message-actions {
            right: 1rem;
            left: auto;
        }
        .chat-message.ai .message-actions {
            left: 1rem;
            right: auto;
        }

        /* New style for speech recognition button when active */
        .voice-input-active {
            background-color: var(--accent-error) !important; /* Red when recording */
            animation: pulse-red 1s infinite cubic-bezier(0.4, 0, 0.6, 1);
        }

        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }

        /* Styles for the hidden PDF export template */
        #pdf-export-content {
            display: none; /* Hidden by default */
            width: 210mm; /* A4 width */
            min-height: 297mm; /* A4 height, ensures at least one page worth of content */
            padding: 20mm; /* Margins */
            box-sizing: border-box; /* Include padding in width/height */
            font-family: 'Inter', sans-serif;
            color: #333;
            background: white;
            flex-direction: column; /* Ensure content flows vertically */
            justify-content: space-between; /* Push header/footer to ends */
        }

        #pdf-export-content .pdf-header {
            text-align: center;
            margin-bottom: 20mm;
            border-bottom: 2px solid #6366f1; /* Indigo */
            padding-bottom: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }
        #pdf-export-content .pdf-header h1 {
            font-size: 28px;
            font-weight: bold;
            color: #6366f1; /* Indigo */
            margin: 0;
            line-height: 1;
        }
        #pdf-export-content .pdf-header p {
            font-size: 14px;
            color: #666;
            margin-top: 5px;
        }
        #pdf-export-content .pdf-header .lucide {
            width: 32px;
            height: 32px;
            color: #6366f1; /* Indigo */
        }

        #pdf-export-content .pdf-body {
            flex-grow: 1; /* Allow body to take up remaining space */
            font-size: 12px;
            line-height: 1.6;
        }

        #pdf-export-content .pdf-body h1,
        #pdf-export-content .pdf-body h2,
        #pdf-export-content .pdf-body h3 {
            font-weight: bold;
            margin-bottom: 0.5em;
            margin-top: 1em;
            line-height: 1.2;
            color: #6366f1; /* Indigo */
        }
        #pdf-export-content .pdf-body h1 { font-size: 24px; }
        #pdf-export-content .pdf-body h2 { font-size: 20px; }
        #pdf-export-content .pdf-body h3 { font-size: 16px; }
        #pdf-export-content .pdf-body ul,
        #pdf-export-content .pdf-body ol {
            list-style-position: outside; /* Ensure bullets are visible */
            margin-left: 2em;
            margin-bottom: 1em;
            padding: 0;
        }
        #pdf-export-content .pdf-body li {
            margin-bottom: 0.3em;
        }
        #pdf-export-content .pdf-body strong {
            font-weight: bold;
            color: #22c55e; /* Green accent */
        }
        #pdf-export-content .pdf-body a {
            color: #6366f1;
            text-decoration: underline;
        }
        #pdf-export-content .pdf-body blockquote {
            border-left: 4px solid #ccc;
            padding-left: 1em;
            margin-left: 0;
            color: #555;
            font-style: italic;
        }

        /* PDF Code block styling - adjusted for print */
        #pdf-export-content .code-block-container {
            background-color: #f8f8f2; /* Lighter background for print */
            color: #333;
            border-radius: 0.5rem;
            margin-top: 1rem;
            margin-bottom: 1rem;
            overflow: hidden;
            border: 1px solid #ddd;
            box-shadow: none; /* No shadows in PDF */
        }
        #pdf-export-content .code-block-container pre {
            padding: 0.8rem;
            font-size: 10px;
            line-height: 1.3;
        }
        #pdf-export-content .code-block-header {
            background-color: #eee;
            color: #555;
            padding: 0.4rem 0.8rem;
            border-bottom: 1px solid #ddd;
            font-size: 0.8em;
            display: flex; /* Re-enable flex for header elements like language */
            justify-content: space-between;
            align-items: center;
        }
        #pdf-export-content .code-block-copy-button { /* Hide copy button in PDF */
            display: none;
        }
        #pdf-export-content .pdf-footer {
            text-align: center;
            margin-top: 20mm;
            border-top: 1px solid #eee;
            padding-top: 10px;
            font-size: 10px;
            color: #999;
        }

        /* Chat action buttons dropdown */
        .chat-actions-dropdown {
            position: absolute;
            bottom: calc(100% + 8px); /* Position above the input bar */
            right: 0; /* Align with the parent's right edge */
            background-color: var(--card-bg-light);
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            padding: 0.5rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            transform-origin: bottom right;
            transition: transform 0.2s ease-out, opacity 0.2s ease-out;
            z-index: 20;
            border: 1px solid var(--border-color-light);
            min-width: 140px; /* Adjust as needed */
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
        }
        body.dark .chat-actions-dropdown {
            background-color: var(--card-bg-dark);
            border-color: var(--border-color-dark);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        .chat-actions-dropdown.hidden {
            opacity: 0;
            transform: scale(0.9);
            pointer-events: none;
        }
        .chat-actions-dropdown button,
        .chat-actions-dropdown label {
            display: flex;
            align-items: center;
            padding: 0.5rem 0.75rem;
            border-radius: 0.75rem;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            color: var(--text-color-light); /* Default text color */
        }
        body.dark .chat-actions-dropdown button,
        body.dark .chat-actions-dropdown label {
            color: var(--text-color-dark);
        }
        .chat-actions-dropdown button:hover,
        .chat-actions-dropdown label:hover {
            background-color: var(--bg-color-light); /* Lighter hover for light theme */
        }
        body.dark .chat-actions-dropdown button:hover,
        body.dark .chat-actions-dropdown label:hover {
            background-color: #1a1a2e; /* Darker hover for dark theme */
        }
        .chat-actions-dropdown button .lucide,
        .chat-actions-dropdown label .lucide {
            margin-right: 0.5rem;
            width: 1.25rem;
            height: 1.25rem;
            flex-shrink: 0;
            color: var(--accent-primary); /* Use primary accent for icons */
        }
        body.dark .chat-actions-dropdown button .lucide,
        body.dark .chat-actions-dropdown label .lucide {
            color: var(--accent-primary-dark);
        }

        /* Drag and Drop visual feedback for chat window */
        #chat-popup-window.drag-over-active {
            border: 2px dashed var(--accent-primary);
            box-shadow: 0 0 20px var(--accent-primary), 0 0 30px var(--accent-primary) inset;
        }
        body.dark #chat-popup-window.drag-over-active {
            border: 2px dashed var(--accent-primary-dark);
            box-shadow: 0 0 20px var(--accent-primary-dark), 0 0 30px var(--accent-primary-dark) inset;
        }

    </style>
</head>
<body class="antialiased dark">

    <!-- Main container with fluid padding for responsiveness -->
    <div class="container mx-auto p-4 md:p-8 lg:p-12 min-h-screen flex items-start justify-center">
        <div class="bg-white rounded-3xl shadow-2xl p-6 md:p-10 lg:p-12 border border-gray-100 transition-colors duration-300 w-full max-w-6xl glow-border">
            
            <!-- Header Section with Dark Mode Toggle -->
            <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-10">
                <div class="text-left mb-4 md:mb-0">
                    <h1 class="text-4xl md:text-5xl lg:text-6xl font-extrabold text-gray-900 tracking-tight">
                        Dream11 Predictor <span class="text-indigo-500">⚡</span>
                    </h1>
                    <p class="text-lg md:text-xl text-gray-600 mt-2">
                        Analyze data and craft your winning team with AI.
                    </p>
                </div>
                <div class="flex items-center space-x-2 mt-4 md:mt-0">
                    <span class="text-gray-500 text-sm">Light</span>
                    <label class="switch relative inline-block w-14 h-8">
                        <input type="checkbox" id="dark-mode-toggle" class="opacity-0 w-0 h-0">
                        <span class="slider absolute cursor-pointer top-0 left-0 right-0 bottom-0 rounded-full before:absolute before:content-[''] before:h-6 before:w-6 before:left-1 before:bottom-1 before:rounded-full"></span>
                    </label>
                    <span class="text-gray-500 text-sm">Dark</span>
                </div>
            </div>

            <!-- Disclaimer for Fantasy Sports Risks -->
            <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 rounded-md" role="alert">
                <p class="font-bold">Disclaimer:</p>
                <p class="text-sm">Fantasy sports involve an element of financial risk and may be addictive. Please play responsibly and at your own risk. The predictions and advice provided by this AI are based on available data and are for informational purposes only. They do not guarantee financial winnings or success in fantasy contests.</p>
            </div>


            <!-- Main Content Area with responsive columns -->
            <div class="flex flex-col gap-8">
                <!-- Prediction Output -->
                <div class="flex-1">
                    
                    <!-- Upload and Preview Section -->
                    <div id="upload-area" class="bg-gray-50 rounded-2xl p-6 sm:p-8 mb-4 border-2 border-dashed border-gray-200 transition-all duration-300 hover:bg-gray-100 hover:border-indigo-400">
                        <label for="image-upload" class="cursor-pointer block">
                            <div class="flex flex-col items-center justify-center p-4 sm:p-6 text-center">
                                <span data-lucide="upload-cloud" class="w-12 h-12 sm:w-14 sm:h-14 text-indigo-500 animate-pulse-grow-shrink"></span>
                                <p class="mt-4 text-sm text-gray-600">
                                    <span class="font-semibold text-indigo-600 hover:text-indigo-700 transition-colors">
                                        Click to upload
                                    </span>
                                    or drag and drop your image(s)
                                </p>
                                <p class="text-xs text-gray-500 mt-1">PNG, JPG up to 10MB per image</p>
                            </div>
                        </label>
                        <input type="file" id="image-upload" accept="image/*" class="hidden" multiple>
                        <p class="text-xs text-gray-500 mt-4 text-center">
                            <span data-lucide="info" class="w-4 h-4 inline-block align-text-bottom mr-1"></span> For best predictions, upload screenshots with player stats, recent form, team news, and pitch reports.
                        </p>
                    </div>

                    <div id="preview-container" class="mb-4 hidden transition-opacity duration-300">
                        <h2 class="text-lg sm:text-xl font-bold mb-4 text-gray-700 dark:text-gray-300">Image Preview(s):</h2>
                        <div id="image-previews" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 xl:grid-cols-6 gap-4">
                            <!-- Image previews will be dynamically added here -->
                        </div>
                    </div>

                    <!-- Action and Status Buttons -->
                    <div class="flex flex-col sm:flex-row gap-4 mb-8">
                        <button id="analyze-btn" class="flex-1 py-3 px-6 sm:py-4 sm:px-8 rounded-full bg-indigo-600 text-white font-bold shadow-lg focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-all duration-300 disabled:bg-indigo-400 disabled:cursor-not-allowed transform hover:scale-105 glow-button" style="--accent-primary: #6366f1; --accent-primary-dark: #818cf8;">
                            Analyze and Predict
                        </button>
                        <button id="clear-btn" class="flex-1 py-3 px-6 sm:py-4 sm:px-8 rounded-full bg-gray-200 text-gray-800 font-bold shadow-lg hover:bg-gray-300 dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600 focus:outline-none focus:ring-4 focus:ring-gray-400 transition-all duration-300 transform hover:scale-105">
                            Clear All
                        </button>
                    </div>

                    <!-- AI Response Section -->
                    <div id="results-container" class="hidden transition-opacity duration-300">
                        <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-700 dark:text-gray-300 border-b-2 border-indigo-500 dark:border-indigo-400 pb-2">AI's Dream11 Prediction:</h2>
                        <div id="loading-indicator" class="hidden text-center text-gray-500 text-sm py-8">
                             <!-- Modern loader animation -->
                             <div class="loader-container">
                                <div class="loader-dot"></div>
                                <div class="loader-dot"></div>
                                <div class="loader-dot"></div>
                             </div>
                            <span class="mt-4 block">Analyzing the image(s) and generating the team...</span>
                        </div>
                        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-6 py-4 rounded-xl relative shadow-md" role="alert">
                            <span class="block sm:inline" id="error-text"></span>
                        </div>
                        <div id="prediction-output" class="p-6 bg-gray-100 rounded-xl border border-gray-200 text-base shadow-inner markdown-content dark:bg-gray-800 dark:border-gray-700"></div>
                        
                        <!-- New buttons for PDF and Text Export -->
                        <div id="export-buttons" class="mt-4 flex flex-col sm:flex-row gap-4 hidden">
                            <button id="save-pdf-btn" class="flex-1 py-3 px-6 sm:py-4 sm:px-8 rounded-full bg-green-500 text-white font-bold shadow-lg hover:bg-green-600 focus:outline-none focus:ring-4 focus:ring-green-300 transition-all duration-300 transform hover:scale-105">
                                <span data-lucide="file-text" class="w-5 h-5 mr-2 inline-block"></span> Save as PDF
                            </button>
                            <button id="share-text-btn" class="flex-1 py-3 px-6 sm:py-4 sm:px-8 rounded-full bg-blue-500 text-white font-bold shadow-lg hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-blue-300 transition-all duration-300 transform hover:scale-105">
                                <span data-lucide="share-2" class="w-5 h-5 mr-2 inline-block"></span> Share as Text
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Floating Chat Popup -->
    <div id="chat-popup-container">
        <!-- Floating button to open the chat -->
        <button id="chat-toggle-button" class="group">
            <span data-lucide="message-square" class="w-6 h-6 text-white transition-transform duration-300 group-hover:rotate-12"></span>
            <span class="ml-2">Chat with AI</span>
        </button>

        <!-- The actual chat popup window -->
        <div id="chat-popup-window" class="chat-hidden fixed bottom-24 right-4 md:right-8 lg:right-12 flex-col">
            <!-- Header for the chat popup -->
            <div class="flex justify-between items-center p-4 border-b border-gray-200 dark:border-gray-700 rounded-t-2xl bg-gray-50 dark:bg-gray-800">
                <h2 class="text-lg font-bold text-gray-800 dark:text-gray-200">Chat with AI</h2>
                <button id="chat-close-button" aria-label="Close Chat" class="text-gray-500 hover:text-gray-900 dark:hover:text-white transition-colors p-1 rounded-full hover:bg-gray-200 dark:hover:bg-gray-700">
                    <span data-lucide="x" class="w-6 h-6"></span>
                </button>
            </div>
            
            <!-- Chat history div with a minimum height and scroll -->
            <div id="chat-history" class="p-4 overflow-y-auto flex-1 flex flex-col">
                <!-- Chat messages will be appended here -->
            </div>
            
            <!-- Chat input section with attachment, voice and send button -->
            <div class="p-4 border-t border-gray-200 dark:border-gray-700 relative">
                <!-- Attachment preview -->
                <div id="chat-attachments-preview-container" class="mb-2 flex flex-wrap items-center gap-2 hidden">
                    <!-- Attachments previews will be dynamically added here -->
                </div>

                <!-- Dropdown for attachment/voice buttons -->
                <div id="chat-actions-dropdown" class="chat-actions-dropdown hidden">
                    <button id="voice-input-btn" class="w-full justify-start text-left">
                        <span data-lucide="mic" class="w-5 h-5"></span> Voice Input
                    </button>
                    <label for="chat-image-upload" class="w-full justify-start text-left">
                        <span data-lucide="paperclip" class="w-5 h-5"></span> Attach File
                    </label>
                    <input type="file" id="chat-image-upload" accept="image/*, .txt, .pdf, .csv, .json, .xml, .md" class="hidden" multiple>
                </div>

                <div class="flex gap-2 items-end">
                    <input type="text" id="chat-input" class="flex-1 p-3 rounded-full border border-gray-300 focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition-colors shadow-sm dark:bg-gray-700 dark:border-gray-600 dark:text-white" placeholder="Ask a follow-up question...">
                    
                    <button id="add-chat-attachment-btn" aria-label="Add attachment or voice input" class="flex items-center justify-center w-12 h-12 rounded-full bg-gray-200 text-gray-600 dark:bg-gray-700 dark:text-gray-200 shadow-lg hover:bg-gray-300 dark:hover:bg-gray-600 cursor-pointer transition-all duration-300 flex-shrink-0">
                        <span data-lucide="plus" class="w-5 h-5"></span>
                    </button>

                    <button id="send-chat-btn" aria-label="Send Message" class="flex items-center justify-center w-12 h-12 rounded-full bg-indigo-600 text-white shadow-lg focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-all duration-300 disabled:bg-indigo-400 disabled:cursor-not-allowed glow-button flex-shrink-0" style="--accent-primary: #6366f1; --accent-primary-dark: #818cf8;">
                        <span data-lucide="send" class="w-5 h-5"></span>
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Temporary message for clipboard copy -->
    <div id="copy-message">Text copied to clipboard!</div>

    <!-- Hidden div for PDF export template -->
    <div id="pdf-export-content" style="display: none;">
        <div class="pdf-header">
            <span data-lucide="trophy" class="w-8 h-8"></span>
            <h1>Dream11 Team Prediction</h1>
            <p>Generated on <span id="pdf-date"></span></p>
        </div>
        <div class="pdf-body">
            <!-- Prediction output will be inserted here -->
        </div>
        <div class="pdf-footer">
            Powered by Gemini AI | Dream11 Predictor
        </div>
    </div>


    <script type="text/javascript">
        // Register Service Worker for PWA capabilities
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/sw.js')
                    .then(registration => {
                        console.log('ServiceWorker registration successful with scope: ', registration.scope);
                    })
                    .catch(err => {
                        console.log('ServiceWorker registration failed: ', err);
                    });
            });
        }

        // JavaScript for handling image upload, API call, and chat functionality
        
        // This function call is from the Lucide Icon library to replace all `<span>` tags with the corresponding SVG icons
        // It should be called any time new Lucide icon elements are added to the DOM.
        const createIcons = () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        };

        window.addEventListener('load', () => {
             // Create icons on initial page load for the main UI
             createIcons();
        });

        const uploadArea = document.getElementById('upload-area');
        const imageUpload = document.getElementById('image-upload');
        const imagePreviewsContainer = document.getElementById('image-previews'); 
        const previewContainer = document.getElementById('preview-container');
        const analyzeBtn = document.getElementById('analyze-btn');
        const clearBtn = document.getElementById('clear-btn');
        const loadingIndicator = document.getElementById('loading-indicator');
        const resultsContainer = document.getElementById('results-container');
        const predictionOutput = document.getElementById('prediction-output');
        const exportButtons = document.getElementById('export-buttons');
        const savePdfBtn = document.getElementById('save-pdf-btn');
        const shareTextBtn = document.getElementById('share-text-btn');
        const errorContainer = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');
        
        // Dark Mode elements
        const darkModeToggle = document.getElementById('dark-mode-toggle');
        
        // Chat elements
        const chatToggleButton = document.getElementById('chat-toggle-button');
        const chatPopupWindow = document.getElementById('chat-popup-window');
        const chatCloseButton = document.getElementById('chat-close-button');
        const chatHistoryDiv = document.getElementById('chat-history');
        const chatInput = document.getElementById('chat-input');
        const sendChatBtn = document.getElementById('send-chat-btn');
        const chatImageUpload = document.getElementById('chat-image-upload');
        const chatAttachmentsPreviewContainer = document.getElementById('chat-attachments-preview-container'); 
        const voiceInputBtn = document.getElementById('voice-input-btn');
        const addChatAttachmentBtn = document.getElementById('add-chat-attachment-btn'); // New plus button
        const chatActionsDropdown = document.getElementById('chat-actions-dropdown'); // New dropdown div
        
        // Copy message element
        const copyMessage = document.getElementById('copy-message');

        // PDF Export template elements
        const pdfExportContent = document.getElementById('pdf-export-content');
        const pdfBody = pdfExportContent.querySelector('.pdf-body');
        const pdfDate = document.getElementById('pdf-date');

        let uploadedMainImages = []; // Array to store {mimeType, data, file} for main upload
        let chatAttachments = []; // Array to store {file: File, mimeType: string, data: string} for chat
        let chatHistory = [];
        let lastPredictionText = '';

        // Web Speech API related variables
        let currentUtterance = null;
        let isSpeaking = false;
        let messageTextCache = new Map(); // Store message content for copy/dictate

        // Speech Recognition variables
        let SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isVoiceInputActive = false;
        let finalTranscript = ''; // Stores the accumulated final transcript for speech input

        // Initialize SpeechRecognition if available
        if (SpeechRecognition) {
            recognition = new SpeechRecognition();
            recognition.continuous = true; // Keep listening for multiple phrases
            recognition.interimResults = true; // Show results while speaking
            recognition.lang = 'en-US';

            recognition.onstart = () => {
                isVoiceInputActive = true;
                voiceInputBtn.classList.add('voice-input-active');
                updateButtonIcon(voiceInputBtn, 'mic-off', 'w-5 h-5'); // Change icon to indicate listening in dropdown
                chatInput.placeholder = 'Listening... Speak now.';
                finalTranscript = ''; // Clear previous transcript for a new session
                chatInput.value = ''; // Clear input field
                chatActionsDropdown.classList.add('hidden'); // Hide dropdown when voice input starts
            };

            recognition.onresult = (event) => {
                let interimTranscript = '';
                for (let i = event.resultIndex; i < event.results.length; ++i) {
                    if (event.results[i].isFinal) {
                        finalTranscript += event.results[i][0].transcript + ' '; // Add space for readability
                    } else {
                        interimTranscript += event.results[i][0].transcript;
                    }
                }
                chatInput.value = finalTranscript + interimTranscript; // Update input with current recognition
                chatInput.scrollLeft = chatInput.scrollWidth; // Scroll to end
            };

            recognition.onend = () => {
                isVoiceInputActive = false;
                voiceInputBtn.classList.remove('voice-input-active');
                updateButtonIcon(voiceInputBtn, 'mic', 'w-5 h-5'); // Reset icon to mic in dropdown
                chatInput.placeholder = 'Ask a follow-up question...';

                // If there's a final transcript, populate the input field.
                if (finalTranscript.trim() !== '') {
                    chatInput.value = finalTranscript.trim(); // Ensure final transcript is in the input
                } else if (chatInput.value.trim() === '') {
                    // If recognition ended with no final transcript and input is empty, clear it
                    chatInput.value = ''; 
                }
            };

            recognition.onerror = (event) => {
                isVoiceInputActive = false; // Important: reset state on error
                voiceInputBtn.classList.remove('voice-input-active');
                updateButtonIcon(voiceInputBtn, 'mic', 'w-5 h-5'); // Reset icon
                chatInput.placeholder = 'Ask a follow-up question...';
                chatActionsDropdown.classList.add('hidden'); // Hide dropdown on error too

                console.error('Speech recognition error:', event.error);
                if (event.error === 'not-allowed') {
                    showError('Microphone access denied. Please allow microphone access in your browser settings.');
                } else if (event.error === 'no-speech') {
                    console.log('No speech detected, recognition ended.');
                    if (finalTranscript.trim() === '') {
                        chatInput.value = '';
                    }
                } else if (event.error === 'network') {
                    showError('Speech recognition network error. This often means a firewall, proxy, or browser extension is blocking access to Google\'s speech services. Please try disabling extensions or testing in incognito mode.');
                } else {
                    showError(`Speech recognition error: ${event.error}`);
                }
            };
            
            // Optional: Listen for audio start/end for more granular control/feedback
            recognition.onaudiostart = () => {
                // console.log('Audio capturing started.');
            };

            recognition.onaudioend = () => {
                // console.log('Audio capturing ended.');
            };

        } else {
            console.warn('Web Speech API (SpeechRecognition) not supported in this browser. Voice input button will be hidden.');
            voiceInputBtn.style.display = 'none'; // Hide the voice input button if not supported
        }

        // Dark Mode Initialization and Listener
        // Set dark mode as default if not already set in local storage
        if (localStorage.getItem('dark-mode') === null) {
            localStorage.setItem('dark-mode', 'true');
        }
        
        const isDarkMode = localStorage.getItem('dark-mode') === 'true';
        if (isDarkMode) {
            document.body.classList.add('dark');
            darkModeToggle.checked = true;
        } else {
            document.body.classList.remove('dark');
            darkModeToggle.checked = false;
        }

        darkModeToggle.addEventListener('change', () => {
            if (darkModeToggle.checked) {
                document.body.classList.add('dark');
                localStorage.setItem('dark-mode', 'true');
            } else {
                document.body.classList.remove('dark');
                localStorage.setItem('dark-mode', 'false');
            }
        });

        // Function to convert a file to a Base64 string and return its MIME type and data
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve({
                    mimeType: file.type || 'application/octet-stream', // Fallback MIME type
                    data: reader.result.split(',')[1]
                });
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        };

        // Function to get Lucide icon name based on MIME type
        function getFileIcon(mimeType) {
            if (mimeType.startsWith('image/')) return 'image';
            if (mimeType === 'application/pdf') return 'file-text';
            if (mimeType.includes('text/')) return 'file-text';
            if (mimeType.includes('csv') || mimeType.includes('excel')) return 'file-spreadsheet';
            if (mimeType.includes('json') || mimeType.includes('xml') || mimeType.includes('code') || mimeType.includes('markdown')) return 'file-code';
            return 'file';
        }

        // Function to display an error message
        function showError(message) {
            errorText.textContent = message;
            errorContainer.classList.remove('hidden');
        }
        
        // --- Marked.js Custom Renderer for Code Blocks ---
        const renderer = {
            code(code, lang) {
                let actualCodeContent;
                if (typeof code === 'object' && code !== null && typeof code.text === 'string') {
                    actualCodeContent = code.text;
                } else if (typeof code !== 'string') {
                    actualCodeContent = String(code);
                } else {
                    actualCodeContent = code;
                }

                const languageDisplay = lang ? `<span class="text-xs font-semibold uppercase text-gray-400">${lang}</span>` : '';
                const uniqueId = `code-block-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                
                const escapedCode = actualCodeContent.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;');

                return `
                    <div class="code-block-container">
                        <div class="code-block-header">
                            ${languageDisplay}
                            <button class="code-block-copy-button" data-copy-target="${uniqueId}">
                                <span data-lucide="clipboard" class="w-4 h-4"></span>
                                Copy code
                            </button>
                        </div>
                        <pre><code id="${uniqueId}">${escapedCode}</code></pre>
                    </div>
                `;
            }
        };

        marked.use({ renderer });

        /**
         * Helper function to update a Lucide icon displayed within a button.
         * Removes the existing SVG and adds a new span for Lucide to convert.
         * @param {HTMLElement} buttonElement The button element containing the icon.
         * @param {string} newIconName The Lucide icon name (e.g., 'check', 'clipboard').
         * @param {string} [classList] Optional additional classes for the new span. Defaults to 'w-4 h-4' for action buttons.
         */
        function updateButtonIcon(buttonElement, newIconName, classList = 'w-4 h-4') {
            // Remove existing Lucide SVG (it will have the 'lucide' class)
            let currentIconSvg = buttonElement.querySelector('.lucide');
            if (currentIconSvg) {
                currentIconSvg.remove();
            }

            // Create a new span element
            const newIconSpan = document.createElement('span');
            newIconSpan.setAttribute('data-lucide', newIconName);
            newIconSpan.className = classList; // Apply styling classes

            // Append the new span to the button
            buttonElement.appendChild(newIconSpan);
           
            createIcons(); // Trigger Lucide to convert the new span to SVG
        }


        // Function to append a message to the chat history
        function appendChatMessage(role, text, attachments = []) { // removed generatedImage parameter
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', role);
            
            // Unique ID for the message to reference its content
            const messageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            messageDiv.dataset.messageId = messageId;
            
            let contentHTML = '';
            let rawMessageContentForCache = ''; // To store plain text for copy/dictate

            if (role === 'user') {
                rawMessageContentForCache = `You: ${text}`;
                contentHTML += `<span class="font-bold">You:</span> ${text}`;
                if (attachments.length > 0) {
                    contentHTML += `<div class="mt-2 flex flex-wrap gap-2">`;
                    attachments.forEach(attachment => {
                        if (attachment.mimeType.startsWith('image/')) {
                            contentHTML += `<img src="data:${attachment.mimeType};base64,${attachment.data}" alt="${attachment.name || 'User attachment'}" class="chat-image w-24 h-24 object-cover">`;
                        } else {
                            // For non-image files, display an icon and file name
                            contentHTML += `
                                <div class="flex items-center space-x-1 p-2 bg-gray-100 dark:bg-gray-600 rounded-md text-sm">
                                    <span data-lucide="${getFileIcon(attachment.mimeType)}" class="w-4 h-4 flex-shrink-0"></span>
                                    <span class="truncate max-w-[120px]">${attachment.name || 'File'}</span>
                                </div>
                            `;
                        }
                    });
                    contentHTML += `</div>`;
                    // Add attachment info to raw content
                    rawMessageContentForCache += `\n[Attachments: ${attachments.map(a => a.name).join(', ')}]`;
                }
            } else { // AI message
                rawMessageContentForCache = `AI: ${text}`;
                // Render markdown content within a wrapper for better styling control
                contentHTML = `<div class="message-content">${marked.parse(text)}</div>`;
            }
            
            // Set the raw text in cache, accounting for actual content for dictation
            messageTextCache.set(messageId, rawMessageContentForCache); 

            // Add action buttons
            const actionsHTML = `
                <div class="message-actions">
                    <button class="copy-message-btn" title="Copy message" data-message-id="${messageId}">
                        <span data-lucide="clipboard" class="w-4 h-4"></span>
                    </button>
                    <button class="dictate-message-btn" title="Dictate message" data-message-id="${messageId}">
                        <span data-lucide="volume-2" class="w-4 h-4"></span>
                    </button>
                </div>
            `;
            
            messageDiv.innerHTML = contentHTML + actionsHTML;
            chatHistoryDiv.appendChild(messageDiv);
            
            // Animate message pop-in
            setTimeout(() => {
                messageDiv.style.transform = 'scale(1)';
            }, 10);
            
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
            
            // Call createIcons() after adding new content to the chat history
            createIcons();
        }

        // Function to display main image previews
        function displayMainImagePreviews() {
            imagePreviewsContainer.innerHTML = '';
            if (uploadedMainImages.length > 0) {
                previewContainer.classList.remove('hidden');
                uploadedMainImages.forEach((image, index) => {
                    const previewItem = document.createElement('div');
                    previewItem.classList.add('relative', 'w-full', 'h-48', 'rounded-xl', 'overflow-hidden', 'shadow-lg', 'border', 'border-gray-200');
                    previewItem.innerHTML = `
                        <img src="${URL.createObjectURL(image.file)}" alt="Image Preview" class="w-full h-full object-contain">
                        <button class="absolute top-2 right-2 p-1 bg-red-500 text-white rounded-full opacity-80 hover:opacity-100 transition-opacity remove-main-image-btn" data-index="${index}">
                            <span data-lucide="x" class="w-4 h-4"></span>
                        </button>
                    `;
                    imagePreviewsContainer.appendChild(previewItem);
                });
                createIcons(); // Ensure delete icons are rendered
            } else {
                previewContainer.classList.add('hidden');
            }
        }

        // Event listener for main image upload input
        imageUpload.addEventListener('change', async (event) => {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                uploadedMainImages = []; // Reset array
                
                // Process each file
                for (const file of files) {
                    try {
                        const { mimeType, data } = await fileToBase64(file);
                        uploadedMainImages.push({ file, mimeType, data });

                    } catch (error) {
                        showError(`Failed to read file ${file.name}.`);
                        console.error('File read error:', error);
                    }
                }
                displayMainImagePreviews(); // Update previews
                
                analyzeBtn.disabled = uploadedMainImages.length === 0;
                resultsContainer.classList.add('hidden'); // Hide previous results
                exportButtons.classList.add('hidden'); // Hide export buttons
                errorContainer.classList.add('hidden'); // Hide any previous errors
                chatHistory = []; // Clear chat history
                chatHistoryDiv.innerHTML = '';
                messageTextCache.clear(); // Clear message text cache
                chatToggleButton.classList.remove('hidden'); // Keep the chat button visible
                chatPopupWindow.classList.add('chat-hidden'); // Ensure chat popup is hidden on new main upload
            } else {
                previewContainer.classList.add('hidden');
                analyzeBtn.disabled = true;
                uploadedMainImages = [];
                displayMainImagePreviews(); // Clear previews if no files selected
            }
        });

        // Event listener for removing main image previews (using event delegation)
        imagePreviewsContainer.addEventListener('click', (event) => {
            const removeBtn = event.target.closest('.remove-main-image-btn');
            if (removeBtn) {
                const index = parseInt(removeBtn.dataset.index);
                uploadedMainImages.splice(index, 1); // Remove from array
                displayMainImagePreviews(); // Re-render previews
                analyzeBtn.disabled = uploadedMainImages.length === 0;
            }
        });

        // Event listener for drag & drop on main upload area
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.add('border-indigo-600', 'bg-indigo-50');
            uploadArea.classList.remove('hover:border-indigo-400');
        });

        uploadArea.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove('border-indigo-600', 'bg-indigo-50');
            uploadArea.classList.add('hover:border-indigo-400');
        });

        uploadArea.addEventListener('drop', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.classList.remove('border-indigo-600', 'bg-indigo-50');
            uploadArea.classList.add('hover:border-indigo-400');

            const files = Array.from(e.dataTransfer.files).filter(file => file.type.startsWith('image/'));
            if (files.length > 0) {
                uploadedMainImages = []; 
                for (const file of files) {
                    try {
                        const { mimeType, data } = await fileToBase64(file);
                        uploadedMainImages.push({ file, mimeType, data });
                    } catch (error) {
                        showError(`Failed to read file ${file.name}.`);
                        console.error('File read error:', error);
                    }
                }
                displayMainImagePreviews();
                analyzeBtn.disabled = uploadedMainImages.length === 0;
                resultsContainer.classList.add('hidden');
                exportButtons.classList.add('hidden');
                errorContainer.classList.add('hidden');
                chatHistory = [];
                chatHistoryDiv.innerHTML = '';
                messageTextCache.clear();
                chatToggleButton.classList.remove('hidden');
                chatPopupWindow.classList.add('chat-hidden');
            }
        });

        // Event listener for the Analyze button
        analyzeBtn.addEventListener('click', async () => {
            if (uploadedMainImages.length === 0) {
                showError('Please upload at least one image first.');
                return;
            }
            
            // Show loading state
            loadingIndicator.classList.remove('hidden');
            analyzeBtn.disabled = true;
            resultsContainer.classList.remove('hidden');
            predictionOutput.innerHTML = '';
            exportButtons.classList.add('hidden');
            errorContainer.classList.add('hidden');
            
            // Hide the chat popup and show button during analysis for clarity
            chatToggleButton.classList.remove('hidden'); 
            chatPopupWindow.classList.add('chat-hidden'); 

            // Modified prompt to include guidance for better predictions AND strategic advice
            const initialPrompt = `Act as a professional sports analyst for the fantasy sports platform Dream11, specializing in cricket. You are given a screenshot(s) containing information about an upcoming cricket match.
            
            **Your Task:** Analyze all the text and images within the screenshot(s) to find key details such as player form, team news, pitch conditions, recent performances, and historical data. Based on your thorough analysis, provide the best possible Dream11 team, including a captain and vice-captain.
            
            **Output Format:** Your output must be a single, well-structured text block that:
            1.  Lists the suggested Dream11 team by player role (Wicket-keeper, Batsmen, All-rounders, Bowlers), ensuring a balanced team.
            2.  Provides a concise, point-form analysis explaining your choices for each key player and overall team composition. This analysis must be grounded in the data you extracted from the image.
            3.  Suggests alternative players if options are available and reasons for them.
            4.  Clearly highlights your Captain and Vice-Captain picks with justifications.
            5.  Uses clear headings for each section (e.g., ## Team Analysis) and bullet points for lists (e.g., - Player Name).
            6.  **IMPORTANT:** If you provide any code (e.g., HTML, JavaScript), always wrap it in a markdown code block (e.g., \`\`\`html\n<p>Hello</p>\n\`\`\` or \`\`\`javascript\nconsole.log('hi');\n\`\`\`).
            
            **Information Clarity:**
            - If any crucial information (like specific player stats, team news, or detailed pitch reports) is missing or unclear in the image(s), you must explicitly state what information you were unable to retrieve and how this might impact the prediction.
            
            **Concluding Tips:** Conclude your response with a small section titled '### Tips for Maximizing Fantasy Points' advising the user on what kind of information helps you make more accurate predictions and strategic choices. This section should list:
            - **Comprehensive Player Statistics:** Recent scores, wickets, economy rates, strike rates, fantasy points history.
            - **Detailed Player Form:** Performance in last 5-10 matches, against specific opposition, and at the venue.
            - **Team News & Dynamics:** Injuries, definite lineup changes, team's recent form, batting order, and specific roles (e.g., powerplay bowler, death bowler).
            - **In-depth Pitch Reports:** Batting/bowling friendly, average scores, presence of dew, historical venue performance, and expected behavior throughout the match.
            - **Head-to-Head Records:** Team vs. team and individual player vs. player matchups.
            - **Strategic Advice:** Considerations for grand leagues vs. small leagues (e.g., differential picks, safe vs. risky captains), budget management, and understanding player roles for point optimization.
            
            This will help the user provide better inputs and formulate stronger strategies in the future.`;


            try {
                // Build the user parts for the initial image upload
                const userParts = [{ text: initialPrompt }];
                uploadedMainImages.forEach(img => {
                    userParts.push({
                        inlineData: {
                            mimeType: img.mimeType,
                            data: img.data
                        }
                    });
                });
                
                const payload = {
                    contents: [
                        { role: "user", parts: userParts }
                    ],
                };
                
                const responseText = await callGeminiAPI(payload);
                
                // Store the raw text for sharing
                lastPredictionText = responseText;

                // Render the AI response text using Marked.js for display
                predictionOutput.innerHTML = marked.parse(responseText);
                
                // Store the full, correctly formatted API history
                chatHistory = [
                    { role: 'user', parts: userParts },
                    { role: 'model', parts: [{ text: responseText }] }
                ];
                
                // After analysis, show the chat and export buttons
                chatToggleButton.classList.remove('hidden');
                exportButtons.classList.remove('hidden');
                // The main prediction output is also considered the first AI chat message
                appendChatMessage('ai', responseText); 
                chatInput.focus();

            } catch (error) {
                console.error('Initial API call failed:', error);
                showError(`An error occurred: ${error.message}`);
            } finally {
                loadingIndicator.classList.add('hidden');
                analyzeBtn.disabled = false;
            }
        });
        
        // Event listener for chat image/file upload
        chatImageUpload.addEventListener('change', async (event) => {
            const files = Array.from(event.target.files);
            if (files.length > 0) {
                for (const file of files) {
                    try {
                        const { mimeType, data } = await fileToBase64(file);
                        chatAttachments.push({ file, mimeType, data, name: file.name });
                    } catch (error) {
                        showError(`Failed to read chat file ${file.name}.`);
                        console.error('Chat file read error:', error);
                    }
                }
                displayChatAttachments();
                chatInput.focus();
            }
            chatActionsDropdown.classList.add('hidden'); // Hide dropdown after selection
        });

        // Function to display chat attachments
        function displayChatAttachments() {
            chatAttachmentsPreviewContainer.innerHTML = '';
            if (chatAttachments.length > 0) {
                chatAttachmentsPreviewContainer.classList.remove('hidden');
                chatAttachments.forEach((attachment, index) => {
                    const attachmentDiv = document.createElement('div');
                    attachmentDiv.classList.add('chat-attachment-preview-item');
                    attachmentDiv.dataset.index = index;

                    let previewContent = '';
                    if (attachment.mimeType.startsWith('image/')) {
                        previewContent = `<img src="data:${attachment.mimeType};base64,${attachment.data}" alt="${attachment.name}" class="w-8 h-8 object-cover rounded-md">`;
                    } else {
                        previewContent = `<span data-lucide="${getFileIcon(attachment.mimeType)}" class="w-5 h-5 flex-shrink-0"></span>`;
                    }

                    attachmentDiv.innerHTML = `
                        ${previewContent}
                        <span class="truncate max-w-[100px]">${attachment.name}</span>
                        <button class="remove-attachment-btn">
                            <span data-lucide="x" class="w-4 h-4"></span>
                        </button>
                    `;
                    chatAttachmentsPreviewContainer.appendChild(attachmentDiv);
                });
                createIcons(); // Re-render icons for new attachments
            } else {
                chatAttachmentsPreviewContainer.classList.add('hidden');
            }
        }

        // Event listener for removing individual chat attachments (using event delegation)
        chatAttachmentsPreviewContainer.addEventListener('click', (event) => {
            const removeBtn = event.target.closest('.remove-attachment-btn');
            if (removeBtn) {
                const attachmentDiv = removeBtn.closest('[data-index]');
                if (attachmentDiv) {
                    const index = parseInt(attachmentDiv.dataset.index);
                    chatAttachments.splice(index, 1); // Remove from array
                    displayChatAttachments(); // Re-render preview
                    chatInput.focus();
                }
            }
        });
        
        // Event listener for sending chat messages
        sendChatBtn.addEventListener('click', async () => {
            const userMessage = chatInput.value.trim();
            if (!userMessage && chatAttachments.length === 0) {
                return;
            }
            
            // Stop speech recognition if active before sending
            if (isVoiceInputActive && recognition) {
                recognition.stop();
            }

            // Hide dropdown if open
            chatActionsDropdown.classList.add('hidden');

            // Build the parts for the user message
            const userParts = [];
            if (userMessage) {
                userParts.push({ text: userMessage });
            }
            for (const attachment of chatAttachments) {
                userParts.push({
                    inlineData: {
                        mimeType: attachment.mimeType,
                        data: attachment.data
                    }
                });
            }

            // Append user message and attachments to chat history and UI
            chatHistory.push({ role: 'user', parts: userParts });
            appendChatMessage('user', userMessage, chatAttachments);
            
            // Clear input and attachment after sending
            chatInput.value = '';
            chatAttachments = [];
            chatImageUpload.value = ''; // Clear file input
            displayChatAttachments(); // Clear attachment previews
            
            sendChatBtn.disabled = true;
            
            // Show loading indicator
            const loadingMessage = document.createElement('div');
            loadingMessage.id = 'chat-loading';
            loadingMessage.classList.add('p-4', 'text-center', 'text-gray-500', 'text-sm');
            loadingMessage.innerHTML = `
                <div class="loader-container h-8">
                    <div class="loader-dot bg-gray-500"></div>
                    <div class="loader-dot bg-gray-500"></div>
                    <div class="loader-dot bg-gray-500"></div>
                </div>
                <span class="mt-2 block">AI is typing...</span>
            `;
            chatHistoryDiv.appendChild(loadingMessage);
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
            
            try {
                // Call API with full chat history
                const payload = {
                    contents: chatHistory,
                };
                
                const responseText = await callGeminiAPI(payload);
                
                // Append AI response to chat history and UI
                chatHistory.push({ role: 'model', parts: [{ text: responseText }] });
                appendChatMessage('ai', responseText);
                
            } catch (error) {
                console.error('Chat API call failed:', error);
                showError(`An error occurred in the chat: ${error.message}`);
            } finally {
                sendChatBtn.disabled = false;
                const loadingDiv = document.getElementById('chat-loading');
                if (loadingDiv) {
                    loadingDiv.remove();
                }
                chatInput.focus();
            }
        });
        
        // Add event listener for the 'Enter' key on the chat input
        chatInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                sendChatBtn.click();
            }
        });

        // Event listener for voice input button (now inside dropdown)
        voiceInputBtn.addEventListener('click', () => {
            if (recognition) {
                if (isVoiceInputActive) {
                    recognition.stop(); // Manually stop recognition
                } else {
                    finalTranscript = ''; // Reset transcript when starting a new session
                    recognition.start();
                }
            } else {
                showError('Speech recognition is not supported in this browser.');
            }
        });

        // Event listener for the new "Add" button to toggle dropdown
        addChatAttachmentBtn.addEventListener('click', (event) => {
            event.stopPropagation(); // Prevent document click from immediately closing it
            chatActionsDropdown.classList.toggle('hidden');
            createIcons(); // Ensure icons within dropdown are rendered
        });

        // Close dropdown when clicking anywhere else on the document
        document.addEventListener('click', (event) => {
            if (!chatActionsDropdown.contains(event.target) && !addChatAttachmentBtn.contains(event.target)) {
                chatActionsDropdown.classList.add('hidden');
            }
        });

        // Drag and Drop for Chat Window
        chatPopupWindow.addEventListener('dragover', (e) => {
            e.preventDefault();
            e.stopPropagation();
            chatPopupWindow.classList.add('drag-over-active');
        });

        chatPopupWindow.addEventListener('dragleave', (e) => {
            e.preventDefault();
            e.stopPropagation();
            chatPopupWindow.classList.remove('drag-over-active');
        });

        chatPopupWindow.addEventListener('drop', async (e) => {
            e.preventDefault();
            e.stopPropagation();
            chatPopupWindow.classList.remove('drag-over-active');

            const files = Array.from(e.dataTransfer.files);
            if (files.length > 0) {
                for (const file of files) {
                    // Basic file type validation for chat (allow images, text, pdf, csv, json, xml, md)
                    const allowedTypes = [
                        'image/', 'text/', 'application/pdf',
                        'application/json', 'text/csv', 'application/xml', 'text/markdown'
                    ];
                    const isAllowed = allowedTypes.some(type => file.type.startsWith(type)) || file.name.endsWith('.md');

                    if (isAllowed) {
                        try {
                            const { mimeType, data } = await fileToBase64(file);
                            chatAttachments.push({ file, mimeType, data, name: file.name });
                        } catch (error) {
                            showError(`Failed to read chat file ${file.name}.`);
                            console.error('Chat file read error:', error);
                        }
                    } else {
                        showError(`File type not supported for chat: ${file.name} (${file.type}).`);
                    }
                }
                displayChatAttachments();
                chatInput.focus();
            }
        });


        // Event listener for the Clear button
        clearBtn.addEventListener('click', () => {
            imageUpload.value = ''; // Reset the file input
            uploadedMainImages = []; // Clear main images
            displayMainImagePreviews(); // Clear the image previews
            
            predictionOutput.innerHTML = ''; // Clear the output text
            resultsContainer.classList.add('hidden');
            exportButtons.classList.add('hidden');
            analyzeBtn.disabled = true;
            
            errorContainer.classList.add('hidden');
            errorText.textContent = '';
            chatToggleButton.classList.remove('hidden'); // Keep chat button visible
            chatPopupWindow.classList.add('chat-hidden'); // Hide chat popup
            chatHistory = []; // Clear chat history
            chatHistoryDiv.innerHTML = '';
            messageTextCache.clear(); // Clear message text cache
            lastPredictionText = ''; // Clear the last prediction text
            
            // Clear chat-specific attachments
            chatAttachments = [];
            chatImageUpload.value = '';
            displayChatAttachments(); // Clear attachment previews
            chatActionsDropdown.classList.add('hidden'); // Hide dropdown

            // Stop any ongoing speech
            if (isSpeaking) {
                window.speechSynthesis.cancel();
                isSpeaking = false;
                currentUtterance = null;
            }
            // Stop speech recognition if active
            if (isVoiceInputActive && recognition) {
                recognition.stop();
            }
        });

        // Floating chat popup toggle logic
        chatToggleButton.addEventListener('click', () => {
            chatPopupWindow.classList.remove('chat-hidden');
            chatPopupWindow.classList.add('chat-visible');
            chatInput.focus();
            setTimeout(createIcons, 50); 
        });

        chatCloseButton.addEventListener('click', () => {
            chatPopupWindow.classList.remove('chat-visible');
            chatPopupWindow.classList.add('chat-hidden');
            chatActionsDropdown.classList.add('hidden'); // Hide dropdown when chat closes

            // Stop any ongoing speech when closing chat
            if (isSpeaking) {
                window.speechSynthesis.cancel();
                isSpeaking = false;
                currentUtterance = null;
                // Reset all dictate buttons to play state
                document.querySelectorAll('.dictate-message-btn').forEach(btn => {
                    updateButtonIcon(btn, 'volume-2'); // Reset icon
                });
            }
            // Stop speech recognition if active
            if (isVoiceInputActive && recognition) {
                recognition.stop();
            }
        });
        
        // Function to show a temporary message for clipboard copy
        function showCopyMessage() {
            copyMessage.classList.add('show');
            setTimeout(() => {
                copyMessage.classList.remove('show');
            }, 3000);
        }

        // Event listener for Save as PDF button
        savePdfBtn.addEventListener('click', async () => {
            if (!window.jspdf || !window.html2canvas) {
                showError('PDF libraries not loaded. Please try again.');
                return;
            }
            if (!lastPredictionText) {
                showError('No prediction available to export to PDF.');
                return;
            }

            const { jsPDF } = window.jspdf;
            
            // Prepare the hidden PDF template content
            pdfBody.innerHTML = marked.parse(lastPredictionText);
            pdfDate.textContent = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
            
            // Show the hidden div temporarily for html2canvas to render it with its specific styles
            pdfExportContent.style.display = 'flex'; // Use flex to activate header/footer layout
            // Ensure icons within the PDF template are rendered before html2canvas capture
            createIcons(); 
            
            // Disable buttons during PDF generation
            savePdfBtn.disabled = true;
            shareTextBtn.disabled = true;

            try {
                const canvas = await html2canvas(pdfExportContent, {
                    scale: 2, // Higher scale for better quality
                    useCORS: true,
                    // These options ensure the canvas captures the full scrollable content
                    windowWidth: pdfExportContent.offsetWidth, 
                    windowHeight: pdfExportContent.scrollHeight 
                });

                const imgData = canvas.toDataURL('image/png');
                const imgWidth = canvas.width;
                const imgHeight = canvas.height;

                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfPageWidth = pdf.internal.pageSize.getWidth(); // A4 width in mm (210mm)
                const pdfPageHeight = pdf.internal.pageSize.getHeight(); // A4 height in mm (297mm)

                // Calculate aspect ratio to fit image width to PDF page width
                const imgAspectRatio = imgWidth / imgHeight;
                let finalImgWidth = pdfPageWidth;
                let finalImgHeight = pdfPageWidth / imgAspectRatio; // This is the height the image would be if it fit the width

                let heightLeft = imgHeight; // Remaining height of the canvas image to be put into PDF (in canvas pixels)
                let position = 0; // Current vertical position in canvas image (in canvas pixels)

                let pageNumber = 1;

                while (heightLeft > 0) {
                    // Add a new page if it's not the first one
                    if (position > 0) {
                        pdf.addPage();
                        pageNumber++;
                    }

                    // Calculate the portion of the canvas image that fits one PDF page
                    // clipHeightPx is the height in the *original canvas pixels* that should be rendered on this PDF page.
                    const clipHeightPx = Math.min(heightLeft, imgHeight * (pdfPageHeight / finalImgHeight));
                    
                    // Add the slice of the image to the PDF
                    // addImage(imageData, format, x, y, width, height, alias, compression, rotation, sx, sy, sWidth, sHeight)
                    // The sx, sy, sWidth, sHeight parameters define the source rectangle on the canvas
                    pdf.addImage(imgData, 'PNG', 0, 0, finalImgWidth, pdfPageHeight, null, 'FAST', 0, 0, imgWidth, position, imgWidth, clipHeightPx);
                    
                    // Add page number at the bottom center
                    pdf.setFontSize(10);
                    pdf.setTextColor(150); // Gray color
                    pdf.text(`Page ${pageNumber}`, pdfPageWidth / 2, pdfPageHeight - 10, { align: 'center' });

                    heightLeft -= clipHeightPx;
                    position += clipHeightPx;
                }
                
                pdf.save('Dream11_Team_Prediction.pdf');
            } catch (error) {
                console.error('Error generating PDF:', error);
                showError('Failed to generate PDF. Please try again.');
            } finally {
                // Hide the template div again
                pdfExportContent.style.display = 'none';
                savePdfBtn.disabled = false;
                shareTextBtn.disabled = false;
            }
        });
        
        // Event listener for Share as Text button
        shareTextBtn.addEventListener('click', () => {
            if (lastPredictionText) {
                const textToCopy = lastPredictionText.trim();
                
                // Copy to clipboard
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = textToCopy;
                document.body.appendChild(tempTextArea);
            
                // Select and copy
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(textToCopy)
                        .then(() => {
                            showCopyMessage();
                        })
                        .catch(err => {
                            console.error('Failed to copy text (Clipboard API):', err);
                            tempTextArea.select();
                            try {
                                document.execCommand('copy'); // Fallback to deprecated method
                                showCopyMessage();
                            } catch (fallbackErr) {
                                console.error('Failed to copy text (execCommand fallback):', fallbackErr);
                                showError('Failed to copy text. Please copy manually.');
                            }
                        });
                } else {
                    tempTextArea.select();
                    try {
                        document.execCommand('copy'); // Fallback to deprecated method
                        showCopyMessage();
                    } catch (err) {
                        console.error('Failed to copy text (execCommand):', err);
                        showError('Failed to copy text. Please copy manually.');
                    }
                }
                document.body.removeChild(tempTextArea);
            } else {
                showError('No team prediction to share yet.');
            }
        });

        // Event delegation for copy code buttons within chat history
        chatHistoryDiv.addEventListener('click', (event) => {
            // Handle code block copy button
            const codeCopyButton = event.target.closest('.code-block-copy-button');
            if (codeCopyButton) {
                const targetId = codeCopyButton.dataset.copyTarget;
                const codeElement = document.getElementById(targetId);
                if (codeElement) {
                    const codeToCopy = codeElement.textContent;
                    // For code block copy button, its own icon changes
                    updateButtonIcon(codeCopyButton, 'check', 'w-4 h-4'); // Explicitly pass classList for code buttons
                    copyToClipboard(codeToCopy); 
                    setTimeout(() => { // Reset icon after 2 seconds
                        updateButtonIcon(codeCopyButton, 'clipboard', 'w-4 h-4'); // Explicitly pass classList
                    }, 2000);
                    return; // Prevent further bubbling for this button
                }
            }

            // Handle chat message copy button
            const chatCopyButton = event.target.closest('.copy-message-btn');
            if (chatCopyButton) {
                const messageId = chatCopyButton.dataset.messageId;
                const messageContent = messageTextCache.get(messageId);
                if (messageContent) {
                    // For chat message copy button, its own icon changes
                    updateButtonIcon(chatCopyButton, 'check');
                    copyToClipboard(messageContent); 
                    setTimeout(() => { // Reset icon after 2 seconds
                        updateButtonIcon(chatCopyButton, 'clipboard');
                    }, 2000);
                } else {
                    showError('Message content not found for copying.');
                }
                return; // Prevent further bubbling
            }

            // Handle dictate message button
            const dictateButton = event.target.closest('.dictate-message-btn');
            if (dictateButton) {
                const messageId = dictateButton.dataset.messageId;
                const messageContent = messageTextCache.get(messageId);
                if (messageContent) {
                    toggleSpeech(messageContent, dictateButton);
                } else {
                    showError('Message content not found for dictation.');
                }
                return; // Prevent further bubbling
            }
        });

        // Helper function to copy text to clipboard
        function copyToClipboard(text) { 
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => {
                        showCopyMessage();
                    })
                    .catch(err => {
                        console.error('Failed to copy: ', err);
                        showError('Failed to copy text. Please copy manually.');
                    });
            } else {
                // Fallback for older browsers
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = text;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                try {
                    document.execCommand('copy');
                    showCopyMessage();
                } catch (err) {
                    console.error('Failed to copy (fallback):', err);
                    showError('Failed to copy text. Please copy manually.');
                }
                document.body.removeChild(tempTextArea);
            }
        }

        // Helper function for text-to-speech
        function toggleSpeech(text, buttonElement) {
            if (!window.speechSynthesis) {
                showError('Speech synthesis not supported in this browser.');
                return;
            }

            // Check if this specific message is currently being spoken
            if (isSpeaking && currentUtterance && currentUtterance.text === text) {
                // If the same message is currently being spoken, toggle pause/resume
                if (window.speechSynthesis.paused) {
                    window.speechSynthesis.resume();
                    updateButtonIcon(buttonElement, 'pause');
                } else {
                    window.speechSynthesis.pause();
                    updateButtonIcon(buttonElement, 'volume-2');
                }
            } else {
                // If a different message is speaking, or nothing is speaking, start new speech
                startSpeech(text, buttonElement);
            }
        }

        function startSpeech(text, buttonElement) {
            // Cancel any existing speech first
            if (window.speechSynthesis.speaking || window.speechSynthesis.paused) {
                window.speechSynthesis.cancel();
            }

            // Reset all other dictate buttons to play state
            document.querySelectorAll('.dictate-message-btn').forEach(btn => {
                if (btn !== buttonElement) { // Don't reset the button that initiated the current speech
                    updateButtonIcon(btn, 'volume-2'); 
                }
            });

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US'; // Set language

            utterance.onstart = () => {
                isSpeaking = true;
                currentUtterance = utterance;
                updateButtonIcon(buttonElement, 'pause');
            };
            utterance.onend = () => {
                isSpeaking = false;
                currentUtterance = null;
                updateButtonIcon(buttonElement, 'volume-2');
            };
            utterance.onerror = (event) => {
                console.error('Speech synthesis error:', event.error);
                showError('Failed to dictate message. Check console for details.');
                isSpeaking = false;
                currentUtterance = null;
                updateButtonIcon(buttonElement, 'volume-2');
            };

            window.speechSynthesis.speak(utterance);
        }


        // Generic API call function with exponential backoff
        async function callGeminiAPI(payload) {
            // >>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>>
            // IMPORTANT: Replace "YOUR_GEMINI_API_KEY" with your actual Google Gemini API Key.
            // Get your API key from Google AI Studio: https://makersuite.google.com/
            // Do NOT expose your API key directly in production applications.
            // For production, consider using a backend proxy to secure your API key.
            // <<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<<
            const apiKey = "AIzaSyC7twxprKoApUjR4uebBS-12KVyZTkuvrw"; 

            if (apiKey === "YOUR_GEMINI_API_KEY" || !apiKey || apiKey === "") { 
                throw new Error("API Key is not set or is the default placeholder. Please replace 'YOUR_GEMINI_API_KEY' in the script with your actual Gemini API key.");
            }

            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

            let response;
            let result;
            let success = false;
            let retryCount = 0;
            const maxRetries = 3;
            let delay = 1000; // 1 second initial delay

            while (retryCount < maxRetries && !success) {
                try {
                    response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (response.status === 429) { // Too many requests
                        if (retryCount < maxRetries - 1) {
                            console.warn(`API rate limit exceeded. Retrying in ${delay / 1000}s...`);
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2; // Exponential backoff
                            retryCount++;
                        } else {
                            throw new Error('API rate limit exceeded. Please try again later.');
                        }
                    } else if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API error: ${response.status} ${response.statusText} - ${errorData.error?.message || 'Unknown error'}`);
                    } else {
                        result = await response.json();
                        success = true;
                    }
                } catch (err) {
                    if (retryCount < maxRetries - 1) {
                        console.warn(`Fetch error: ${err.message}. Retrying in ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                        retryCount++;
                    } else {
                        throw err; // Re-throw the last error after max retries
                    }
                }
            }
            
            if (result && result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                // Return the text content from the response
                return result.candidates[0].content.parts[0].text;
            } else {
                throw new Error('Failed to get a valid response from the AI. No candidates found or content is empty.');
            }
        }
    </script>
</body>
</html>

