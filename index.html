<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mystic Vision AI Chat (Lite)</title> <!-- Renamed title -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
    <!-- Tailwind CSS CDN for utility classes -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Marked.js CDN for Markdown parsing -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <!-- Lucide Icons for a modern, futuristic feel -->
    <script src="https://cdn.jsdelivr.net/npm/lucide-dynamic@latest/dist/lucide.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <!-- Prism.js for code syntax highlighting -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-okaidia.min.css" rel="stylesheet" />
    <!-- jsPDF CDN for PDF export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- PWA Manifest -->
    <link rel="manifest" href="/manifest.json">
    <style>
        /* General Styles - Mystic Vision Theme */
        :root {
            /* Default Cosmic Purple Palette */
            --primary-bg: #0A0A28; /* Even deeper dark blue-purple, almost black */
            --secondary-bg: #15153A; /* Darker purple-blue - container background */
            --tertiary-bg: #22224F; /* Medium dark purple-blue - header/input area/button base */
            --text-color: #E6E6FA; /* Light lavender text for ethereal feel */
            --accent-color: #C070FF; /* Vibrant mystical purple */
            --border-color: #2F2F6A; /* Slightly clearer border */
            --user-bubble: #353570; /* Deeper purple for user */
            --ai-bubble: #1A1A40; /* Slightly different dark purple for AI */
            --input-bg: #0C0C2F; /* Keeps the input field very dark */
            --button-hover-bg: #A040FF; /* Slightly darker accent for hover */
            --shadow-color: rgba(0, 0, 0, 0.6); /* Stronger shadow */
            --code-bg: #0D0D32; /* Code block background */
            --code-text: #F8F8F8; /* Code text color */
            --code-border: #2F2F6A; /* Code border */
            --code-header-bg: #22224F; /* Code header background */
            --code-header-border: #353570; /* Code header border */
            --inline-code-bg: rgba(192, 112, 255, 0.25); /* Inline code background */
            --inline-code-color: var(--accent-color); /* Inline code color */
            --message-action-bg: rgba(10, 10, 26, 0.7); /* Message action background */
            --message-action-user-bg: rgba(53, 53, 112, 0.7); /* Message action background for user messages */
            --message-action-icon: #BEC2D5; /* Lighter icon color */
            --message-action-icon-hover: var(--text-color); /* Message action icon hover color */

            /* Common Accent Colors (for alerts/status) */         
            --accent-error: #ef4444; /* Red for errors */         
            --accent-success: #22c55e; /* Green for success */          

            /* Font Families */         
            --font-family-primary: 'Poppins', sans-serif;         
            --font-family-secondary: 'Montserrat', sans-serif;          

            /* Autocomplete */
            --autocomplete-bg: var(--secondary-bg);
            --autocomplete-border: var(--border-color);
            --autocomplete-text: var(--text-color);
            --autocomplete-hover-bg: var(--tertiary-bg);
            --autocomplete-selected-bg: var(--accent-color);
            --autocomplete-selected-text: white;

            /* Cosmic Animation Colors */
            --cosmic-glow-color-1: #C070FF; /* Vibrant mystical purple */
            --cosmic-glow-color-2: #7B2FEE; /* Deeper mystical purple */
            --cosmic-star-color: #E6E6FA; /* Light lavender for stars */
            --user-avatar-bg: #4A4A80; /* Background for generic user avatar */
            --text-on-accent: #FFFFFF; /* Default text on accent color */
        }

        /* Starlight Lavender Theme */
        body.starlight-lavender { 
            --primary-bg: #F0F4FF; /* Very pale blue-lavender */
            --secondary-bg: #FFFFFF; /* Pure white for container/card background */
            --tertiary-bg: #E0E8FF; /* Pale light blue-purple for header/input area/button base */
            --text-color: #1A0033; /* Very dark purple/black for main text */
            --accent-color: #8C2BFF; /* Slightly richer/darker purple for light mode accent */
            --border-color: #C0C8D8; /* Soft light border */
            --user-bubble: #D8E2FF; /* Light blue-purple, user bubble */
            --ai-bubble: #F0F4FF; /* Even paler lavender, AI bubble */
            --input-bg: #F8F8FD; /* Slightly off-white for input field */
            --button-hover-bg: #B050FF; /* Slightly darker accent for hover in light mode */
            --shadow-color: rgba(0, 0, 0, 0.15); /* Lighter shadow */
            --code-bg: #F5F7FA; /* Lighter background for code in light mode */
            --code-text: #333; /* Code text color */
            --code-border: #D8DCE5; /* Code border */
            --code-header-bg: #E8ECF5; /* Code header background */
            --code-header-border: #D0D4DF; /* Code header border */
            --inline-code-bg: rgba(130, 0, 200, 0.12); /* Inline code background (LM accent with transparency) */
            --inline-code-color: var(--accent-color); /* Inline code color */
            --message-action-bg: rgba(255, 255, 255, 0.8); /* Message action background */
            --message-action-user-bg: rgba(220, 230, 255, 0.8); /* Message action background for user messages */
            --message-action-icon: #666; /* Message action icon color */
            --message-action-icon-hover: var(--text-color); /* Message action icon hover color */

            /* Autocomplete */
            --autocomplete-bg: var(--secondary-bg);
            --autocomplete-border: var(--border-color);
            --autocomplete-text: var(--text-color);
            --autocomplete-hover-bg: var(--tertiary-bg);
            --autocomplete-selected-bg: var(--accent-color);
            --autocomplete-selected-text: white;

            /* Cosmic Animation Colors Light Mode */
            --cosmic-glow-color-1: #8C2BFF; 
            --cosmic-glow-color-2: #6A1DCC;
            --cosmic-star-color: #333;
            --user-avatar-bg: #C0C8D8; /* Lighter background for generic user avatar */
            --text-on-accent: #FFFFFF;
        }

        /* Emerald Galaxy Theme */
        body.emerald-galaxy {
            --primary-bg: #031A20; /* Very dark teal/green-blue */
            --secondary-bg: #0B2B33; /* Darker teal-blue */
            --tertiary-bg: #15454F; /* Medium dark teal */
            --text-color: #E0FFFF; /* Pale aqua/cyan */
            --accent-color: #00FFC0; /* Vibrant emerald green */
            --border-color: #2D6C77; /* Slightly darker teal border */
            --user-bubble: #255C65; /* Darker green-blue bubble */
            --ai-bubble: #0F3A40; /* Even darker green-blue bubble */
            --input-bg: #052028;
            --button-hover-bg: #00D0A0; /* Slightly darker emerald */
            --shadow-color: rgba(0, 0, 0, 0.6);
            --code-bg: #0A252E;
            --code-text: #E0FFFF;
            --code-border: #2D6C77;
            --code-header-bg: #15454F;
            --code-header-border: #255C65;
            --inline-code-bg: rgba(0, 255, 192, 0.2);
            --inline-code-color: var(--accent-color);
            --message-action-bg: rgba(3, 26, 32, 0.7);
            --message-action-user-bg: rgba(37, 92, 101, 0.7);
            --message-action-icon: #BFDFFF;
            --message-action-icon-hover: var(--text-color);
            --user-avatar-bg: #1B3F47;
            --cosmic-glow-color-1: #00FFC0;
            --cosmic-glow-color-2: #00A080; 
            --cosmic-star-color: #E0FFFF;
            --text-on-accent: #000000;
        }

        /* Crimson Nebula Theme */
        body.crimson-nebula {
            --primary-bg: #1A0515; /* Very dark deep red-purple */
            --secondary-bg: #2B0A20; /* Darker red-purple */
            --tertiary-bg: #4F153A; /* Medium dark red-purple */
            --text-color: #FFEFF5; /* Pale pink/red-white */
            --accent-color: #FF4080; /* Vibrant deep rose/magenta */
            --border-color: #772D57; /* Slightly darker border */
            --user-bubble: #5C254F; /* Darker red-purple bubble */
            --ai-bubble: #3A0F2B; /* Even darker red-purple bubble */
            --input-bg: #20051A;
            --button-hover-bg: #FF60A0; /* Slightly brighter accent */
            --shadow-color: rgba(0, 0, 0, 0.6);
            --code-bg: #250A1F;
            --code-text: #FFEFF5;
            --code-border: #772D57;
            --code-header-bg: #4F153A;
            --code-header-border: #5C254F;
            --inline-code-bg: rgba(255, 64, 128, 0.2);
            --inline-code-color: var(--accent-color);
            --message-action-bg: rgba(26, 5, 21, 0.7);
            --message-action-user-bg: rgba(92, 37, 79, 0.7);
            --message-action-icon: #FFE0F0;
            --message-action-icon-hover: var(--text-color);
            --user-avatar-bg: #3F1B35;
            --cosmic-glow-color-1: #FF4080;
            --cosmic-glow-color-2: #FF0060; 
            --cosmic-star-color: #FFEFF5;
            --text-on-accent: #000000;
        }

        /* Golden Aurora Theme */
        body.golden-aurora {
            --primary-bg: #060B12; /* Even deeper, almost black-blue, base of the night sky */
            --secondary-bg: #0F161E; /* Darker blue-grey for main container */
            --tertiary-bg: #1A2533; /* Medium dark blue for header/input/sidebar section backgrounds */
            --text-color: #F8F8F8; /* Crisp off-white for main text for better readability */
            --accent-color: #FFD700; /* Pure, strong gold - keep this as the primary gold focus */
            --border-color: #2F3E50; /* Subtler, deeper blue border */
            --user-bubble: #28374A; /* A rich, slightly muted dark blue for user messages */
            --ai-bubble: #121C27; /* A very dark, muted blue for AI messages, distinct but harmonious */
            --input-bg: #080D14; /* Very dark for input field, blends with primary */
            --button-hover-bg: #FFC000; /* Slightly brighter golden-orange for hover */
            --shadow-color: rgba(0, 0, 0, 0.7); /* Deeper shadows for better separation */
            --code-bg: #0F161E; /* Same as secondary background for code blocks, consistency */
            --code-text: #E0FFFF; /* Pale aqua for code text for good readability on dark background */
            --code-border: #2F3E50; /* Same as main border */
            --code-header-bg: #1A2533; /* Same as tertiary */
            --code-header-border: #28374A; /* Same as user bubble */
            --inline-code-bg: rgba(255, 215, 0, 0.25); /* Slightly more opaque golden glow */
            --inline-code-color: #FFECB3; /* Lighter gold for inline code, stands out more */
            --message-action-bg: rgba(6, 11, 18, 0.7); /* More transparent dark for actions */
            --message-action-user-bg: rgba(40, 55, 74, 0.7); /* More transparent user action background */
            --message-action-icon: #BECDE0; /* Slightly bluer, lighter icon color */
            --message-action-icon-hover: var(--text-color);
            --user-avatar-bg: #2B3D55; /* Slightly desaturated dark blue for generic user avatar */
            /* Cosmic Animation Colors - Focus on golden and complementary warm tones */
            --cosmic-glow-color-1: #FFD700; /* Primary strong gold */
            --cosmic-glow-color-2: #FFA500; /* Complementary vibrant orange for aurora effect */
            --cosmic-star-color: #F8F8F8; /* Bright white for stars */
            --text-on-accent: #000000;
        }
        /* Cosmic Gold Theme (Royal Edition) */
        body.cosmic-gold {
            /* Deeper, more profound blacks */
            --primary-bg: #000000; /* True black of the cosmos */
            --secondary-bg: #0A0A10; /* Very deep dark blue-black */
            --tertiary-bg: #151520; /* Darker charcoal */

            /* Royal Gold & Text on Gold */
            --text-color: #FFFAF0; /* Soft, warm off-white/cream remains */
            --accent-color: #CCAA00; /* A rich, royal gold - less yellow, more profound */
            --text-on-accent: #000000; /* Essential: Black font for elements with gold background */

            /* Borders & Shadows */
            --border-color: #554422; /* Darker bronze/gold to complement the royal accent */
            --shadow-color: rgba(0, 0, 0, 0.8); /* Deeper shadows for more contrast */

            /* Bubbles & Input Fields */
            --user-bubble: #252530; /* Darker charcoal for user messages */
            --ai-bubble: #101018; /* Very dark blue-grey for AI messages, almost black */
            --input-bg: #030305; /* Extremely dark for input, a subtle whisper of difference from true black */

            /* Button Interactions */
            --button-hover-bg: #E0B500; /* A lighter, rich gold for button hover states */

            /* Code Blocks */
            --code-bg: #08080B; /* Darker code background */
            --code-text: var(--text-color);
            --code-border: var(--border-color);
            --code-header-bg: var(--tertiary-bg);
            --code-header-border: var(--user-bubble);

            /* Inline Code - Now with black text on royal gold */
            --inline-code-bg: var(--accent-color); /* Solid royal gold background */
            --inline-code-color: var(--text-on-accent); /* Black text on the gold */

            /* Message Actions */
            --message-action-bg: rgba(0, 0, 0, 0.7); /* Adjusted to new primary background */
            --message-action-user-bg: rgba(25, 25, 30, 0.7); /* Adjusted to new user bubble background */
            --message-action-icon: #C0C0C0;
            --message-action-icon-hover: var(--text-color);

            /* Avatars & Cosmic Glows */
            --user-avatar-bg: #222222; /* Darker grey for generic user avatar */
            --cosmic-glow-color-1: #CCAA00; /* Uses the new royal gold for glow */
            --cosmic-glow-color-2: #D08000; /* Slightly more burnt orange for the secondary glow */
            --cosmic-star-color: var(--text-color);
        }

        /* Neon Glitch Theme */
        body.neon-glitch {
            --primary-bg: #02010A; /* Very dark blue-black */
            --secondary-bg: #0F0A20; /* Dark blue-purple */
            --tertiary-bg: #1A1030; /* Deeper purple */
            --text-color: #E0FFFF; /* Electric light blue */
            --accent-color: #00E0FF; /* Bright cyan/aqua neon */
            --border-color: #2A1F45; /* Darker purple-blue */
            --user-bubble: #301A50; /* Deep purple for user */
            --ai-bubble: #15082A; /* Even darker purple for AI */
            --input-bg: #0A0515;
            --button-hover-bg: #00B0CC; /* Slightly darker neon */
            --shadow-color: rgba(0, 0, 0, 0.7);
            --code-bg: #080415;
            --code-text: #B0FFFF;
            --code-border: #2A1F45;
            --code-header-bg: #1A1030;
            --code-header-border: #301A50;
            --inline-code-bg: rgba(0, 224, 255, 0.25);
            --inline-code-color: var(--accent-color);
            --message-action-bg: rgba(2, 1, 10, 0.7);
            --message-action-user-bg: rgba(48, 26, 80, 0.7);
            --message-action-icon: #B0FFFF;
            --message-action-icon-hover: #E0FFFF;
            --user-avatar-bg: #20103A;
            --cosmic-glow-color-1: #00E0FF; /* Neon blue glow */
            --cosmic-glow-color-2: #FF00FF; /* Neon pink glow */
            --cosmic-star-color: #E0FFFF;
            --text-on-accent: #000000;
        }

        /* Ancient Papyrus Theme */
        body.ancient-papyrus {
            --primary-bg: #FDF6E3; /* Light cream/parchment background */
            --secondary-bg: #FFF8EB; /* Whiter cream for containers */
            --tertiary-bg: #E8E0C9; /* Slightly darker cream for headers/inputs */
            --text-color: #4A3A2B; /* Dark brown/sepia text */
            --accent-color: #A0522D; /* Earthy terracotta/sienna */
            --border-color: #D3C7B0; /* Muted brown border */
            --user-bubble: #F0E8D7; /* Light tan user bubble */
            --ai-bubble: #FCF5E0; /* Very pale cream AI bubble */
            --input-bg: #FBF4E0;
            --button-hover-bg: #8B4513; /* Darker earthy brown */
            --shadow-color: rgba(0, 0, 0, 0.1); /* Very light shadow */
            --code-bg: #E8E0C9;
            --code-text: #4A3A2B;
            --code-border: #D3C7B0;
            --code-header-bg: #DCCFA7;
            --code-header-border: #C8B99D;
            --inline-code-bg: rgba(160, 82, 45, 0.1);
            --inline-code-color: var(--accent-color);
            --message-action-bg: rgba(255, 255, 255, 0.7);
            --message-action-user-bg: rgba(240, 232, 215, 0.7);
            --message-action-icon: #666;
            --message-action-icon-hover: var(--text-color);
            --user-avatar-bg: #B0A080;
            --cosmic-glow-color-1: #D2B48C; /* Tan/parchment glow */
            --cosmic-glow-color-2: #B8860B; /* Golden brown glow */
            --cosmic-star-color: #4A3A2B; /* Dark specks as 'stars' */
            --text-on-accent: #FFFFFF;
        }


        /* Base Body Styles - Cosmic Overlay */
        body {
            font-family: var(--font-family-primary);
            background: linear-gradient(135deg, var(--primary-bg), var(--secondary-bg));
            color: var(--text-color);
            margin: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            overflow: hidden; 
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            transition: background 0.6s ease, color 0.6s ease;
            position: relative; /* Needed for cosmic background pseudo-element */
        }
        /* Cosmic Body Background */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            /* Subtle nebula effect with radial gradients */
            background: radial-gradient(circle at 15% 50%, var(--cosmic-glow-color-1) 0%, transparent 40%),
                        radial-gradient(circle at 85% 20%, var(--cosmic-glow-color-2) 0%, transparent 35%),
                        radial-gradient(circle at 40% 90%, var(--cosmic-glow-color-1) 0%, transparent 30%);
            background-size: 200% 200%; /* Make gradients larger to animate */
            animation: cosmicNebula 20s infinite alternate ease-in-out;
            z-index: -1; /* Behind everything */
            pointer-events: none; /* Don't block clicks */
            transition: background 0.6s ease;
        }

        @keyframes cosmicNebula {
            0% { background-position: 0% 0%; }
            100% { background-position: 100% 100%; }
        }

        /* Chatbot Container (Main Application) */
        .chatbot-container {
            background-color: var(--secondary-bg);
            border-radius: 25px;
            box-shadow: 0 15px 30px var(--shadow-color);
            width: 90%;
            max-width: 700px; 
            height: 90vh; 
            display: flex;
            overflow: hidden;
            border: 2px solid var(--border-color);
            animation: fadeIn 0.8s ease-out;
            position: relative; 
            transition: background-color 0.6s ease, border-color 0.6s ease, box-shadow 0.6s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Chat Sidebar */
        .chat-sidebar {
            width: 280px; /* Default open width for desktop */
            flex-shrink: 0; /* Prevents sidebar from shrinking */
            background-color: var(--tertiary-bg);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            padding: 20px 15px;
            transition: width 0.3s ease-in-out, transform 0.3s ease-in-out, background-color 0.6s ease, border-color 0.6s ease;
            z-index: 20; /* Ensure sidebar is above main content if needed */
            box-shadow: 2px 0 10px rgba(0,0,0,0.3); /* Subtle shadow */
            overflow-y: auto; /* Enable scrolling for sidebar content */
        }
        .chat-sidebar::-webkit-scrollbar {
            width: 6px;
        }
        .chat-sidebar::-webkit-scrollbar-track {
            background: var(--primary-bg); 
            border-radius: 10px;
        }
        .chat-sidebar::-webkit-scrollbar-thumb {
            background-color: var(--accent-color); 
            border-radius: 10px;
            border: 1px solid var(--primary-bg); 
        }

        .chat-sidebar .sidebar-header {
            display: flex;
            flex-wrap: wrap; /* Allows items to wrap if space is constrained */
            align-items: center;
            justify-content: space-between; /* Pushes items to ends */
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border-color);
        }
        .chat-sidebar .sidebar-header h3 {
            margin: 0 10px; /* Adjust margin for spacing from buttons */
            flex-grow: 1; /* Allows title to take available space */
            text-align: center; /* Center the title visually */
            color: var(--accent-color);
            font-family: var(--font-family-secondary);
            font-size: 1.2em;
        }

        /* New Chat Button (now within sidebar) */
        #newChatBtn {
            position: static; /* No longer absolutely positioned */
            margin-right: 0; /* Remove old margin to let justify-content handle spacing */
            background-color: var(--accent-color);
            color: var(--text-on-accent);
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.8em;
            font-family: var(--font-family-primary);
            font-weight: 600;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease, transform 0.2s ease, color 0.6s ease;
            z-index: 3; 
            display: flex;
            align-items: center;
            gap: 4px;
        }
        #newChatBtn:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-1px);
        }
        #newChatBtn:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        #newChatBtn .lucide {
            width: 0.9em;
            height: 0.9em;
        }

        /* Toggle Sidebar Button (inside sidebar, 'X' icon for mobile close) */
        #toggleSidebarBtn {
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: none; /* Hidden by default, shown on mobile when sidebar open */
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s ease;
        }
        #toggleSidebarBtn:hover {
            background-color: rgba(255,255,255,0.1);
        }

        /* Sidebar Section Styling */
        .sidebar-section {
            margin-bottom: 1rem;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 0.5rem;
            background-color: var(--secondary-bg);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.6s ease, border-color 0.6s ease, box-shadow 0.6s ease;
        }
        .sidebar-section h4 {
            margin-top: 0;
            margin-bottom: 0.75rem;
            color: var(--accent-color);
            font-family: var(--font-family-secondary);
            font-size: 1.1em;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 0.5rem;
            transition: color 0.6s ease, border-color 0.6s ease;
        }
        /* Style for regular buttons within sidebar sections */
        .sidebar-section button {
            background-color: var(--accent-color); /* Default button color */
            color: var(--text-on-accent);
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease, transform 0.2s ease, color 0.6s ease;
            display: flex; /* For icons */
            align-items: center;
            justify-content: center;
            gap: 0.5rem; /* Space between text and icon */
        }
        .sidebar-section button:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-1px);
        }
        .sidebar-section button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        /* Theme Selector Styling */
        .theme-selector-container {
            display: flex;
            flex-direction: column; /* Stack them vertically */
            gap: 8px; /* Space between toggles */
        }
        .theme-selector-container label { 
            color: var(--text-color); 
            transition: color 0.6s ease;
            font-size: 0.8em; /* Smaller text */
            vertical-align: middle;
            line-height: 1; 
        }
        .theme-selector-container select {
            background-color: var(--input-bg);
            color: var(--text-color);
            border: 1px solid var(--border-color);
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8em;
            transition: background-color 0.6s ease, color 0.6s ease, border-color 0.6s ease;
            cursor: pointer;
            -webkit-appearance: none; /* Remove default dropdown arrow for custom styling */
            -moz-appearance: none;
            appearance: none;
            background-repeat: no-repeat;
            background-position: right 8px center;
            padding-right: 28px; /* Make space for the custom arrow */
        }
        .theme-selector-container select:hover {
            background-color: var(--secondary-bg);
        }
        /* Dynamic SVG for select arrow */
        .theme-selector-container select[data-arrow-color] {
            background-image: var(--select-arrow-svg, url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"/></svg>'));
        }

        /* NEW: Sidebar Version Link Styling */
        .sidebar-version-link {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.9em;
            font-weight: 600;
            cursor: pointer;
            border: none;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            background-color: var(--secondary-bg); /* Use secondary-bg as base */
            color: var(--text-color);
            transition: background-color 0.3s ease, transform 0.2s ease, color 0.6s ease, box-shadow 0.3s ease;
            text-decoration: none; /* Remove underline from links */
        }
        .sidebar-version-link:hover {
            background-color: var(--tertiary-bg);
            transform: translateY(-1px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        .sidebar-version-link:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.15);
        }
        .sidebar-version-link .lucide {
            color: var(--accent-color); /* Icons use accent color */
            flex-shrink: 0;
        }
        .sidebar-version-link.current-version {
            background-color: var(--accent-color);
            color: var(--text-on-accent);
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
        }
        .sidebar-version-link.current-version .lucide {
            color: var(--text-on-accent);
        }
        .sidebar-version-link.current-version:hover {
            background-color: var(--button-hover-bg);
        }


        /* Main Chat Content */
        .chat-main-content {
            flex-grow: 1; /* Takes remaining space */
            display: flex;
            flex-direction: column;
            overflow: hidden; /* Important for chat history scroll */
            transition: width 0.3s ease-in-out;
            border-top-left-radius: 23px; /* Apply to main content for desktop if sidebar is open */
            border-bottom-left-radius: 23px; /* Apply to main content for desktop if sidebar is open */
        }

        /* Header */
        .chatbot-header {
            background-color: var(--tertiary-bg);
            padding: 15px; 
            border-bottom: 2px solid var(--border-color);
            text-align: center;
            border-top-left-radius: 23px; /* Keep radius for main header */
            border-top-right-radius: 23px; /* Keep radius for main header */
            position: relative;
            overflow: hidden;
            z-index: 10; 
            transition: background-color 0.6s ease, border-color 0.6s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0; 
        }
        
        .chatbot-header .header-content {
            position: relative;
            z-index: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }

        .chatbot-header h1 {
            margin: 0;
            font-size: 2em; 
            color: var(--accent-color);
            font-family: var(--font-family-secondary);
            font-weight: 600;
            letter-spacing: 1px;
            text-shadow: 0 0 10px var(--cosmic-glow-color-1), 0 0 20px var(--cosmic-glow-color-2);
            transition: color 0.6s ease, text-shadow 0.6s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .chatbot-header .logo {
            height: 2.5em; 
            width: auto;
            object-fit: contain;
            filter: drop-shadow(0 0 5px var(--cosmic-glow-color-1));
            transition: filter 0.6s ease;
        }

        .chatbot-header .tagline {
            font-family: var(--font-family-secondary);
            font-size: 0.9em;
            color: var(--text-color);
            opacity: 0.7;
            margin: 0;
            font-style: italic;
            transition: color 0.6s ease;
        }

        .chatbot-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle at center, var(--cosmic-glow-color-1) 0%, transparent 70%);
            transform: rotate(45deg);
            animation: headerGlow 8s infinite alternate ease-in-out, pulseGlow 4s infinite alternate ease-in-out;
            z-index: 1;
            transition: background 0.6s ease;
        }

        @keyframes headerGlow {
            0% { transform: scale(0.8) rotate(0deg); opacity: 0.6; }
            50% { transform: scale(1.1) rotate(180deg); opacity: 0.8; }
            100% { transform: scale(0.8) rotate(360deg); opacity: 0.6; }
        }
        @keyframes pulseGlow {
            0% { box-shadow: 0 0 15px var(--cosmic-glow-color-1); }
            100% { box-shadow: 0 0 25px var(--cosmic-glow-color-2); }
        }

        /* Mobile Sidebar Toggle (Hamburger icon in main header) */
        #mobileToggleSidebarBtn {
            position: absolute;
            top: 20px; /* Aligns with original newChatBtn */
            left: 20px; /* Aligns with original newChatBtn */
            background-color: var(--tertiary-bg);
            color: var(--text-color);
            padding: 10px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: none; /* Hidden by default, shown on mobile */
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease, transform 0.2s ease;
            z-index: 15; /* Ensure it's above other header elements */
        }
        #mobileToggleSidebarBtn:hover {
            background-color: var(--secondary-bg);
            transform: translateY(-1px);
        }
        #mobileToggleSidebarBtn:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }

        /* NEW: Desktop Sidebar Toggle Button */
        #desktopToggleSidebarBtn {
            position: absolute;
            top: 50%;
            right: 20px; /* Adjust as needed */
            transform: translateY(-50%);
            background-color: var(--tertiary-bg); /* Match header background */
            color: var(--text-color);
            padding: 10px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: none; /* Hidden by default, shown by media query */
            align-items: center;
            justify-content: center;
            border: none;
            cursor: pointer;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            transition: background-color 0.3s ease, transform 0.2s ease, color 0.6s ease;
            z-index: 15; /* Ensure it's above other header elements */
        }
        #desktopToggleSidebarBtn:hover {
            background-color: var(--secondary-bg);
            transform: translateY(-50%) translateY(-1px); /* Keep vertical centering */
        }
        #desktopToggleSidebarBtn:active {
            transform: translateY(-50%) translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        #desktopToggleSidebarBtn .lucide {
            width: 1.25em;
            height: 1.25em;
        }

        /* Responsive Adjustments */
        @media (max-width: 768px) {
            /* ... existing rules ... */
            #mobileToggleSidebarBtn {
                display: flex; /* Show on mobile */
            }
            #toggleSidebarBtn { /* 'X' button inside sidebar */
                display: flex; 
            }
            #desktopToggleSidebarBtn {
                display: none; /* Hide on mobile */
            }

            /* ... existing mobile sidebar/main content adjustments ... */
            .chat-sidebar {
                /* ... existing styles ... */
                width: min(80vw, 320px); /* Reset width for mobile transform */
                padding: 15px; /* Reset padding for mobile */
                overflow-y: auto; /* Ensure scroll on mobile */
            }
        }

        /* Desktop specific styles (min-width: 769px) */
        @media (min-width: 769px) {
            #mobileToggleSidebarBtn {
                display: none; /* Hide hamburger on desktop */
            }
            #toggleSidebarBtn {
                display: none; /* Hide 'X' button on desktop (only needed for mobile sidebar close) */
            }
            /* NEW: Show desktop toggle on desktop */
            #desktopToggleSidebarBtn {
                display: flex; /* Show on desktop */
            }

            /* When sidebar is closed on desktop, main content should have full container radius */
            .chat-main-content.sidebar-hidden {
                border-top-left-radius: 23px;
                border-bottom-left-radius: 23px;
            }
            /* Sidebar is initially open on desktop, so main content starts with no left radius */
            .chat-main-content:not(.sidebar-hidden) {
                border-top-left-radius: 0;
                border-bottom-left-radius: 0;
            }
            /* NEW: Ensure sidebar returns to desktop defaults if resizing from mobile */
            .chat-sidebar {
                position: static; /* No fixed position on desktop */
                transform: translateX(0); /* No transform on desktop */
                box-shadow: 2px 0 10px rgba(0,0,0,0.3); /* Restore shadow on desktop */
                width: 280px; /* Default open width */
                padding: 20px 15px; /* Default padding */
                overflow-y: auto; /* Ensure scrolling */
            }
        }


        /* Chat History */
        .chat-history {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 15px;
            scroll-behavior: smooth;
            padding-bottom: 30px; /* Increased padding to give more space from input */
        }

        .chat-history::-webkit-scrollbar {
            width: 8px;
        }

        .chat-history::-webkit-scrollbar-track {
            background: var(--primary-bg); 
            border-radius: 10px;
            transition: background 0.6s ease;
        }

        .chat-history::-webkit-scrollbar-thumb {
            background-color: var(--accent-color); 
            border-radius: 10px;
            border: 2px solid var(--primary-bg); 
            transition: background-color 0.6s ease, border-color 0.6s ease;
        }

        /* Message Bubbles */
        .chat-message {
            max-width: 80%;
            line-height: 1.5;
            word-wrap: break-word;
            animation: cosmicRiseIn 0.5s ease-out; /* NEW: Cosmic Rise In */
            position: relative; 
            font-size: 0.95rem; 
            display: flex; /* Make messages a flex container for avatar */
            align-items: flex-start; /* Align items to the top */
        }
        .chat-message.editing {
            border: 2px dashed var(--accent-color);
            opacity: 0.8;
            box-shadow: 0 0 10px rgba(192, 112, 255, 0.5);
        }

        /* NEW: Cosmic Rise In Animation */
        @keyframes cosmicRiseIn {
            from { opacity: 0; transform: translateY(20px) scale(0.95); }
            to { opacity: 1; transform: translateY(0) scale(1); }
        }

        /* NEW: Avatar Styling */
        .chat-avatar {
            width: 40px; /* Avatar size */
            height: 40px;
            border-radius: 50%; /* Circular avatar */
            object-fit: cover;
            flex-shrink: 0; /* Prevent avatar from shrinking */
            margin: 0 10px; /* Space between avatar and bubble */
            border: 2px solid var(--border-color); /* Subtle border */
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            transition: border-color 0.6s ease, box-shadow 0.6s ease;
        }

        /* NEW: Generic Lucide Avatar Icon Styling */
        .lucide-avatar-icon {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--user-avatar-bg); /* Themed background */
            color: var(--accent-color); /* Accent color for the icon */
            flex-shrink: 0;
            margin: 0 10px;
            border: 2px solid var(--border-color);
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
            transition: background-color 0.6s ease, color 0.6s ease, border-color 0.6s ease, box-shadow 0.6s ease;
        }
        .lucide-avatar-icon .lucide {
            width: 1.5em; /* Larger icon inside avatar circle */
            height: 1.5em;
            stroke-width: 1.5; /* Make the icon a bit bolder */
        }

        /* Message Bubble Content Wrapper */
        .message-bubble-content {
            padding: 12px 18px; /* This is where the actual bubble padding goes */
            border-radius: 20px;
            line-height: 1.5;
            word-wrap: break-word;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            flex-grow: 1; /* Allow content to take available space */
            position: relative; /* For actions inside */
            padding-bottom: 2.5rem; /* Ensure space for actions */
            transition: background-color 0.6s ease, color 0.6s ease, background-image 0.6s ease, box-shadow 0.6s ease;
            min-width: 0;
            overflow: auto;
            /* FIX: Ensure minimum height for action buttons */
            min-height: 4.5rem; /* Sufficient height for text + action buttons at the bottom */
        }

        .chat-message.user {
            margin-left: auto; /* Pushes user message to the right */
            flex-direction: row-reverse; /* Avatar on the right for user */
        }
        .chat-message.user .message-bubble-content {
            background-color: var(--user-bubble);
            color: var(--text-color);
            border-bottom-right-radius: 5px; 
            background-image: linear-gradient(to bottom right, var(--user-bubble), color-mix(in srgb, var(--user-bubble) 90%, black 10%)); /* Dynamic darker shade */
        }

        .chat-message.ai {
            margin-right: auto; /* Pushes AI message to the left */
            flex-direction: row; /* Avatar on the left for AI */
        }
        .chat-message.ai .message-bubble-content {
            background-color: var(--ai-bubble);
            color: var(--text-color);
            border-bottom-left-radius: 5px; 
            background-image: linear-gradient(to bottom left, var(--ai-bubble), color-mix(in srgb, var(--ai-bubble) 90%, black 10%)); /* Dynamic darker shade */
        }

        /* Markdown Styling within AI messages */
        .chat-message .message-content {
            padding: 0; 
            margin: 0;
        }
        .chat-message.ai .message-content p,
        .chat-message.ai .message-content ul,
        .chat-message.ai .message-content ol,
        .chat-message.ai .message-content h1,
        .chat-message.ai .message-content h2,
        .chat-message.ai .message-content h3,
        .chat-message.ai .message-content blockquote {
            margin-bottom: 1em;
            transition: color 0.6s ease; /* For changing heading colors */
        }
        .chat-message.ai .message-content h1,
        .chat-message.ai .message-content h2,
        .chat-message.ai .message-content h3 {
            color: var(--accent-color); /* Headings use accent color */
        }

        .chat-message.ai .message-content p:last-child,
        .chat-message.ai .message-content ul:last-child,
        .chat-message.ai .message-content ol:last-child,
        .chat-message.ai .message-content blockquote:last-child {
            margin-bottom: 0;
        }
        .chat-message.ai .message-content ul,
        .chat-message.ai .message-content ol {
            padding-left: 1.5em; 
        }
        .chat-message.ai .message-content li {
            margin-bottom: 0.5em;
        }
        .chat-message.ai .message-content strong {
            font-weight: bold;
            color: var(--accent-color); 
            transition: color 0.6s ease;
        }
        .chat-message.ai .message-content em {
            font-style: italic;
        }
        .chat-message.ai .message-content blockquote {
            border-left: 4px solid var(--accent-color); /* Blockquotes use accent color */
            color: var(--text-color); /* Main text color for readability */
            padding-left: 1em;
            margin-left: 0;
            transition: border-color 0.6s ease, color 0.6s ease;
        }

        /* Code block specific styling */
        .code-block-container {
            background-color: var(--code-bg); 
            color: var(--code-text); 
            border-radius: 0.75rem; 
            margin-top: 1rem;
            margin-bottom: 1rem;
            overflow-y: hidden; 
            border: 1px solid var(--code-border); 
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: background-color 0.6s ease, color 0.6s ease, border-color 0.6s ease;
        }
        .code-block-container pre {
            margin: 0; 
            padding: 1rem;
            overflow-x: auto; 
            font-family: 'Consolas', 'Fira Code', 'Cascadia Code', monospace; 
            font-size: 0.9em;
            line-height: 1.4;
        }
        .code-block-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--code-header-bg); 
            color: var(--text-color); 
            padding: 0.5rem 1rem;
            border-bottom: 1px solid var(--code-header-border);
            font-size: 0.85em;
            border-top-left-radius: 0.75rem;
            border-top-right-radius: 0.75rem;
            transition: background-color 0.6s ease, color 0.6s ease, border-color 0.6s ease;
        }
        .code-block-copy-button {
            background-color: transparent;
            border: none;
            color: var(--text-color); /* Code header text color */
            cursor: pointer;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease, color 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.25rem;
            font-size: 0.85em;
        }
        .code-block-copy-button:hover {
            background-color: color-mix(in srgb, var(--code-header-bg) 80%, white 20%); /* Lighter hover based on header */
            color: var(--text-color); 
        }
        /* Inline code */
        .chat-message.ai .message-content code:not(pre > code) {
            background-color: var(--inline-code-bg); 
            border-radius: 0.25rem;
            padding: 0.2em 0.4em;
            font-family: 'Consolas', monospace;
            font-size: 0.9em;
            color: var(--inline-code-color); 
            transition: background-color 0.6s ease, color 0.6s ease;
        }
        /* Links */
        .chat-message.ai .message-content a {
            color: var(--accent-color);
            text-decoration: underline;
            transition: color 0.6s ease;
        }
        .chat-message.ai .message-content a:hover {
            color: var(--button-hover-bg); 
        }

        /* Message Action Buttons (Copy/Dictate/Edit/Regenerate) */
        .message-actions {
            position: absolute; /* Changed to absolute for Lite Version */
            bottom: 0.5rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.75rem;
            backdrop-filter: blur(5px);
            transition: opacity 0.3s ease;
            opacity: 0; 
            z-index: 10;
            background-color: var(--message-action-bg);
        }
        /* Make actions visible when the entire message (including avatar) is hovered */
        .chat-message:hover .message-actions {
            opacity: 1; 
        }
        .message-actions button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0.25rem;
            border-radius: 0.375rem;
            transition: background-color 0.2s ease, color 0.2s ease;
            display: flex; 
            align-items: center;
            justify-content: center;
        }
        .message-actions button .lucide { 
            color: var(--message-action-icon); 
            width: 1rem;
            height: 1rem;
            transition: color 0.6s ease;
        }
        .message-actions button:hover .lucide {
            color: var(--message-action-icon-hover); 
        }
        .message-actions button:hover {
            background-color: rgba(255, 255, 255, 0.1); 
        }
        .chat-message.user .message-actions {
            background-color: var(--message-action-user-bg);
        }
        /* Specific attachment preview styling within messages (not the input area ones) */
        .chat-message-attachment-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 1rem;
            background-color: var(--tertiary-bg); 
            color: var(--text-color); 
            font-size: 0.875rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transition: background-color 0.6s ease, color 0.6s ease, box-shadow 0.6s ease;
        }

        /* Input Area */
        .chat-input {
            padding: 20px;
            border-top: 2px solid var(--border-color);
            display: flex;
            gap: 10px; 
            align-items: end; 
            background-color: var(--tertiary-bg);
            border-bottom-left-radius: 23px;
            border-bottom-right-radius: 23px;
            position: relative; 
            transition: background-color 0.6s ease, border-color 0.6s ease;
            flex-shrink: 0; 
        }

        .chat-input textarea {
            flex-grow: 1;
            padding: 10px 15px; 
            border: 1px solid var(--border-color);
            border-radius: 25px;
            background-color: var(--input-bg);
            color: var(--text-color);
            font-family: var(--font-family-primary);
            font-size: 1em;
            resize: none;
            outline: none;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.3);
            transition: border-color 0.3s ease, background-color 0.3s ease, color 0.6s ease;
            min-height: 40px; 
            height: auto; 
            overflow-y: hidden; 
        }

        .chat-input textarea:focus {
            border-color: var(--accent-color);
            background-color: color-mix(in srgb, var(--primary-bg) 90%, var(--tertiary-bg) 10%); 
        }

        /* Action buttons in input area (Send, Mic, Paperclip) */
        .chat-input .icon-button { 
            background-color: var(--tertiary-bg); 
            color: var(--text-color);
            border: none;
            border-radius: 50%; 
            width: 48px; 
            height: 48px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.2s ease, color 0.6s ease;
            box-shadow: 0 2px 5px rgba(0,0,0,0.2); 
            display: flex; 
            align-items: center;
            justify-content: center;
            flex-shrink: 0; 
        }

        .chat-input .icon-button:hover {
            background-color: var(--secondary-bg); 
            transform: translateY(-1px);
        }
        .chat-input .icon-button:active {
            transform: translateY(0);
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        .chat-input .icon-button .lucide {
            width: 1.25em; 
            height: 1.25em;
        }

        #sendButton {
            background-color: var(--accent-color); 
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.3); 
            transition: background-color 0.3s ease, transform 0.2s ease, box-shadow 0.3s ease, opacity 0.3s ease, cursor 0.3s ease;
        }
        #sendButton:hover {
            background-color: var(--button-hover-bg);
            transform: translateY(-2px);
        }
        #sendButton:active {
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        }
        /* Disabled state for the sendButton */
        #sendButton:disabled {
            background-color: var(--tertiary-bg); /* Match other icon buttons or a neutral color */
            cursor: not-allowed;
            opacity: 0.6; /* Indicate disabled state */
            box-shadow: none;
            transform: none;
        }
        #sendButton:disabled .lucide {
            color: var(--border-color); /* Faded icon color */
        }

        /* Loading Indicator - Cosmic Loader */
        .loader-container {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            height: 100%;
        }
        .loader-dot {
            width: 15px; /* Slightly larger */
            height: 15px;
            margin: 0 6px; /* More space */
            background-color: var(--accent-color);
            box-shadow: 0 0 10px var(--accent-color), 0 0 20px rgba(192, 112, 255, 0.5); /* Glow effect */
            border-radius: 50%;
            display: inline-block;
            animation: cosmicBounce 1.8s infinite ease-in-out both; /* Slower, more ethereal bounce */
            transition: background-color 0.6s ease, box-shadow 0.6s ease;
        }
        .loader-dot:nth-child(1) { animation-delay: -0.6s; }
        .loader-dot:nth-child(2) { animation-delay: -0.3s; }
        .loader-dot:nth-child(3) { animation-delay: 0s; }
        
        @keyframes cosmicBounce {
            0%, 100% {
                transform: translateY(0) scale(1);
                opacity: 0.8;
            }
            50% {
                transform: translateY(-10px) scale(1.2); /* Float up and enlarge slightly */
                opacity: 1;
                background-color: var(--cosmic-glow-color-1); /* Change color at peak */
            }
        }
        /* Voice input active state */
        .voice-input-active {
            background-color: var(--accent-error) !important; 
            animation: pulse-red 1s infinite cubic-bezier(0.4, 0, 0.6, 1);
        }
        @keyframes pulse-red {
            0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            50% { box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
        }

        /* Attachment Preview (in input area) */
        .chat-image {
            max-width: 100%;
            height: auto;
            border-radius: 0.75rem;
            margin-top: 0.5rem;
            display: block;
        }
        #chat-attachments-preview-container {
            background-color: var(--tertiary-bg);
            border-radius: 10px;
            padding: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.3);
            border: 1px solid var(--border-color);
            transition: background-color 0.6s ease, border-color 0.6s ease, box-shadow 0.6s ease;
        }
        .chat-attachment-preview-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 0.75rem;
            border-radius: 1rem;
            background-color: var(--secondary-bg); /* Use secondary for inner items */
            color: var(--text-color); 
            font-size: 0.875rem;
            box-shadow: 0 1px 2px rgba(0,0,0,0.2);
            transition: background-color 0.6s ease, color 0.6s ease, box-shadow 0.6s ease;
        }
        .chat-attachment-preview-item .remove-attachment-btn {
            background: none;
            border: none;
            color: var(--accent-color); 
            cursor: pointer;
            padding: 0.1rem;
            border-radius: 50%;
            transition: background-color 0.2s ease, color 0.6s ease;
        }
        .chat-attachment-preview-item .remove-attachment-btn:hover {
            background-color: rgba(192, 112, 255, 0.2);
        }

        /* Drag and Drop visual feedback for chat window */
        .chatbot-container.drag-over-active {
            border: 2px dashed var(--accent-color);
            box-shadow: 0 0 20px var(--accent-color), 0 0 30px var(--accent-color) inset;
            transition: border-color 0.6s ease, box-shadow 0.6s ease;
        }

        /* Copy Message Toast */
        #copy-message {
            position: fixed;
            bottom: 3rem; 
            left: 50%;
            transform: translateX(-50%);
            padding: 0.75rem 1.5rem;
            background-color: var(--accent-success);
            color: white;
            border-radius: 9999px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            opacity: 0;
            visibility: hidden;
            transition: all 0.5s ease-in-out;
            z-index: 100;
        }

        #copy-message.show {
            opacity: 1;
            visibility: visible;
        }

        /* Autocomplete Suggestions */
        #suggestions-container {
            position: absolute;
            bottom: 100%; /* Position above the input field */
            left: 0;
            right: 0;
            margin-bottom: 10px; /* Space between input and suggestions */
            background-color: var(--autocomplete-bg);
            border: 1px solid var(--autocomplete-border);
            border-radius: 10px;
            box-shadow: 0 -5px 15px rgba(0,0,0,0.2);
            max-height: 200px;
            overflow-y: auto;
            z-index: 20; /* Ensure it's above other input elements */
            transition: background-color 0.6s ease, border-color 0.6s ease, box-shadow 0.6s ease;
        }
        #suggestions-container ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        #suggestions-container li {
            padding: 10px 15px;
            cursor: pointer;
            color: var(--autocomplete-text);
            transition: background-color 0.2s ease, color 0.6s ease;
        }
        #suggestions-container li:hover,
        #suggestions-container li.selected {
            background-color: var(--autocomplete-hover-bg);
        }
        #suggestions-container li.selected {
            background-color: var(--autocomplete-selected-bg);
            color: var(--autocomplete-selected-text);
        }


        /* Responsive Adjustments */
        @media (max-width: 768px) {
            .chatbot-container {
                width: 95%;
                height: 95vh;
                border-radius: 15px;
            }

            /* Mobile Sidebar */
            .chat-sidebar {
                position: fixed; /* Fixed position for mobile sidebar */
                top: 0;
                left: 0;
                bottom: 0;
                width: min(80vw, 320px); /* Adjust width for mobile, max 320px or 80vw */
                transform: translateX(-100%); /* Hidden by default */
                transition: transform 0.3s ease-in-out;
                box-shadow: none; /* No shadow by default */
                padding: 15px;
                background-color: var(--tertiary-bg); /* Ensure background is set for overlay */
            }
            .chat-sidebar.active-mobile-sidebar {
                transform: translateX(0); /* Show on active */
                box-shadow: 2px 0 10px rgba(0,0,0,0.3); /* Add shadow when open */
            }
            /* Hide main content header's border-radius when sidebar is open */
            .chat-sidebar.active-mobile-sidebar + .chat-main-content .chatbot-header {
                border-top-left-radius: 0;
            }

            .chat-main-content {
                width: 100%; /* Main content always full width on mobile */
                border-top-left-radius: 13px; /* Apply to main content for mobile */
                border-bottom-left-radius: 13px; /* Apply to main content for mobile */
            }

            /* Mobile Header Adjustments */
            .chatbot-header {
                padding: 15px; 
                padding-left: 60px; /* Make space for hamburger */
                justify-content: center; /* Center content when hamburger is present */
                border-top-left-radius: 13px;
                border-top-right-radius: 13px;
            }
            .chatbot-header h1 {
                font-size: 1.8em;
                margin-top: 0; /* Remove top margin */
            }
            .chatbot-header .logo {
                height: 2em;
            }
            .chatbot-header .tagline {
                font-size: 0.8em;
                margin-bottom: 0;
            }

            /* Mobile specific toggle button (hamburger in main header) */
            #mobileToggleSidebarBtn {
                display: flex; /* Show on mobile */
                top: 15px;
                left: 15px;
                width: 40px;
                height: 40px;
            }
            /* Toggle button inside sidebar (X icon) */
            #toggleSidebarBtn {
                display: flex; /* Always show inside sidebar header on mobile */
            }
            
            .theme-selector-container label {
                font-size: 0.7em;
            }
            .theme-selector-container select {
                font-size: 0.7em;
                padding: 3px 6px;
                padding-right: 24px;
                background-position: right 6px center;
                background-size: 16px;
            }

            /* Sidebar New Chat Button (smaller for mobile sidebar) */
            #newChatBtn {
                padding: 5px 9px;
                font-size: 0.65em;
                gap: 3px;
            }
            #newChatBtn .lucide {
                width: 0.6em;
                height: 0.6em;
            }


            /* Chat Message Mobile Adjustments */
            .chat-history {
                padding: 10px;
                gap: 8px;
            }

            .chat-message {
                max-width: 95%; /* Wider bubbles for smaller screens */
            }
            .chat-avatar, .lucide-avatar-icon {
                width: 32px;
                height: 32px;
                margin: 0 6px;
            }
            .lucide-avatar-icon .lucide {
                width: 1.2em;
                height: 1.2em;
            }
            .message-bubble-content {
                padding: 10px 14px;
                padding-bottom: 2rem;
                border-radius: 16px;
                font-size: 0.9rem; /* Slightly larger for readability */
                min-height: 4rem; /* Adjusted for mobile */
            }

            .message-actions {
                bottom: 0.3rem; 
                right: 0.6rem;
                gap: 0.3rem;
                padding: 0.15rem 0.3rem;
                border-radius: 0.5rem;
            }
            .message-actions button {
                padding: 0.1rem;
            }
            .message-actions button .lucide {
                width: 0.8rem;
                height: 0.8rem;
            }

            .chat-input {
                padding: 10px;
                gap: 6px;
                align-items: center;
                border-bottom-left-radius: 13px;
                border-bottom-right-radius: 13px;
                flex-wrap: wrap; /* Allow buttons to wrap */
            }

            .chat-input textarea {
                padding: 8px 12px; 
                font-size: 0.9em;
                min-height: 38px;
                max-height: 120px;
            }

            .chat-input .icon-button {
                width: 42px;
                height: 42px;
            }
            .chat-input .icon-button .lucide {
                width: 1em;
                height: 1em;
            }

            #chat-attachments-preview-container {
                padding: 6px;
                margin-bottom: 8px;
            }
            .chat-attachment-preview-item {
                font-size: 0.75em;
                padding: 0.3rem 0.5rem;
                border-radius: 0.75rem;
            }
            .chat-attachment-preview-item .remove-attachment-btn .lucide {
                width: 0.7rem;
                height: 0.7rem;
            }

            #copy-message {
                bottom: 1.5rem;
                padding: 0.5rem 1rem;
                font-size: 0.85rem;
            }

            #suggestions-container {
                margin-bottom: 8px;
            }
            #suggestions-container li {
                padding: 8px 12px;
                font-size: 0.85em;
            }
        }

        /* Desktop specific styles (min-width: 769px) */
        @media (min-width: 769px) {
            #mobileToggleSidebarBtn {
                display: none; /* Hide hamburger on desktop */
            }
            #toggleSidebarBtn {
                display: none; /* Hide 'X' button on desktop (only needed for mobile sidebar close) */
            }
            /* When sidebar is closed on desktop, main content should have full container radius */
            .chat-main-content.sidebar-hidden {
                border-top-left-radius: 23px;
                border-bottom-left-radius: 23px;
            }
            /* Sidebar is initially open on desktop, so main content starts with no left radius */
            .chat-main-content:not(.sidebar-hidden) {
                border-top-left-radius: 0;
                border-bottom-left-radius: 0;
            }
        }
    </style>
</head>
<body class="antialiased cosmic-purple">
    <div class="chatbot-container">
        <!-- Sidebar -->
        <aside class="chat-sidebar" id="chatSidebar">
            <div class="sidebar-header">
                <button id="newChatBtn" title="Start a New Chat">
                    <span data-lucide="sparkles" class="w-4 h-4"></span>
                    New Chat
                </button>
                <h3 class="font-semibold text-lg">Settings</h3>
                <!-- Button to toggle sidebar visibility on mobile/smaller screens -->
                <button id="toggleSidebarBtn" title="Close Sidebar">
                    <span data-lucide="x" class="w-5 h-5"></span>
                </button>
            </div>

            <!-- Theme Selector -->
            <div class="sidebar-section theme-selector-container">
                <h4 class="font-semibold text-accent-color mb-2">Theme</h4>
                <label for="theme-select" class="font-primary text-sm sr-only">Select Theme:</label>
                <select id="theme-select" class="w-full">
                    <option value="cosmic-purple">Cosmic Purple</option>
                    <option value="starlight-lavender">Starlight Lavender</option>
                    <option value="emerald-galaxy">Emerald Galaxy</option>
                    <option value="crimson-nebula">Crimson Nebula</option>
                    <option value="golden-aurora">Golden Aurora</option>
                    <option value="cosmic-gold">Cosmic Gold</option>
                    <option value="neon-glitch">Neon Glitch</option>
                    <option value="ancient-papyrus">Ancient Papyrus</option>
                </select>
            </div>

            <!-- Export Current Chat Section -->
            <div class="sidebar-section">
                <h4 class="font-semibold text-accent-color mb-2">Export Chat</h4>
                <div class="flex flex-col gap-2">
                    <button id="exportTxtBtn">
                        <span data-lucide="file-text" class="w-4 h-4"></span> Export as TXT
                    </button>
                    <button id="exportPdfBtn">
                        <span data-lucide="file-text" class="w-4 h-4"></span> Export as PDF
                    </button>
                    <button id="exportMdBtn">
                        <span data-lucide="file-code" class="w-4 h-4"></span> Export as MD
                    </button>
                    <button id="exportJsonBtn"> <!-- New JSON Export Button -->
                        <span data-lucide="file-json" class="w-4 h-4"></span> Export as JSON
                    </button>
                </div>
            </div>
            
            <!-- NEW: Version Switcher Section -->
            <div class="sidebar-section">
                <h4 class="font-semibold text-accent-color mb-2">Switch Version</h4>
                <div class="flex flex-col gap-2">
                    <a href="https://mystic-vision-ai-standalone-chatbot.netlify.app/" target="_blank" class="sidebar-version-link">
                        <span data-lucide="zap" class="w-4 h-4"></span> Main Version
                    </a>
                    <a href="https://mystic-vision-ai-lite.netlify.app/" target="_blank" class="sidebar-version-link current-version">
                        <span data-lucide="sparkles" class="w-4 h-4"></span> Lite Version (Current)
                    </a>
                    <a href="https://mystic-vision-ai-basic.netlify.app/" target="_blank" class="sidebar-version-link">
                        <span data-lucide="feather" class="w-4 h-4"></span> Basic Version
                    </a>
                    <a href="https://mystic-vision-ai-mini.netlify.app/" target="_blank" class="sidebar-version-link">
                        <span data-lucide="atom" class="w-4 h-4"></span> Mini Version
                    </a>
                    <a href="https://cosmic-chat-ai-simple-ai-chatbot.netlify.app/" target="_blank" class="sidebar-version-link">
                        <span data-lucide="star" class="w-4 h-4"></span> Special Cosmic Version
                    </a>
                    <a href="https://small-ai-big-vision.netlify.app/" target="_blank" class="sidebar-version-link">
                        <span data-lucide="lightbulb" class="w-4 h-4"></span> Small AI
                    </a>
                    <a href="https://small-ai-big-vision-v2.netlify.app/" target="_blank" class="sidebar-version-link">
                        <span data-lucide="bot" class="w-4 h-4"></span> Small AI v2
                    </a>
                </div>
            </div>

        </aside>

        <!-- Main Chat Content -->
        <main class="chat-main-content" id="chatMainContent">
            <header class="chatbot-header">
                <!-- Hamburger/Sidebar toggle for mobile. -->
                <button id="mobileToggleSidebarBtn" title="Open Sidebar">
                    <span data-lucide="menu" class="w-5 h-5"></span>
                </button>

                <div class="header-content">
                    <h1>
                        <img src="logo.png" alt="Mystic Vision AI Lite Logo" class="logo"> <!-- Renamed logo alt -->
                        Mystic Vision AI Lite <!-- Renamed H1 title -->
                    </h1>
                    <p class="tagline">Experience the beyond</p>
                </div>

                <!-- NEW: Desktop Sidebar Toggle Button -->
                <button id="desktopToggleSidebarBtn" title="Toggle Sidebar" class="icon-button absolute right-4 top-1/2 -translate-y-1/2">
                    <span data-lucide="chevron-left" class="w-5 h-5"></span>
                </button>
            </header>
            <div class="chat-history" id="chatHistory">
                <!-- Initial AI message will be added by JS -->
            </div>
            <div class="chat-input" id="chatInputArea">
                <!-- Autocomplete Suggestions Container -->
                <div id="suggestions-container" class="hidden">
                    <ul id="suggestions-list"></ul>
                </div>

                <!-- Attachment preview -->
                <div id="chat-attachments-preview-container" class="mb-2 flex flex-wrap items-center gap-2 hidden absolute left-4 right-4" style="bottom: 100%; transform: translateY(-10px);">
                    <!-- Attachments previews will be dynamically added here -->
                </div>

                <!-- Voice Input Button -->
                <button id="voice-input-btn" class="icon-button" aria-label="Voice Input">
                    <span data-lucide="mic" class="w-5 h-5"></span>
                </button>

                <!-- Attach File Button (uses a label to link to the hidden file input) -->
                <label for="chat-image-upload" id="attach-file-btn" class="icon-button cursor-pointer" aria-label="Attach File">
                    <span data-lucide="paperclip" class="w-5 h-5"></span>
                </label>
                <input type="file" id="chat-image-upload" accept="image/*, .txt, .pdf, .csv, .json, .xml, .md" class="hidden" multiple>

                <textarea id="userInput" placeholder="Type your message..." rows="1"></textarea>
                
                <!-- Send/Stop Button (Combined) -->
                <button id="sendButton" class="icon-button">
                    <span data-lucide="send" class="w-5 h-5"></span>
                </button>
            </div>
        </main>
    </div>

    <!-- Temporary message for clipboard copy -->
    <div id="copy-message">Text copied to clipboard!</div>

    <!-- Prism.js components for common languages -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-css.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-markup.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-bash.min.js"></script>
    <!-- Add more Prism.js language components as needed -->

    <script>
        // !! IMPORTANT: REPLACE WITH YOUR ACTUAL GEMINI API KEY !!
        // !! DO NOT USE THIS METHOD IN PRODUCTION. USE A SERVER-SIDE PROXY. !!
        // The key below is a placeholder and WILL NOT WORK.
        const GEMINI_API_KEY = 'AIzaSyD7KfCynGxjHbPhr8bvP8Se0l8KrtyO0Ks'; // <--- REPLACE THIS WITH YOUR ACTUAL KEY
        // In the Lite version, the model is fixed, not selectable by the user.
        const DEFAULT_GEMINI_MODEL = 'gemini-2.5-flash-preview-09-2025'; 
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${DEFAULT_GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;

        // --- Global State Variables and Constants ---
        let conversationHistory = []; // Current chat's history (roles & parts)
        const CURRENT_CHAT_STORAGE_KEY = 'mv-lite-current-session-chat'; // Unique key for Lite version
        
        let chatAttachments = []; 
        const messageTextCache = new Map(); // Stores raw text for copy/dictate before Markdown parsing
        let currentUtterance = null;
        let isSpeaking = false;
        let isGeneratingResponse = false; // To control send/stop buttons
        
        let SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
        let recognition = null;
        let isVoiceInputActive = false;
        let finalTranscript = ''; 
        let selectedSuggestionIndex = -1;

        const initialAIMessage = {
            role: 'model',
            parts: [{ text: 'Greetings, seeker! I am Mystic Vision AI Lite, designed to help you glimpse the beyond. What wisdom do you seek?' }], // Renamed initial message
        };

        // Avatars
        const USER_AVATAR_ICON = 'user'; 
        const AI_AVATAR_URL = 'logo.png'; 

        const autocompleteSuggestions = [
            // Your extensive list of autocomplete suggestions
            // (Copied from Code 2 to ensure consistency and richness of suggestions)
            "What is the capital of France?",
            "Explain quantum physics simply.",
            "How does a combustion engine work?",
            "Summarize the plot of Hamlet.",
            "What are the benefits of exercise?",
            "Calculate the square root of 144.",
            "Convert 50 miles to kilometers.",
            "Define artificial intelligence.",
            "What is blockchain technology?",
            "Explain the internet.",
            "Tell me about renewable energy.",
            "What are the phases of the moon?",
            "How do volcanoes erupt?",
            "What causes tides?",
            "What is the speed of light?",
            "How does photosynthesis work?",
            "What are the main types of clouds?",
            "Explain the concept of infinity.",
            "What is the difference between AI and machine learning?",
            "How does GPS work?",

            // Creative Writing/Ideas
            "Write a short story about a talking animal.",
            "Compose a poem about the ocean.",
            "Give me five ideas for a fantasy novel.",
            "Write a dialogue between a robot and a human.",
            "Generate a catchy slogan for a coffee shop.",
            "Describe a futuristic city.",
            "Create a character profile for a wizard.",
            "Write a fairy tale with a modern twist.",
            "Brainstorm names for a new tech startup.",
            "Suggest topics for a blog about travel.",
            "Write an exciting opening paragraph for an horrific adventure story.",
            "Compose a haiku about autumn.",
            "Develop a plot for a sci-fi film.",
            "Write a humorous obituary.",
            "Describe a unique alien species.",

            // Programming/Tech Help
            "How to write a 'Hello, World!' program in Python?",
            "Explain asynchronous JavaScript.",
            "What is the best framework for web development?",
            "How to debug a Java application?",
            "Write a SQL query to select all users.",
            "Explain REST APIs.",
            "What is version control?",
            "How do I install Node.js?",
            "Explain recursion in programming.",
            "What are data structures?",
            "How to optimize a website for speed?",
            "Explain object-oriented programming.",
            "Write a simple HTML structure.",
            "What is cloud computing?",
            "How to secure a web application?",

            // Education/Learning
            "How to study effectively for exams?",
            "Tips for learning a new language.",
            "What are good resources for learning history?",
            "How to improve my public speaking skills?",
            "Suggest a good book for beginners in astrophysics.",
            "What are the benefits of lifelong learning?",
            "How to choose a university major?",
            "Explain critical thinking.",
            "What is metacognition?",
            "How to set SMART goals?",

            // Health/Wellness
            "What are the benefits of a balanced diet?",
            "Suggest a simple home workout routine.",
            "How to reduce stress naturally?",
            "What are common symptoms of flu?",
            "Explain the importance of sleep.",
            "Tips for maintaining mental health.",
            "What foods boost immunity?",
            "How to stay hydrated?",
            "What is mindfulness meditation?",
            "How to improve posture?",

            // Food/Cooking
            "Suggest a quick and healthy dinner recipe.",
            "How to bake a perfect chocolate chip cookie?",
            "What are common cooking herbs?",
            "Explain sous-vide cooking.",
            "Recipe for a vegan lasagna.",
            "How to make sourdough bread?",
            "Best way to store fresh produce.",

            // Travel/Culture
            "What are the top 5 tourist attractions in Rome?",
            "Suggest a budget-friendly travel destination.",
            "How to pack efficiently for a trip?",
            "Tell me about Japanese culture.",
            "What are some famous landmarks in India?",
            "Tips for solo travel.",
            "Explain local customs in Thailand.",

            // Self-Improvement/Productivity
            "How to build good habits?",
            "Tips for time management.",
            "How to overcome procrastination?",
            "Suggest ways to boost creativity.",
            "How to practice active listening?",
            "What are methods for conflict resolution?",
            "How to give constructive feedback?",

            // Environment/Sustainability
            "What is climate change?",
            "How to reduce my carbon footprint?",
            "Explain recycling processes.",
            "What is sustainable living?",
            "Tips for conserving water at home.",

            // Philosophical/Existential (keeping some of the original theme)
            "What is the meaning of life?",
            "How can I find inner peace?",
            "What is intuition?",
            "Explain the concept of enlightenment.",
            "What is the purpose of suffering?",
            "How can I connect with my higher self?",
            "What does synchronicity mean?",
            "Tell me about the law of attraction.",
            "How to cultivate compassion?",
            "What is the significance of dreams?",

            // And more... (Extensive additions)
            "Tell me a fun fact.",
            "What's the origin of the phrase 'break a leg'?",
            "Who invented the telephone?",
            "Explain the stock market.",
            "How to manage personal finances?",
            "What are common cybersecurity threats?",
            "Explain the concept of net neutrality.",
            "What is artificial general intelligence?",
            "How does facial recognition work?",
            "Tell me about virtual reality.",
            "What is augmented reality?",
            "Explain ethical AI.",
            "How to start a podcast?",
            "Tips for public speaking.",
            "What is imposter syndrome?",
            "How to build resilience?",
            "Explain the gig economy.",
            "What is CRISPR technology?",
            "How to make compost?",
            "What are the benefits of gardening?",
            "Tell me about Roman history.",
            "Explain the Cold War.",
            "What were the causes of World War II?",
            "Tell me about ancient Egypt.",
            "What is democracy?",
            "Explain socialism.",
            "What are human rights?",
            "How does voting work?",
            "What is diplomacy?",
            "Tell me about different types of governments.",
            "How does inflation affect the economy?",
            "What is GDP?",
            "Explain interest rates.",
            "What is a recession?",
            "How to save for retirement?",
            "What is compound interest?",
            "Tell me about different investment strategies.",
            "How to create a budget?",
            "What is credit score?",
            "Explain mortgages.",
            "What is insurance?",
            "How to write a resume?",
            "Tips for a job interview.",
            "How to negotiate salary?",
            "What are common career paths in tech?",
            "Explain emotional intelligence.",
            "How to build strong relationships?",
            "Tips for effective communication.",
            "How to handle difficult conversations?",
            "What is empathy?",
            "How to resolve conflict in relationships?",
            "Tell me about different personality types.",
            "What is positive psychology?",
            "How to practice self-care?",
            "What are common symptoms of flu?",
            "How to improve focus and concentration?",
            "What is the Pomodoro Technique?",
            "Explain the Eisenhower Matrix.",
            "How to prioritize tasks?",
            "Tips for remote work productivity.",
            "What is digital minimalism?",
            "How to manage screen time?",
            "What are the benefits of digital detox?",
            "Explain the concept of 'flow state'.",
            "How to overcome creative blocks?",
            "What are different learning styles?",
            "Tips for active reading.",
            "How to write an essay?",
            "Explain plagiarism.",
            "What is citation?",
            "How to do research effectively?",
            "What are open educational resources?",
            "Explain the peer review process.",
            "What is gamification in education?",
            "How to teach children about money?",
            "Tips for teaching a new skill.",
            "What is the Socratic method?",
            "Explain experiential learning.",
            "How to foster curiosity?",
            "What is problem-based learning?",
            "Tell me about different teaching philosophies.",
            "How to create engaging presentations?",
            "What are Bloom's Taxonomy levels?",
            "Explain formative assessment.",
            "What is summative assessment?",
            "How to provide effective feedback to students?",
            "Tips for classroom management.",
            "What is differentiated instruction?",
            "How to support students with learning disabilities?",
            "Explain inclusive education.",
            "What is homeschooling?",
            "How to choose a university major?",
            "What are extracurricular activities?",
            "Explain project-based learning.",
            "What is inquiry-based learning?",
            "How to promote critical thinking in students?",
            "What are the benefits of collaborative learning?",
            "How to use technology effectively in education?",
            "Explain blended learning.",
            "What is flipped classroom?",
            "How to assess student performance fairly?",
            "Tips for parent-teacher communication.",
            "What is social-emotional learning?",
            "How to build self-esteem in children?",
            "Explain the growth mindset.",
            "How to encourage creativity in children?",
            "What are different parenting styles?",
            "Tips for dealing with teenage rebellion.",
            "How to foster independence in children?",
            "What is positive reinforcement?",
            "Explain attachment theory.",
            "How to handle sibling rivalry?",
            "Tips for raising resilient children.",
            "What is childhood development?",
            "How to support children's emotional well-being?",
            "Explain the concept of play-based learning.",
            "What are the benefits of outdoor play?",
            "How to choose age-appropriate toys?",
            "What is early childhood education?",
            "Tips for preparing children for kindergarten.",
            "How to teach children to read?",
            "Explain phonics.",
            "What is whole language approach?",
            "How to help children with math?",
            "Tips for science experiments at home.",
            "How to introduce art to children?",
            "What is music education for kids?",
            "How to teach children about nature?",
            "Explain environmental education for kids.",
            "What are the benefits of storytelling for children?",
            "How to encourage imagination in children?",
            "Tips for screen time limits for kids.",
            "What are healthy eating habits for children?",
            "How to deal with picky eaters?",
            "Explain food allergies in children.",
            "How to encourage physical activity in children?",
            "What are developmental milestones?",
            "Tips for potty training.",
            "How to handle temper tantrums?",
            "What is positive discipline?",
            "Explain logical consequences.",
            "How to teach empathy to children?",
            "Tips for teaching generosity.",
            "How to foster gratitude in children?",
            "What is emotional regulation for kids?",
            "How to help children cope with big emotions?",
            "Explain resilience in children.",
            "What are coping mechanisms for kids?",
            "How to build a child's confidence?",
            "Tips for managing sibling relationships.",
            "How to prepare for a new baby?",
            "What is postpartum depression?",
            "How to support a partner after childbirth?",
            "Tips for new parents.",
            "What are common newborn challenges?",
            "How to breastfeed successfully?",
            "Explain bottle feeding.",
            "What is safe sleep for infants?",
            "How to manage infant crying?",
            "Tips for baby soothing techniques.",
            "What is colic?",
            "How to introduce solid foods to babies?",
            "Explain baby-led weaning.",
            "What are common baby illnesses?",
            "How to take a baby's temperature?",
            "Tips for infant first aid.",
            "What is toddler development?",
            "How to handle toddler tantrums?",
            "Explain the 'terrible twos'.",
            "How to encourage speech development in toddlers?",
            "Tips for toilet training toddlers.",
            "What are good toddler activities?",
            "How to promote social skills in toddlers?",
            "Explain parallel play.",
            "What is imaginative play?",
            "How to manage bedtime routines for toddlers?",
            "Tips for dealing with toddler sleep regressions.",
            "What are common toddler fears?",
            "How to ease separation anxiety in toddlers?",
            "Explain positive parenting.",
            "What is gentle parenting?",
            "How to set boundaries with toddlers?",
            "Tips for dealing with toddler biting or hitting.",
            "What is preschool development?",
            "How to prepare a child for preschool?",
            "Explain social skills for preschoolers.",
            "What are good preschool activities?",
            "How to teach preschoolers letters and numbers?",
            "Tips for improving fine motor skills in preschoolers.",
            "What is gross motor skills?",
            "How to encourage independent play in preschoolers?",
            "Explain cooperative play.",
            "What is dramatic play?",
            "How to foster problem-solving skills in preschoolers?",
            "Tips for managing preschooler behavior challenges.",
            "What is kindergarten readiness?",
            "How to support children's transition to school?",
            "Explain school-age development.",
            "What are academic skills for school-age children?",
            "How to help with homework?",
            "Tips for building good study habits.",
            "What are common learning challenges in school-age children?",
            "How to support children with ADHD?",
            "Explain dyslexia.",
            "What are autism spectrum disorders?",
            "How to encourage reading in school-age children?",
            "Tips for developing writing skills.",
            "How to make math fun?",
            "What are benefits of extracurricular activities for school-age children?",
            "How to deal with bullying?",
            "Explain peer pressure.",
            "What is healthy self-esteem in school-age children?",
            "How to teach responsibility to school-age children?",
            "Tips for managing screen time for school-age children?",
            "What is adolescent development?",
            "How to communicate with teenagers?",
            "Explain puberty.",
            "What are common teenage challenges?",
            "How to support teenagers' mental health?",
            "Tips for discussing difficult topics with teenagers.",
            "What is identity formation in adolescence?",
            "How to navigate peer relationships in adolescence?",
            "Explain romantic relationships in adolescence.",
            "What are common teenage stressors?",
            "How to build resilience in teenagers?",
            "Tips for college application process.",
            "What is career exploration for teenagers?",
            "How to teach financial literacy to teenagers?",
            "Explain civic engagement for teenagers.",
            "What are global issues teenagers should know?",
            "How to encourage critical thinking in teenagers?",
            "Tips for managing stress as a teenager.",
            "What are healthy coping mechanisms for teenagers?",
            "How to promote self-advocacy in teenagers?",
            "Explain the concept of consent to teenagers.",
            "What is responsible social media use for teenagers?",
            "How to address cyberbullying?",
            "Tips for safe online interactions for teenagers.",
            "What are warning signs of substance abuse in teenagers?",
            "How to talk to teenagers about sex education?",
            "Explain reproductive health for teenagers.",
            "What are sexually transmitted infections (STIs)?",
            "How to teach healthy relationships to teenagers?",
            "Tips for managing emotions in adolescence.",
            "What is emotional regulation in teenagers?",
            "How to help teenagers develop empathy?",
            "Explain moral development in adolescence.",
            "What is character education for teenagers?",
            "How to encourage volunteering in teenagers?",
            "Tips for building leadership skills in teenagers.",
            "What is entrepreneurship for teenagers?",
            "How to foster innovation in teenagers?",
            "Explain design thinking for teenagers.",
            "What are future job skills?",
            "How to prepare teenagers for the future of work?",
            "Tips for developing a growth mindset in teenagers.",
            "What is neuroplasticity?",
            "How to improve memory?",
            "Explain cognitive biases.",
            "What is decision-making theory?",
            "How to improve problem-solving skills?",
            "Tips for creative thinking techniques.",
            "What is lateral thinking?",
            "How to brainstorm effectively?",
            "Explain mind mapping.",
            "What are logical fallacies?",
            "How to analyze arguments?",
            "Tips for persuasive writing.",
            "What is rhetoric?",
            "How to give a compelling presentation?",
            "Explain nonverbal communication.",
            "What is body language?",
            "How to read facial expressions?",
            "Tips for improving listening skills.",
            "What is active listening?",
            "How to build rapport?",
            "Explain emotional intelligence in leadership.",
            "What is servant leadership?",
            "How to motivate a team?",
            "Tips for conflict resolution in the workplace.",
            "What is negotiation strategy?",
            "How to conduct effective meetings?",
            "Explain project management methodologies.",
            "What is Agile development?",
            "How to manage risk in projects?",
            "Tips for effective delegation.",
            "What is time blocking?",
            "How to use productivity tools?",
            "Explain the 'Getting Things Done' (GTD) method.",
            "What is the 80/20 rule?",
            "How to overcome perfectionism?",
            "Tips for dealing with stress at work.",
            "What is work-life balance?",
            "How to prevent burnout?",
            "Explain mindfulness at work.",
            ""
        ];

        // --- DOM Elements (Declared here, assigned in load event) ---
        let chatbotContainer;
        let chatHistoryDiv;
        let userInput;
        let sendButton;
        let themeSelect;
        let copyMessage;
        let chatAttachmentsPreviewContainer;
        let chatImageUpload;
        let voiceInputBtn;
        let suggestionsContainer;
        let suggestionsList;
        let desktopToggleSidebarBtn;
        
        // Sidebar Elements
        let chatSidebar; 
        let newChatBtnSidebar; 
        let toggleSidebarBtn; 
        let mobileToggleSidebarBtn; 
        let chatMainContent;
        // Sidebar Export Buttons
        let exportTxtBtn;
        let exportPdfBtn;
        let exportMdBtn; 
        let exportJsonBtn; // New: JSON export button

        // Theme Constants (matching Code 2's theme definitions)
        const THEMES = [
            'cosmic-purple',
            'starlight-lavender',
            'emerald-galaxy',
            'crimson-nebula',
            'golden-aurora',
            'cosmic-gold',
            'neon-glitch',
            'ancient-papyrus'
        ];
        const DEFAULT_THEME = 'cosmic-purple';

        // --- Lucide Icon Helper ---
        const createIcons = () => {
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        };

        function updateButtonIcon(buttonElement, newIconName, classList = 'w-4 h-4') {
            let currentIconSvg = buttonElement.querySelector('.lucide');
            if (currentIconSvg) {
                currentIconSvg.remove();
            }

            const newIconSpan = document.createElement('span');
            newIconSpan.setAttribute('data-lucide', newIconName);
            newIconSpan.className = classList; 

            buttonElement.appendChild(newIconSpan);
           
            createIcons(); 
        }

        // Function to manage the send/stop button's appearance and enabled/disabled state
        function updateSendButtonState() {
            const hasInput = userInput.value.trim().length > 0 || chatAttachments.length > 0;

            if (isGeneratingResponse) {
                // AI is generating, button should be 'stop'
                updateButtonIcon(sendButton, 'square', 'w-5 h-5');
                sendButton.disabled = false; // Always enabled to stop
                sendButton.style.backgroundColor = 'var(--accent-error)'; // Red for stop
                sendButton.style.color = 'white'; // White icon for stop
            } else {
                // AI is idle, button should be 'send'
                updateButtonIcon(sendButton, 'send', 'w-5 h-5');
                sendButton.style.backgroundColor = 'var(--accent-color)'; // Default accent color for send
                sendButton.style.color = 'white'; // White icon for send
                if (hasInput) {
                    sendButton.disabled = false; // Enable if there's text or attachments
                } else {
                    sendButton.disabled = true; // Disable if no text and no attachments
                }
            }
        }

        // --- File Handling Helpers ---
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve({
                    mimeType: file.type || 'application/octet-stream', 
                    data: reader.result.split(',')[1]
                });
                reader.onerror = error => reject(error);
                reader.readAsDataURL(file);
            });
        };

        function getFileIcon(mimeType) {
            if (mimeType.startsWith('image/')) return 'image';
            if (mimeType === 'application/pdf') return 'file-text';
            if (mimeType.includes('text/')) return 'file-text';
            if (mimeType.includes('csv') || mimeType.includes('excel')) return 'file-spreadsheet';
            if (mimeType.includes('json') || mimeType.includes('xml') || mimeType.includes('code') || mimeType.includes('markdown')) return 'file-code';
            return 'file';
        }

        // --- Markdown.js Custom Renderer for Code Blocks ---
        const renderer = {
            code(token) { 
                const actualCodeContent = token.text; 
                const lang = token.lang;             

                const languageDisplay = lang ? `<span class="text-xs font-semibold uppercase text-gray-400">${lang}</span>` : '';
                const uniqueId = `code-block-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                
                // Prism.js expects the raw (unescaped) code string and will handle escaping and highlighting.
                const escapedCode = actualCodeContent
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#39;'); 

                return `
                    <div class="code-block-container">
                        <div class="code-block-header">
                            ${languageDisplay}
                            <button class="code-block-copy-button" data-copy-target="${uniqueId}">
                                <span data-lucide="clipboard" class="w-4 h-4"></span>
                                Copy code
                            </button>
                        </div>
                        <pre><code id="${uniqueId}" class="language-${lang || 'plaintext'}">${escapedCode}</code></pre>
                    </div>
                `;
            }
        };
        marked.use({ renderer });

        // --- Chat UI & Logic ---
        /**
         * Appends a chat message to the UI.
         * @param {string} role - 'user' or 'model'
         * @param {string} text - The raw text content of the message.
         * @param {Array} attachments - Array of attachment objects (for user messages).
         * @param {string} messageId - Optional ID for the message div.
         * @returns {object} An object containing references to the messageContentDiv and the full messageDiv.
         */
        function appendChatMessage(role, text, attachments = [], messageId = null) {
            const messageDiv = document.createElement('div');
            messageDiv.classList.add('chat-message', role);
            
            messageId = messageId || `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            messageDiv.dataset.messageId = messageId;
            
            // Store the raw text for copy/dictate before any display formatting
            messageTextCache.set(messageId, text); 

            // Create avatar element (img for AI, lucide icon for User)
            let avatarElement;
            if (role === 'user') {
                avatarElement = document.createElement('div');
                avatarElement.classList.add('lucide-avatar-icon');
                const userIconSpan = document.createElement('span');
                userIconSpan.setAttribute('data-lucide', USER_AVATAR_ICON);
                avatarElement.appendChild(userIconSpan);
                avatarElement.title = "You"; 
            } else {
                avatarElement = document.createElement('img');
                avatarElement.src = AI_AVATAR_URL;
                avatarElement.alt = 'Mystic Vision AI Lite Avatar'; // Renamed alt text
                avatarElement.classList.add('chat-avatar');
                avatarElement.title = "Mystic Vision AI Lite"; // Renamed title
            }

            // Create the content bubble wrapper
            const messageBubbleContent = document.createElement('div');
            messageBubbleContent.classList.add('message-bubble-content');

            // Create the actual message content area *inside* the bubble
            const messageContentDiv = document.createElement('div');
            messageContentDiv.classList.add('message-content');

            if (role === 'user') {
                messageContentDiv.innerHTML = `<span>${text}</span>`; // User text is plain HTML

                if (attachments.length > 0) {
                    const attachmentsContainer = document.createElement('div');
                    attachmentsContainer.classList.add('mt-2', 'flex', 'flex-wrap', 'gap-2');
                    attachments.forEach(attachment => {
                        if (attachment.mimeType.startsWith('image/')) {
                            attachmentsContainer.innerHTML += `<img src="data:${attachment.mimeType};base64,${attachment.data}" alt="${attachment.name || 'User attachment'}" class="chat-image w-24 h-24 object-cover">`;
                        } else {
                            attachmentsContainer.innerHTML += `
                                <div class="chat-message-attachment-item">
                                    <span data-lucide="${getFileIcon(attachment.mimeType)}" class="w-4 h-4 flex-shrink-0"></span>
                                    <span class="truncate max-w-[120px]">${attachment.name || 'File'}</span>
                                </div>
                            `;
                        }
                    });
                    messageContentDiv.appendChild(attachmentsContainer);
                }
                
                messageBubbleContent.appendChild(messageContentDiv); // Append user content to bubble
                messageDiv.appendChild(messageBubbleContent);
                messageDiv.appendChild(avatarElement); 
            } else { // AI message: content is parsed and rendered immediately in Lite version
                messageContentDiv.innerHTML = marked.parse(text);
                messageBubbleContent.appendChild(messageContentDiv);
                messageDiv.appendChild(avatarElement); 
                messageDiv.appendChild(messageBubbleContent);
            }
            
            // Add common actions to the messageBubbleContent (as a separate child)
            const actionsDiv = document.createElement('div');
            actionsDiv.classList.add('message-actions');
            actionsDiv.innerHTML = `
                <button class="copy-message-btn" title="Copy message" data-message-id="${messageId}">
                    <span data-lucide="clipboard" class="w-4 h-4"></span>
                </button>
                <button class="dictate-message-btn" title="Dictate message" data-message-id="${messageId}">
                    <span data-lucide="volume-2" class="w-4 h-4"></span>
                </button>
                ${role === 'user' ? `
                <button class="edit-message-btn" title="Edit message" data-message-id="${messageId}">
                    <span data-lucide="pencil" class="w-4 h-4"></span>
                </button>` : `
                <button class="regenerate-message-btn" title="Regenerate response" data-message-id="${messageId}">
                    <span data-lucide="rotate-ccw" class="w-4 h-4"></span>
                </button>`
                }
            `;
            messageBubbleContent.appendChild(actionsDiv); // Append actions as a *new child* of the bubble

            chatHistoryDiv.appendChild(messageDiv);
            
            setTimeout(() => {
                messageDiv.style.transform = 'scale(1)';
            }, 10);
            
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
            createIcons(); 

            // Return the specific message content div where text will eventually go
            // and the full messageDiv for Prism.highlightAllUnder(element.closest(...))
            return { messageContentDiv, messageDiv }; 
        }

        function toggleLoading(show) {
            let loadingIndicator = document.getElementById('loadingIndicator');
            if (show) {
                isGeneratingResponse = true;
                if (!loadingIndicator) {
                    loadingIndicator = document.createElement('div');
                    loadingIndicator.id = 'loadingIndicator';
                    loadingIndicator.classList.add('p-4', 'text-center', 'text-gray-500', 'text-sm', 'ai-message'); 
                    loadingIndicator.innerHTML = `
                        <div class="loader-container h-8">
                            <div class="loader-dot"></div>
                            <div class="loader-dot"></div>
                            <div class="loader-dot"></div>
                        </div>
                        <span class="mt-2 block">Mystic Vision AI Lite is thinking...</span> <!-- Renamed thinking message -->
                    `;
                    chatHistoryDiv.appendChild(loadingIndicator);
                }
                loadingIndicator.style.display = 'flex';
                loadingIndicator.style.flexDirection = 'column'; 
                chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
                updateSendButtonState(); // Update button to 'stop' icon and enabled
                userInput.disabled = true; 
            } else {
                isGeneratingResponse = false;
                if (loadingIndicator) {
                    loadingIndicator.remove(); 
                }
                updateSendButtonState(); // Update button to 'send' icon and disabled/enabled based on input
                userInput.disabled = false; 
                userInput.focus();
            }
        }

        function displayChatAttachments() {
            chatAttachmentsPreviewContainer.innerHTML = '';
            if (chatAttachments.length > 0) {
                chatAttachmentsPreviewContainer.classList.remove('hidden');
                chatAttachments.forEach((attachment, index) => {
                    const attachmentDiv = document.createElement('div');
                    attachmentDiv.classList.add('chat-attachment-preview-item');
                    attachmentDiv.dataset.index = index;

                    let previewContent = '';
                    if (attachment.mimeType.startsWith('image/')) {
                        previewContent = `<img src="data:${attachment.mimeType};base64,${attachment.data}" alt="${attachment.name}" class="w-8 h-8 object-cover rounded-md">`;
                    } else {
                        previewContent = `<span data-lucide="${getFileIcon(attachment.mimeType)}" class="w-5 h-5 flex-shrink-0"></span>`;
                    }

                    attachmentDiv.innerHTML = `
                        ${previewContent}
                        <span class="truncate max-w-[100px]">${attachment.name}</span>
                        <button class="remove-attachment-btn">
                            <span data-lucide="x" class="w-4 h-4"></span>
                        </button>
                    `;
                    chatAttachmentsPreviewContainer.appendChild(attachmentDiv);
                });
                createIcons(); 
            } else {
                chatAttachmentsPreviewContainer.classList.add('hidden');
            }
        }

        function showCopyMessage() {
            copyMessage.classList.add('show');
            setTimeout(() => {
                copyMessage.classList.remove('show');
            }, 3000);
        }

        function copyToClipboard(text) { 
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text)
                    .then(() => {
                        showCopyMessage();
                    })
                    .catch(err => {
                        console.error('Failed to copy: ', err);
                        alert('Failed to copy text. Please copy manually.'); 
                    });
            } else {
                const tempTextArea = document.createElement('textarea');
                tempTextArea.value = text;
                document.body.appendChild(tempTextArea);
                tempTextArea.select();
                try {
                    document.execCommand('copy');
                    showCopyMessage();
                } catch (err) {
                    console.error('Failed to copy (fallback):', err);
                    alert('Failed to copy text. Please copy manually.'); 
                }
                document.body.removeChild(tempTextArea);
            }
        }

        function toggleSpeech(text, buttonElement) {
            if (!window.speechSynthesis) {
                alert('Speech synthesis not supported in this browser.');
                return;
            }

            if (isSpeaking && currentUtterance && currentUtterance.text === text) {
                if (window.speechSynthesis.paused) {
                    window.speechSynthesis.resume();
                    updateButtonIcon(buttonElement, 'pause');
                } else {
                    window.speechSynthesis.pause();
                    updateButtonIcon(buttonElement, 'volume-2');
                }
            } else {
                startSpeech(text, buttonElement);
            }
        }

        function startSpeech(text, buttonElement) {
            if (window.speechSynthesis.speaking || window.speechSynthesis.paused) {
                window.speechSynthesis.cancel();
            }

            document.querySelectorAll('.dictate-message-btn').forEach(btn => {
                if (btn !== buttonElement) { 
                    updateButtonIcon(btn, 'volume-2'); 
                }
            });

            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US'; 

            utterance.onstart = () => {
                isSpeaking = true;
                currentUtterance = utterance;
                updateButtonIcon(buttonElement, 'pause');
            };
            utterance.onend = () => {
                isSpeaking = false;
                currentUtterance = null;
                updateButtonIcon(buttonElement, 'volume-2');
            };
            utterance.onerror = (event) => {
                console.error('Speech synthesis error:', event.error);
                alert('Failed to dictate message. Check console for details.');
                isSpeaking = false;
                currentUtterance = null;
                updateButtonIcon(buttonElement, 'volume-2');
            };

            window.speechSynthesis.speak(utterance);
        }

        // --- API Call Function ---
        async function callGeminiAPI(payload) {
            if (GEMINI_API_KEY === "" || !GEMINI_API_KEY || GEMINI_API_KEY === "") { 
                throw new Error("API Key is not set or is the default placeholder. Please replace 'AIzaSyCzx6ReMk8ohPJcCjGwHHzu7SvFccJqAbA' in the script with your actual Gemini API key.");
            }
            
            const dynamicApiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${DEFAULT_GEMINI_MODEL}:generateContent?key=${GEMINI_API_KEY}`;

            // Filter out the 'id' property from messages before sending to Gemini API
            const cleanContents = payload.contents.map(message => {
                const newMessage = {
                    role: message.role,
                    parts: message.parts
                };
                // Ensure no unexpected properties are passed to the API
                return newMessage;
            });
            
            const requestBody = {
                contents: cleanContents,
            };
            
            let response;
            let result;
            let success = false;
            let retryCount = 0;
            const maxRetries = 3;
            let delay = 1000; 

            while (retryCount < maxRetries && !success) {
                try {
                    response = await fetch(dynamicApiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(requestBody) 
                    });

                    if (response.status === 429) { 
                        if (retryCount < maxRetries - 1) {
                            console.warn(`API rate limit exceeded. Retrying in ${delay / 1000}s...`);
                            await new Promise(res => setTimeout(res, delay));
                            delay *= 2; 
                            retryCount++;
                        } else {
                            throw new Error('API rate limit exceeded. Please try again later.');
                        }
                    } else if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(`API error: ${response.status} ${response.statusText} - ${errorData.error?.message || 'Unknown error'}`);
                    } else {
                        result = await response.json();
                        success = true;
                    }
                } catch (err) {
                    if (retryCount < maxRetries - 1) {
                        console.warn(`Fetch error: ${err.message}. Retrying in ${delay / 1000}s...`);
                        await new Promise(res => setTimeout(res, delay));
                        delay *= 2;
                        retryCount++;
                    } else {
                        throw err; 
                    }
                }
            }
            
            if (result && result.candidates && result.candidates.length > 0 &&
                result.candidates[0].content && result.candidates[0].content.parts &&
                result.candidates[0].content.parts.length > 0) {
                return result.candidates[0].content.parts[0].text;
            } else {
                throw new Error('Failed to get a valid response from the AI. No candidates found or content is empty.');
            }
        }

        // --- Autocomplete Functions ---
        function filterSuggestions(query) {
            if (!query) return [];
            const lowerQuery = query.toLowerCase();
            return autocompleteSuggestions.filter(s => s.toLowerCase().includes(query));
        }

        function displaySuggestions(suggestions) {
            suggestionsList.innerHTML = '';
            suggestionsContainer.classList.add('hidden');
            selectedSuggestionIndex = -1;

            if (suggestions.length === 0) {
                return;
            }

            suggestions.forEach((suggestion, index) => {
                const li = document.createElement('li');
                li.textContent = suggestion;
                li.dataset.index = index;
                li.addEventListener('click', () => {
                    userInput.value = suggestion;
                    userInput.focus();
                    suggestionsContainer.classList.add('hidden');
                    userInput.style.height = 'auto'; 
                    userInput.style.height = userInput.scrollHeight + 'px';
                    updateSendButtonState();
                });
                suggestionsList.appendChild(li);
            });
            suggestionsContainer.classList.remove('hidden');
        }

        function navigateSuggestions(direction) {
            const items = Array.from(suggestionsList.children);
            if (items.length === 0) return;

            if (selectedSuggestionIndex !== -1) {
                items[selectedSuggestionIndex].classList.remove('selected');
            }

            if (direction === 'down') {
                selectedSuggestionIndex = (selectedSuggestionIndex + 1) % items.length;
            } else if (direction === 'up') {
                selectedSuggestionIndex = (selectedSuggestionIndex - 1 + items.length) % items.length;
            }

            items[selectedSuggestionIndex].classList.add('selected');
            items[selectedSuggestionIndex].scrollIntoView({ block: 'nearest' });
            userInput.value = items[selectedSuggestionIndex].textContent; 
            userInput.style.height = 'auto'; 
            userInput.style.height = userInput.scrollHeight + 'px';
            updateSendButtonState();
        }

        function selectCurrentSuggestion() {
            if (selectedSuggestionIndex !== -1) {
                const selectedText = suggestionsList.children[selectedSuggestionIndex].textContent;
                userInput.value = selectedText;
            }
            suggestionsContainer.classList.add('hidden');
            selectedSuggestionIndex = -1;
            updateSendButtonState();
        }

        // --- Chat History Management ---
        function saveCurrentChat() {
            if (conversationHistory.length > 0) {
                localStorage.setItem(CURRENT_CHAT_STORAGE_KEY, JSON.stringify(conversationHistory));
            } else {
                localStorage.removeItem(CURRENT_CHAT_STORAGE_KEY);
            }
        }

        // --- New Chat Function ---
        function startNewChat() {
            localStorage.removeItem(CURRENT_CHAT_STORAGE_KEY);

            // Stop any ongoing speech or AI generation
            if (window.speechSynthesis.speaking) {
                window.speechSynthesis.cancel();
                isSpeaking = false;
                currentUtterance = null;
                document.querySelectorAll('.dictate-message-btn').forEach(btn => updateButtonIcon(btn, 'volume-2'));
            }
            if (isGeneratingResponse) {
                isGeneratingResponse = false;
                toggleLoading(false);
            }

            // Reset UI and in-memory history for a new chat
            chatHistoryDiv.innerHTML = '';
            conversationHistory = []; // Reset history to empty
            chatAttachments = [];
            chatImageUpload.value = '';
            displayChatAttachments();
            userInput.value = '';
            userInput.style.height = 'auto';
            messageTextCache.clear();
            suggestionsContainer.classList.add('hidden');
            selectedSuggestionIndex = -1;
            userInput.dataset.editingMessageId = '';
            updateSendButtonState();

            // Append the initial AI message for the new chat
            const initialAiMessageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
            const { messageContentDiv: initialAiContentDiv, messageDiv: initialAiMessageDiv } = appendChatMessage('ai', initialAIMessage.parts[0].text, [], initialAiMessageId);
            conversationHistory.push({ ...initialAIMessage, id: initialAiMessageId }); // Add to the *new* history

            // For the initial message, it always renders instantly
            initialAiContentDiv.innerHTML = marked.parse(initialAIMessage.parts[0].text);
            if (typeof Prism !== 'undefined') {
                requestAnimationFrame(() => {
                    Prism.highlightAllUnder(initialAiMessageDiv);
                });
            }

            // Hide sidebar on mobile if new chat is initiated from it
            if (window.innerWidth <= 768) {
                chatSidebar.classList.remove('active-mobile-sidebar');
                mobileToggleSidebarBtn.style.display = 'flex';
            }

            userInput.focus();
        }

        // --- Export Functions ---
        function getFormattedChatHistoryTextForExport() {
            let text = '';
            conversationHistory.forEach(msg => {
                let msgText = '';
                msg.parts.forEach(part => {
                    if (part.text) {
                        msgText += part.text;
                    }
                    // For attachments, just indicate their presence. Full content not included in text export.
                    if (part.inlineData) {
                        msgText += ` [Attachment: ${part.inlineData.name || part.inlineData.mimeType}]`;
                    }
                });
                text += `${msg.role.toUpperCase()}:\n${msgText}\n\n`;
            });
            return text;
        }

        function exportAsMd() {
            if (conversationHistory.length === 0) {
                alert("No chat history to export.");
                return;
            }
            let markdownContent = `# Mystic Vision AI Chat History (Lite)\n\n`; // Renamed export title
            markdownContent += `*Export Date: ${new Date().toLocaleString()}*\n\n---\n\n`;

            conversationHistory.forEach(msg => {
                markdownContent += `## ${msg.role === 'user' ? 'You' : 'Mystic Vision AI Lite'}\n\n`; // Renamed AI in export
                msg.parts.forEach(part => {
                    if (part.text) {
                        markdownContent += `${part.text}\n\n`;
                    }
                    if (part.inlineData) {
                        // For image attachments, provide a placeholder markdown syntax
                        if (part.inlineData.mimeType.startsWith('image/')) {
                            markdownContent += `![Attachment: ${part.inlineData.name || 'Image'}](${part.inlineData.mimeType};base64,${part.inlineData.data})\n\n`;
                        } else {
                            // For other file types, just list them
                            markdownContent += `[File Attachment: ${part.inlineData.name || part.inlineData.mimeType}]\n\n`;
                        }
                    }
                });
                markdownContent += `---\n\n`; // Separator between messages
            });

            const blob = new Blob([markdownContent], { type: 'text/markdown;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `MysticVision_Chat_Lite_${new Date().toISOString().slice(0, 10)}.md`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            alert('Chat exported as Markdown (.md)!');
        }

        function exportAsTxt() {
            if (conversationHistory.length === 0) {
                alert("No chat history to export.");
                return;
            }
            const textContent = getFormattedChatHistoryTextForExport();
            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `MysticVision_Chat_Lite_${new Date().toISOString().slice(0, 10)}.txt`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            alert('Chat exported as TXT!');
        }

        async function exportAsPdf() {
            if (conversationHistory.length === 0) {
                alert("No chat history to export.");
                return;
            }
            if (typeof jspdf === 'undefined') {
                alert('PDF export library (jsPDF) not loaded. Please ensure internet connection or check CDN.');
                console.error("jsPDF not loaded. Add <script src='https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js'><script> to your HTML header.");
                return;
            }
            const { jsPDF } = jspdf;
            const doc = new jsPDF();

            const title = `Mystic Vision AI Chat History (Lite) - ${new Date().toLocaleString()}`; // Renamed export title
            const textContent = getFormattedChatHistoryTextForExport();
            const lines = doc.splitTextToSize(textContent, 180); // Max width of 180mm for text

            let y = 15; // Starting Y position, leave some margin
            const lineHeight = 7; // Approx line height for 12pt font
            const pageHeight = doc.internal.pageSize.height;
            const pageWidth = doc.internal.pageSize.width;

            doc.setFontSize(14);
            doc.text(title, pageWidth / 2, y, { align: 'center' }); // Centered title
            y += lineHeight * 2;

            doc.setFontSize(10); // Smaller font for chat content
            lines.forEach(line => {
                if (y + lineHeight > pageHeight - 15) { // Check if new page is needed, leave bottom margin
                    doc.addPage();
                    y = 15; // Reset Y for new page
                    doc.setFontSize(12);
                    doc.text(`Chat History (continued)`, pageWidth / 2, y, { align: 'center' });
                    y += lineHeight * 2;
                    doc.setFontSize(10);
                }
                doc.text(line, 10, y); // Left aligned text
                y += lineHeight;
            });

            doc.save(`MysticVision_Chat_Lite_${new Date().toISOString().slice(0, 10)}.pdf`);
            alert('Chat exported as PDF!');
        }

        // New: Export as JSON
        function exportAsJson() {
            if (conversationHistory.length === 0) {
                alert("No chat history to export.");
                return;
            }
            // Create a copy of conversationHistory to remove cyclical references (if any) or extra properties like 'file' object in attachments
            const exportableHistory = conversationHistory.map(message => {
                const parts = message.parts.map(part => {
                    if (part.inlineData) {
                        // Only include mimeType and data for inlineData, optionally name
                        return { inlineData: { mimeType: part.inlineData.mimeType, data: part.inlineData.data, name: part.inlineData.name || undefined } };
                    }
                    return part;
                });
                return { role: message.role, parts: parts, id: message.id };
            });

            const jsonContent = JSON.stringify(exportableHistory, null, 2); // Pretty print JSON
            const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `MysticVision_Chat_Lite_${new Date().toISOString().slice(0, 10)}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(link.href);
            alert('Chat exported as JSON!');
        }

        // --- Paste Functionality ---
        async function processPastedFile(file) {
            const allowedTypes = [
                'image/', 'text/', 'application/pdf',
                'application/json', 'text/csv', 'application/xml', 'text/markdown'
            ];
            const isAllowed = allowedTypes.some(type => file.type.startsWith(type)) || file.name.endsWith('.md');

            if (isAllowed) {
                if (file.size > 10 * 1024 * 1024) { 
                    alert(`File "${file.name}" is too large (>10MB). Max 10MB per file.`);
                    return;
                }
                try {
                    const { mimeType, data } = await fileToBase64(file);
                    chatAttachments.push({ file, mimeType, data, name: file.name });
                } catch (error) {
                    alert(`Failed to read pasted file ${file.name}.`);
                    console.error('Pasted file read error:', error);
                }
            } else {
                alert(`Pasted file type not supported: "${file.name}" (${file.type}).`);
            }
        }

        // Function to apply theme
        function applyTheme(themeName) {
            // Remove all known theme classes from the body
            THEMES.forEach(theme => {
                document.body.classList.remove(theme);
            });
            // Add the new selected theme class
            let themeToApply = themeName;
            if (!THEMES.includes(themeName)) {
                // Fallback to default if somehow an invalid theme is passed
                themeToApply = DEFAULT_THEME;
            }
            document.body.classList.add(themeToApply);
            localStorage.setItem('selected-lite-theme', themeToApply); // Save user preference (unique key for Lite)

            // Update the select dropdown to show the current theme
            if (themeSelect) {
                themeSelect.value = themeToApply;
                // Update SVG arrow color dynamically based on new theme's --text-color
                // This converts the CSS variable value (e.g., "#E6E6FA") to a hex string without '#'
                const computedStyle = getComputedStyle(document.documentElement);
                const textColorValue = computedStyle.getPropertyValue('--text-color').trim();
                let arrowColor = '000000'; // Default to black
                if (textColorValue.startsWith('#') && textColorValue.length === 7) {
                    arrowColor = textColorValue.substring(1);
                } else if (textColorValue.startsWith('rgb')) {
                    // Convert rgb(r, g, b) to hex
                    const rgb = textColorValue.match(/\d+/g);
                    if (rgb && rgb.length >= 3) {
                        arrowColor = ((1 << 24) + (parseInt(rgb[0]) << 16) + (parseInt(rgb[1]) << 8) + parseInt(rgb[2])).toString(16).slice(1);
                    }
                }
                themeSelect.style.setProperty('--select-arrow-svg', `url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23${arrowColor}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="lucide lucide-chevron-down"><path d="m6 9 6 6 6-6"/></svg>')`);
            }
        }

        // --- Initialization on Load ---
        window.addEventListener('load', () => {
            // --- Assign DOM Elements after the page is fully loaded ---
            chatbotContainer = document.querySelector('.chatbot-container');
            chatHistoryDiv = document.getElementById('chatHistory');
            userInput = document.getElementById('userInput');
            sendButton = document.getElementById('sendButton');
            themeSelect = document.getElementById('theme-select');
            copyMessage = document.getElementById('copy-message');
            chatAttachmentsPreviewContainer = document.getElementById('chat-attachments-preview-container');
            chatImageUpload = document.getElementById('chat-image-upload');
            voiceInputBtn = document.getElementById('voice-input-btn');
            suggestionsContainer = document.getElementById('suggestions-container');
            suggestionsList = document.getElementById('suggestions-list');
            
            // Sidebar Elements
            chatSidebar = document.getElementById('chatSidebar'); 
            newChatBtnSidebar = document.getElementById('newChatBtn'); 
            toggleSidebarBtn = document.getElementById('toggleSidebarBtn'); 
            mobileToggleSidebarBtn = document.getElementById('mobileToggleSidebarBtn'); 
            chatMainContent = document.getElementById('chatMainContent');
            // Sidebar Export Buttons
            exportTxtBtn = document.getElementById('exportTxtBtn');
            exportPdfBtn = document.getElementById('exportPdfBtn');
            exportMdBtn = document.getElementById('exportMdBtn'); 
            exportJsonBtn = document.getElementById('exportJsonBtn'); // New: JSON export button
            desktopToggleSidebarBtn = document.getElementById('desktopToggleSidebarBtn');

            createIcons();
            userInput.style.height = userInput.scrollHeight + 'px';

            let isSidebarOpenDesktop = true; // Sidebar starts open by default on desktop

            // Initialize Theme based on localStorage or default
            const savedTheme = localStorage.getItem('selected-lite-theme'); // Unique key
            applyTheme(savedTheme || DEFAULT_THEME);

            // Event listener for Theme Selector
            themeSelect.addEventListener('change', (event) => {
                const selectedTheme = event.target.value;
                applyTheme(selectedTheme);
            });

            // NEW: Function to apply desktop sidebar state
            function applyDesktopSidebarState() {
                if (isSidebarOpenDesktop) {
                    chatSidebar.style.width = '280px';
                    chatSidebar.style.padding = '20px 15px';
                    chatSidebar.style.overflowY = 'auto'; // Re-enable scroll
                    chatMainContent.classList.remove('sidebar-hidden'); // No left radius
                    updateButtonIcon(desktopToggleSidebarBtn, 'chevron-left', 'w-5 h-5');
                } else {
                    chatSidebar.style.width = '0px';
                    chatSidebar.style.padding = '0'; // Remove padding when collapsed
                    chatSidebar.style.overflowY = 'hidden'; // Hide scroll when collapsed
                    chatMainContent.classList.add('sidebar-hidden'); // Add left radius
                    updateButtonIcon(desktopToggleSidebarBtn, 'chevron-right', 'w-5 h-5');
                }
            }

            // NEW: Event listener for desktop toggle button
            desktopToggleSidebarBtn.addEventListener('click', () => {
                isSidebarOpenDesktop = !isSidebarOpenDesktop;
                applyDesktopSidebarState();
            });

            // Load the current session's chat history on startup
            const storedHistory = localStorage.getItem(CURRENT_CHAT_STORAGE_KEY); // Unique key
            if (storedHistory) {
                conversationHistory = JSON.parse(storedHistory);
                const aiMessageDivsToHighlight = []; // For Prism.js highlighting
                chatHistoryDiv.innerHTML = ''; // Clear existing UI

                conversationHistory.forEach(msg => {
                    let textContent = '';
                    let attachments = [];
                    msg.parts.forEach(part => {
                        if (part.text) {
                            textContent = part.text;
                        } else if (part.inlineData) {
                            attachments.push({
                                mimeType: part.inlineData.mimeType,
                                data: part.inlineData.data,
                                name: part.inlineData.name || 'Attachment'
                            });
                        }
                    });
                    // Ensure message has an ID for action buttons even if loaded from older saves
                    const msgId = msg.id || `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    const { messageContentDiv, messageDiv } = appendChatMessage(msg.role, textContent, attachments, msgId);
                    if (!msg.id) msg.id = msgId; // Update history with new ID if missing

                    if (msg.role === 'model') {
                        // For AI in Lite version, content is already marked.parsed in appendChatMessage
                        if (typeof Prism !== 'undefined') {
                            aiMessageDivsToHighlight.push(messageDiv);
                        }
                    }
                });

                if (typeof Prism !== 'undefined') {
                    requestAnimationFrame(() => {
                        aiMessageDivsToHighlight.forEach(div => {
                            Prism.highlightAllUnder(div);
                        });
                    });
                }
                chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
            } else {
                // If no stored history, start a truly new chat with the AI's first message
                startNewChat();
            }

            updateSendButtonState(); // Initial state update for the send button

            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('/service-worker.js')
                .then(registration => {
                    console.log('ServiceWorker registered: ', registration);
                })
                .catch(registrationError => {
                    console.log('ServiceWorker registration failed: ', registrationError);
                });
            }

            // --- Speech Recognition Setup ---
            // IMPORTANT: Browser's SpeechRecognition API is used. Its "intelligence"
            // (accuracy, noise handling, punctuation) is determined by the browser
            // and underlying OS capabilities, not directly by this application code.
            // A truly "ChatGPT-like" voice input experience (e.g., highly robust VAD,
            // advanced contextual understanding, real-time punctuation beyond basic)
            // typically requires integration with powerful cloud-based Speech-to-Text
            // and Natural Language Understanding (NLU) services (like OpenAI's Whisper,
            // Google Cloud Speech-to-Text, Azure Speech Services), which involve
            // server-side processing and are beyond the scope of a pure client-side
            // HTML/JavaScript application. This implementation provides the best
            // possible experience using standard browser APIs.
            if (SpeechRecognition) {
                recognition = new SpeechRecognition();
                recognition.continuous = true; 
                recognition.interimResults = true; 
                recognition.lang = 'en-US';

                recognition.onstart = () => {
                    isVoiceInputActive = true;
                    voiceInputBtn.classList.add('voice-input-active');
                    updateButtonIcon(voiceInputBtn, 'mic-off', 'w-5 h-5'); 
                    userInput.placeholder = 'Listening... Speak now.';
                    finalTranscript = ''; 
                    userInput.value = ''; 
                    updateSendButtonState();
                };

                recognition.onresult = (event) => {
                    let interimTranscript = '';
                    for (let i = event.resultIndex; i < event.results.length; ++i) {
                        if (event.results[i].isFinal) {
                            finalTranscript += event.results[i][0].transcript + ' '; 
                        } else {
                            interimTranscript += event.results[i][0].transcript;
                        }
                    }
                    userInput.value = finalTranscript + interimTranscript; 
                    userInput.scrollLeft = userInput.scrollWidth; 
                    userInput.style.height = 'auto'; 
                    userInput.style.height = userInput.scrollHeight + 'px';
                    updateSendButtonState();
                };

                recognition.onend = () => {
                    isVoiceInputActive = false;
                    voiceInputBtn.classList.remove('voice-input-active');
                    updateButtonIcon(voiceInputBtn, 'mic', 'w-5 h-5'); 
                    userInput.placeholder = 'Type your message...';

                    if (finalTranscript.trim() !== '') {
                        userInput.value = finalTranscript.trim(); 
                    } else if (userInput.value.trim() === '') {
                        userInput.value = ''; 
                    }
                    userInput.style.height = 'auto'; 
                    userInput.style.height = userInput.scrollHeight + 'px';
                    updateSendButtonState();
                };

                recognition.onerror = (event) => {
                    isVoiceInputActive = false; 
                    voiceInputBtn.classList.remove('voice-input-active');
                    updateButtonIcon(voiceInputBtn, 'mic', 'w-5 h-5'); 
                    userInput.placeholder = 'Type your message...';

                    console.error('Speech recognition error:', event.error);
                    let errorMessage = `Speech recognition error: ${event.error}`;
                    if (event.error === 'not-allowed') {
                        errorMessage = 'Microphone access denied. Please allow microphone access in your browser settings.';
                    } else if (event.error === 'no-speech') {
                        console.log('No speech detected, recognition ended.');
                        if (finalTranscript.trim() === '') { userInput.value = ''; }
                        updateSendButtonState();
                        return; 
                    } else if (event.error === 'network') {
                        errorMessage = 'Speech recognition network error. This often means a firewall, proxy, or browser extension is blocking access to Google\'s speech services. Please try disabling extensions or testing in incognito mode.';
                    }
                    alert(errorMessage); 
                    updateSendButtonState();
                };
            } else {
                console.warn('Web Speech API (SpeechRecognition) not supported in this browser. Voice input button will be hidden.');
                voiceInputBtn.style.display = 'none'; 
            }

            userInput.addEventListener('input', () => {
                userInput.style.height = 'auto'; 
                userInput.style.height = userInput.scrollHeight + 'px';

                const query = userInput.value;
                if (query.length > 0) {
                    const suggestions = filterSuggestions(query);
                    displaySuggestions(suggestions);
                } else {
                    suggestionsContainer.classList.add('hidden');
                }
                updateSendButtonState();
            });

            userInput.addEventListener('keydown', (e) => {
                if (suggestionsContainer.classList.contains('hidden')) {
                    if (e.key === 'Enter' && !e.shiftKey) { 
                        e.preventDefault(); 
                        sendButton.click(); 
                    }
                    return;
                }

                if (e.key === 'ArrowDown') {
                    e.preventDefault(); 
                    navigateSuggestions('down');
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault(); 
                    navigateSuggestions('up');
                } else if (e.key === 'Enter') { 
                    e.preventDefault(); 
                    selectCurrentSuggestion();
                } else if (e.key === 'Escape') {
                    suggestionsContainer.classList.add('hidden');
                    selectedSuggestionIndex = -1;
                }
            });

            userInput.addEventListener('blur', () => {
                setTimeout(() => {
                    suggestionsContainer.classList.add('hidden');
                    selectedSuggestionIndex = -1;
                }, 100); 
            });

            userInput.addEventListener('paste', async (e) => {
                const items = e.clipboardData.items;
                let filePasted = false;

                for (let i = 0; i < items.length; i++) {
                    const item = items[i];
                    if (item.kind === 'file') {
                        e.preventDefault(); 
                        const file = item.getAsFile();
                        if (file) {
                            filePasted = true;
                            await processPastedFile(file);
                        }
                    }
                }

                if (filePasted) {
                    displayChatAttachments();
                    userInput.focus();
                    updateSendButtonState();
                }
            });

            sendButton.addEventListener('click', async () => {
                // If AI is currently generating, this click means STOP
                if (isGeneratingResponse) {
                    isGeneratingResponse = false;
                    if (window.speechSynthesis.speaking || window.speechSynthesis.paused) {
                        window.speechSynthesis.cancel();
                        isSpeaking = false;
                        currentUtterance = null;
                        document.querySelectorAll('.dictate-message-btn').forEach(btn => updateButtonIcon(btn, 'volume-2'));
                    }
                    toggleLoading(false); // This will update the button state to 'send'
                    console.log("AI generation stopped by user.");
                    saveCurrentChat(); 
                    return; // Exit the function after handling stop
                }

                // If not generating, proceed with sending (original send logic)
                const userMessage = userInput.value.trim();
                const editingMessageId = userInput.dataset.editingMessageId;
                const hasInput = userMessage.length > 0 || chatAttachments.length > 0;

                if (!hasInput) {
                    console.warn("No input or attachments to send.");
                    userInput.classList.add('border-accent-error', 'animate-pulse');
                    setTimeout(() => {
                        userInput.classList.remove('border-accent-error', 'animate-pulse');
                    }, 500);
                    return;
                }

                // Stop any ongoing speech or voice input
                if (isVoiceInputActive && recognition) {
                    recognition.stop();
                }
                if (window.speechSynthesis.speaking) {
                    window.speechSynthesis.cancel();
                    isSpeaking = false;
                    currentUtterance = null;
                    document.querySelectorAll('.dictate-message-btn').forEach(btn => updateButtonIcon(btn, 'volume-2'));
                }

                if (editingMessageId) {
                    const editedText = userMessage;
                    const messageDivToEdit = document.querySelector(`.chat-message[data-message-id="${editingMessageId}"]`);
                    
                    if (messageDivToEdit) {
                        const originalIndex = Array.from(chatHistoryDiv.children).indexOf(messageDivToEdit);
                        if (originalIndex !== -1) {
                            const originalMessage = conversationHistory[originalIndex];
                            
                            originalMessage.parts = [];
                            if (editedText) {
                                originalMessage.parts.push({ text: editedText });
                            }
                            if (chatAttachments.length > 0) {
                                for(const attachment of chatAttachments) {
                                    originalMessage.parts.push({
                                        inlineData: { mimeType: attachment.mimeType, data: attachment.data }
                                    });
                                }
                            }

                            // Remove all messages from history and UI after the edited message
                            while (chatHistoryDiv.children.length > originalIndex + 1) {
                                chatHistoryDiv.lastChild.remove();
                                conversationHistory.pop();
                            }

                            // Update the UI for the edited message
                            const messageBubbleContent = messageDivToEdit.querySelector('.message-bubble-content');
                            if (messageBubbleContent) {
                                const messageContentDiv = messageBubbleContent.querySelector('.message-content');
                                if (messageContentDiv) messageContentDiv.remove();

                                const newMessageContentDiv = document.createElement('div');
                                newMessageContentDiv.classList.add('message-content');
                                newMessageContentDiv.innerHTML = `<span>${editedText}</span>`;

                                if (chatAttachments.length > 0) {
                                    const attachmentsContainer = document.createElement('div');
                                    attachmentsContainer.classList.add('mt-2', 'flex', 'flex-wrap', 'gap-2');
                                    chatAttachments.forEach(attachment => {
                                        if (attachment.mimeType.startsWith('image/')) {
                                            attachmentsContainer.innerHTML += `<img src="data:${attachment.mimeType};base64,${attachment.data}" alt="${attachment.name || 'User attachment'}" class="chat-image w-24 h-24 object-cover">`;
                                        } else {
                                            attachmentsContainer.innerHTML += `
                                                <div class="chat-message-attachment-item">
                                                    <span data-lucide="${getFileIcon(attachment.mimeType)}" class="w-4 h-4 flex-shrink-0"></span>
                                                    <span class="truncate max-w-[120px]">${attachment.name || 'File'}</span>
                                                </div>
                                            `;
                                        }
                                    });
                                    newMessageContentDiv.appendChild(attachmentsContainer);
                                }
                                messageBubbleContent.prepend(newMessageContentDiv);
                                createIcons();
                            }
                            messageTextCache.set(editingMessageId, editedText);
                            messageDivToEdit.classList.remove('editing');
                        }
                    }
                } else {
                    const userParts = [];
                    if (userMessage) {
                        userParts.push({ text: userMessage });
                    }
                    for (const attachment of chatAttachments) {
                        userParts.push({
                            inlineData: {
                                mimeType: attachment.mimeType,
                                data: attachment.data
                            }
                        });
                    }
                    const newUserMessageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                    appendChatMessage('user', userMessage, chatAttachments, newUserMessageId);
                    conversationHistory.push({ role: 'user', parts: userParts, id: newUserMessageId });
                }

                userInput.value = '';
                userInput.style.height = 'auto';
                chatAttachments = [];
                chatImageUpload.value = '';
                displayChatAttachments();
                suggestionsContainer.classList.add('hidden');
                selectedSuggestionIndex = -1;
                delete userInput.dataset.editingMessageId;
                
                toggleLoading(true); // This will set isGeneratingResponse and update button state

                try {
                    const payload = {
                        contents: conversationHistory,
                    };

                    const responseText = await callGeminiAPI(payload);

                    if (isGeneratingResponse) { // Still check if the user hasn't stopped it during API call
                        const newAiMessageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                        const { messageContentDiv: aiContentDiv, messageDiv: aiMessageDiv } = appendChatMessage('ai', responseText, [], newAiMessageId);
                        conversationHistory.push({ role: 'model', parts: [{ text: responseText }], id: newAiMessageId });

                        // Since Lite version doesn't simulate typing, render and highlight instantly
                        aiContentDiv.innerHTML = marked.parse(responseText);
                        if (typeof Prism !== 'undefined') {
                            Prism.highlightAllUnder(aiMessageDiv);
                        }
                        chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
                        toggleLoading(false);
                        saveCurrentChat();
                    }
                } catch (error) {
                    console.error('Chat API call failed:', error);
                    appendChatMessage('ai', `Oops! Something went wrong. Please try again. (${error.message})`);
                    toggleLoading(false);
                } 
            });
            
            chatImageUpload.addEventListener('change', async (event) => {
                const files = Array.from(event.target.files);
                if (files.length > 0) {
                    for (const file of files) {
                        const allowedTypes = [
                            'image/', 'text/', 'application/pdf',
                            'application/json', 'text/csv', 'application/xml', 'text/markdown'
                        ];
                        const isAllowed = allowedTypes.some(type => file.type.startsWith(type)) || file.name.endsWith('.md');

                        if (isAllowed) {
                            if (file.size > 10 * 1024 * 1024) { 
                                alert(`File "${file.name}" is too large (>${10}MB). Max 10MB per file.`);
                                continue;
                            }
                            try {
                                const { mimeType, data } = await fileToBase64(file);
                                chatAttachments.push({ file, mimeType, data, name: file.name });
                            } catch (error) {
                                alert(`Failed to read chat file ${file.name}.`);
                                console.error('Chat file read error:', error);
                            }
                        } else {
                            alert(`File type not supported for chat: "${file.name}" (${file.type}).`);
                        }
                    }
                    displayChatAttachments();
                    userInput.focus();
                    updateSendButtonState();
                }
                chatImageUpload.value = ''; 
            });

            chatAttachmentsPreviewContainer.addEventListener('click', (event) => {
                const removeBtn = event.target.closest('.remove-attachment-btn');
                if (removeBtn) {
                    const attachmentDiv = removeBtn.closest('[data-index]');
                    if (attachmentDiv) {
                        const index = parseInt(attachmentDiv.dataset.index);
                        chatAttachments.splice(index, 1); 
                        displayChatAttachments(); 
                        userInput.focus();
                        updateSendButtonState();
                    }
                }
            });

            voiceInputBtn.addEventListener('click', () => {
                if (recognition) {
                    if (isVoiceInputActive) {
                        recognition.stop(); 
                    } else {
                        finalTranscript = ''; 
                        recognition.start();
                    }
                } else {
                    alert('Speech recognition is not supported in this browser.');
                }
            });

            chatbotContainer.addEventListener('dragover', (e) => {
                e.preventDefault();
                e.stopPropagation();
                chatbotContainer.classList.add('drag-over-active');
            });

            chatbotContainer.addEventListener('dragleave', (e) => {
                e.preventDefault();
                e.stopPropagation();
                chatbotContainer.classList.remove('drag-over-active');
            });

            chatbotContainer.addEventListener('drop', async (e) => {
                e.preventDefault();
                e.stopPropagation();
                chatbotContainer.classList.remove('drag-over-active');

                const files = Array.from(e.dataTransfer.files);
                if (files.length > 0) {
                    for (const file of files) {
                        const allowedTypes = [
                            'image/', 'text/', 'application/pdf',
                            'application/json', 'text/csv', 'application/xml', 'text/markdown'
                        ];
                        const isAllowed = allowedTypes.some(type => file.type.startsWith(type)) || file.name.endsWith('.md');

                        if (isAllowed) {
                            if (file.size > 10 * 1024 * 1024) { 
                                alert(`File "${file.name}" is too large (>${10}MB). Max 10MB per file.`);
                                continue;
                            }
                            try {
                                const { mimeType, data } = await fileToBase64(file);
                                chatAttachments.push({ file, mimeType, data, name: file.name });
                            } catch (error) {
                                alert(`Failed to read chat file ${file.name}.`);
                                console.error('Chat file read error:', error);
                            }
                        } else {
                            alert(`File type not supported for chat: "${file.name}" (${file.type}).`);
                        }
                    }
                    displayChatAttachments();
                    userInput.focus();
                    updateSendButtonState();
                }
            });
            
            chatHistoryDiv.addEventListener('click', async (event) => {
                const codeCopyButton = event.target.closest('.code-block-copy-button');
                if (codeCopyButton) {
                    const targetId = codeCopyButton.dataset.copyTarget;
                    const codeElement = document.getElementById(targetId);
                    if (codeElement) {
                        const codeToCopy = codeElement.textContent;
                        updateButtonIcon(codeCopyButton, 'check', 'w-4 h-4'); 
                        copyToClipboard(codeToCopy); 
                        setTimeout(() => { 
                            updateButtonIcon(codeCopyButton, 'clipboard', 'w-4 h-4'); 
                        }, 2000);
                        return; 
                    }
                }

                const chatCopyButton = event.target.closest('.copy-message-btn');
                if (chatCopyButton) {
                    const messageId = chatCopyButton.dataset.messageId;
                    const messageContent = messageTextCache.get(messageId); // Get raw text
                    if (messageContent) {
                        updateButtonIcon(chatCopyButton, 'check');
                        copyToClipboard(messageContent); 
                        setTimeout(() => { 
                            updateButtonIcon(chatCopyButton, 'clipboard');
                        }, 2000);
                    } else {
                        alert('Message content not found for copying.');
                    }
                    return; 
                }

                const dictateButton = event.target.closest('.dictate-message-btn');
                if (dictateButton) {
                    const messageId = dictateButton.dataset.messageId;
                    const messageContent = messageTextCache.get(messageId); // Get raw text
                    if (messageContent) {
                        toggleSpeech(messageContent, dictateButton);
                    } else {
                        alert('Message content not found for dictation.');
                    }
                    return; 
                }

                const editButton = event.target.closest('.edit-message-btn');
                if (editButton) {
                    const messageId = editButton.dataset.messageId;
                    const messageDivToEdit = document.querySelector(`.chat-message[data-message-id="${messageId}"]`);
                    
                    if (messageDivToEdit) {
                        const originalIndex = Array.from(chatHistoryDiv.children).indexOf(messageDivToEdit);
                        if (originalIndex !== -1) {
                            const originalMessage = conversationHistory[originalIndex];
                            
                            let originalText = '';
                            let originalAttachments = [];
                            originalMessage.parts.forEach(part => {
                                if (part.text) {
                                    originalText = part.text;
                                } else if (part.inlineData) {
                                    originalAttachments.push({
                                        file: null, 
                                        mimeType: part.inlineData.mimeType,
                                        data: part.inlineData.data,
                                        name: part.inlineData.name || 'Attachment' 
                                    });
                                }
                            });

                            userInput.value = originalText;
                            chatAttachments = originalAttachments; 
                            displayChatAttachments(); 

                            userInput.focus();
                            userInput.style.height = 'auto';
                            userInput.style.height = userInput.scrollHeight + 'px';

                            chatHistoryDiv.querySelectorAll('.chat-message').forEach(msg => msg.classList.remove('editing'));
                            messageDivToEdit.classList.add('editing');

                            userInput.dataset.editingMessageId = messageId;
                            updateButtonIcon(sendButton, 'save', 'w-5 h-5'); // Change icon to 'save' when editing
                            updateSendButtonState(); // Re-enable send button if there's input for saving
                        }
                    }
                    return;
                }

                const regenerateButton = event.target.closest('.regenerate-message-btn');
                if (regenerateButton) {
                    const messageId = regenerateButton.dataset.messageId;
                    const messageDiv = regenerateButton.closest('.chat-message');

                    const aiMessageIndex = Array.from(chatHistoryDiv.children).indexOf(messageDiv);

                    if (aiMessageIndex !== -1) {
                        const aiMsgInHistoryIndex = conversationHistory.findIndex(msg => msg.id === messageId);
                        if (aiMsgInHistoryIndex === -1) {
                            console.error("AI message not found in history for regeneration.");
                            alert("Could not regenerate: message not found in history.");
                            return;
                        }

                        // Slice history *before* this AI message
                        conversationHistory = conversationHistory.slice(0, aiMsgInHistoryIndex);
                        
                        // Remove messages from UI after this AI message (including itself)
                        while (chatHistoryDiv.children.length > aiMessageIndex) {
                            chatHistoryDiv.lastChild.remove();
                        }
                        
                        if (conversationHistory.length > 0) {
                            const lastUserMessage = conversationHistory[conversationHistory.length - 1];
                            if (lastUserMessage.role === 'user' && lastUserMessage.parts) {
                                let userTextForRegen = '';
                                let userAttachmentsForRegen = [];
                                lastUserMessage.parts.forEach(part => {
                                    if (part.text) userTextForRegen = part.text;
                                    if (part.inlineData) userAttachmentsForRegen.push({
                                        mimeType: part.inlineData.mimeType,
                                        data: part.inlineData.data,
                                        name: part.inlineData.name || 'Attachment' 
                                    });
                                });

                                userInput.value = userTextForRegen;
                                chatAttachments = userAttachmentsForRegen; 
                                displayChatAttachments(); 

                                toggleLoading(true);

                                try {
                                    const payload = {
                                        contents: conversationHistory,
                                    };
                                    const responseText = await callGeminiAPI(payload);

                                    if (isGeneratingResponse) { // Check if not stopped during API call
                                        const newAiMessageId = `msg-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`;
                                        const { messageContentDiv: aiContentDiv, messageDiv: aiMessageDiv } = appendChatMessage('ai', responseText, [], newAiMessageId);
                                        conversationHistory.push({ role: 'model', parts: [{ text: responseText }], id: newAiMessageId });

                                        aiContentDiv.innerHTML = marked.parse(responseText);
                                        if (typeof Prism !== 'undefined') {
                                            Prism.highlightAllUnder(aiMessageDiv);
                                        }
                                        chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
                                        toggleLoading(false);
                                        saveCurrentChat();
                                    }
                                } catch (error) {
                                    console.error('Chat API call failed during regeneration:', error);
                                    appendChatMessage('ai', `Oops! Something went wrong during regeneration. Please try again. (${error.message})`);
                                    toggleLoading(false);
                                }

                                // Clear input area after successful "resend" from regeneration
                                userInput.value = '';
                                userInput.style.height = 'auto';
                                chatAttachments = [];
                                chatImageUpload.value = '';
                                displayChatAttachments();
                                suggestionsContainer.classList.add('hidden');
                                selectedSuggestionIndex = -1;
                                delete userInput.dataset.editingMessageId;
                                updateSendButtonState();
                            } else {
                                console.error("Cannot regenerate: Last message in history is not a user message or is malformed.");
                                alert("Could not regenerate. The previous user message was not found or was empty. Starting a new chat.");
                                startNewChat();
                            }
                        } else {
                            alert("Cannot regenerate. No previous user message to base regeneration on. Starting a new chat.");
                            startNewChat();
                        }
                    }
                    return;
                }
            });

            newChatBtnSidebar.addEventListener('click', startNewChat);

            // Add event listeners for the export buttons
            exportTxtBtn.addEventListener('click', exportAsTxt);
            exportPdfBtn.addEventListener('click', exportAsPdf);
            exportMdBtn.addEventListener('click', exportAsMd);
            exportJsonBtn.addEventListener('click', exportAsJson); // New: JSON export listener

            mobileToggleSidebarBtn.addEventListener('click', () => {
                chatSidebar.classList.add('active-mobile-sidebar');
                chatMainContent.classList.remove('sidebar-hidden'); // Ensure main content loses its left radius
                mobileToggleSidebarBtn.style.display = 'none'; 
            });

            toggleSidebarBtn.addEventListener('click', () => {
                chatSidebar.classList.remove('active-mobile-sidebar');
                chatMainContent.classList.add('sidebar-hidden'); // Add back radius to main content
                mobileToggleSidebarBtn.style.display = 'flex'; 
            });

            window.addEventListener('resize', () => {
                const isMobile = window.innerWidth <= 768;
                if (isMobile) {
                    // Mobile view
                    // Hide desktop toggle
                    desktopToggleSidebarBtn.style.display = 'none';

                    // Ensure mobile sidebar rules are applied
                    chatSidebar.classList.remove('hidden-sidebar'); // If you use a 'hidden-sidebar' class for mobile, keep this.
                    if (chatSidebar.classList.contains('active-mobile-sidebar')) {
                        mobileToggleSidebarBtn.style.display = 'none';
                        chatMainContent.classList.remove('sidebar-hidden');
                    } else {
                        mobileToggleSidebarBtn.style.display = 'flex';
                        chatMainContent.classList.add('sidebar-hidden'); // Apply radius if sidebar closed on mobile
                    }
                    toggleSidebarBtn.style.display = 'flex'; // 'X' button inside mobile sidebar

                    // Reset any inline styles from desktop mode
                    chatSidebar.style.width = '';
                    chatSidebar.style.padding = '';
                    chatSidebar.style.overflowY = 'auto'; // Ensure scrollbar for mobile
                } else {
                    // Desktop view
                    // Show desktop toggle, hide mobile toggles
                    desktopToggleSidebarBtn.style.display = 'flex';
                    mobileToggleSidebarBtn.style.display = 'none';
                    toggleSidebarBtn.style.display = 'none';

                    // Ensure mobile sidebar classes are removed
                    chatSidebar.classList.remove('active-mobile-sidebar');

                    // Apply desktop sidebar state based on `isSidebarOpenDesktop`
                    applyDesktopSidebarState();
                }
                createIcons();
            });

            // Initial call on load to set desktop/mobile layout correctly
            if (window.innerWidth > 768) {
                desktopToggleSidebarBtn.style.display = 'flex'; // Show desktop toggle
                applyDesktopSidebarState(); // Apply initial desktop state (sidebar open)
            } else {
                mobileToggleSidebarBtn.style.display = 'flex'; // Show mobile toggle
                chatMainContent.classList.add('sidebar-hidden'); // Sidebar starts closed on mobile, apply radius
            }
        });
    </script>
</body>
</html>